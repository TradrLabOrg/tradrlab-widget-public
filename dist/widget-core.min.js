!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.TradrLabWidget=t():e.TradrLabWidget=t()}(this,()=>(()=>{"use strict";var e={56:(e,t,n)=>{e.exports=function(e){var t=n.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function n(e){for(var n=-1,s=0;s<t.length;s++)if(t[s].identifier===e){n=s;break}return n}function s(e,s){for(var r={},a=[],o=0;o<e.length;o++){var c=e[o],l=s.base?c[0]+s.base:c[0],d=r[l]||0,h="".concat(l," ").concat(d);r[l]=d+1;var g=n(h),u={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==g)t[g].references++,t[g].updater(u);else{var p=i(u,s);s.byIndex=o,t.splice(o,0,{identifier:h,updater:p,references:1})}a.push(h)}return a}function i(e,t){var n=t.domAPI(t);n.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;n.update(e=t)}else n.remove()}}e.exports=function(e,i){var r=s(e=e||[],i=i||{});return function(e){e=e||[];for(var a=0;a<r.length;a++){var o=n(r[a]);t[o].references--}for(var c=s(e,i),l=0;l<r.length;l++){var d=n(r[l]);0===t[d].references&&(t[d].updater(),t.splice(d,1))}r=c}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n="",s=void 0!==t[5];return t[4]&&(n+="@supports (".concat(t[4],") {")),t[2]&&(n+="@media ".concat(t[2]," {")),s&&(n+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),n+=e(t),s&&(n+="}"),t[2]&&(n+="}"),t[4]&&(n+="}"),n}).join("")},t.i=function(e,n,s,i,r){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(s)for(var o=0;o<this.length;o++){var c=this[o][0];null!=c&&(a[c]=!0)}for(var l=0;l<e.length;l++){var d=[].concat(e[l]);s&&a[d[0]]||(void 0!==r&&(void 0===d[5]||(d[1]="@layer".concat(d[5].length>0?" ".concat(d[5]):""," {").concat(d[1],"}")),d[5]=r),n&&(d[2]?(d[1]="@media ".concat(d[2]," {").concat(d[1],"}"),d[2]=n):d[2]=n),i&&(d[4]?(d[1]="@supports (".concat(d[4],") {").concat(d[1],"}"),d[4]=i):d[4]="".concat(i)),t.push(d))}},t}},354:e=>{e.exports=function(e){var t=e[1],n=e[3];if(!n)return t;if("function"==typeof btoa){var s=btoa(unescape(encodeURIComponent(JSON.stringify(n)))),i="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s),r="/*# ".concat(i," */");return[t].concat([r]).join("\n")}return[t].join("\n")}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},659:e=>{var t={};e.exports=function(e,n){var s=function(e){if(void 0===t[e]){var n=document.querySelector(e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}(e);if(!s)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");s.appendChild(n)}},738:(e,t,n)=>{n.d(t,{A:()=>o});var s=n(354),i=n.n(s),r=n(314),a=n.n(r)()(i());a.push([e.id,"/**\n * TradrLab Widget Base Styles\n * All styles are scoped with .tradr-widget prefix\n */\n\n/* Widget Container */\n.tradr-widget {\n  --tradr-primary-color: #1976d2;\n  --tradr-background-color: #ffffff;\n  --tradr-text-color: #333333;\n  --tradr-border-color: #e0e0e0;\n  --tradr-message-user-bg: #1976d2;\n  --tradr-message-assistant-bg: #f5f5f5;\n  --tradr-error-color: #f44336;\n  --tradr-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  \n  font-family: var(--tradr-font-family);\n  color: var(--tradr-text-color);\n  background: var(--tradr-background-color);\n  border: 1px solid var(--tradr-border-color);\n  border-radius: 8px;\n  overflow: hidden;\n  display: flex;\n  flex-direction: column;\n  box-sizing: border-box;\n}\n\n.tradr-widget * {\n  box-sizing: border-box;\n}\n\n/* Widget Container Layout */\n.tradr-widget-container {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  width: 100%;\n}\n\n/* Header */\n.tradr-widget-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 12px 16px;\n  border-bottom: 1px solid var(--tradr-border-color);\n  background: var(--tradr-background-color);\n}\n\n.tradr-widget-header h3 {\n  margin: 0;\n  font-size: 16px;\n  font-weight: 600;\n  color: var(--tradr-text-color);\n}\n\n.tradr-widget-controls {\n  display: flex;\n  gap: 8px;\n}\n\n.tradr-font-size-btn {\n  padding: 4px 8px;\n  border: 1px solid var(--tradr-border-color);\n  background: var(--tradr-background-color);\n  color: var(--tradr-text-color);\n  border-radius: 4px;\n  cursor: pointer;\n  font-size: 12px;\n  transition: background-color 0.2s;\n}\n\n.tradr-font-size-btn:hover {\n  background: var(--tradr-border-color);\n}\n\n/* Messages Container */\n.tradr-widget-messages {\n  flex: 1;\n  overflow-y: auto;\n  padding: 16px;\n  background: var(--tradr-background-color);\n}\n\n/* Message Styles */\n.tradr-message {\n  margin-bottom: 16px;\n  display: flex;\n  animation: fadeIn 0.3s ease-in;\n}\n\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n    transform: translateY(10px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n.tradr-message-user {\n  justify-content: flex-end;\n}\n\n.tradr-widget .tradr-message-ai,\n.tradr-widget .tradr-message-assistant,\n.tradr-widget .tradr-message-system {\n  justify-content: flex-start;\n  /* DEBUG: Force visibility */\n  border: 2px solid blue !important;\n  min-height: 30px !important;\n  display: flex !important;\n}\n\n/* Fallback without widget scope */\n.tradr-message-ai,\n.tradr-message-assistant,\n.tradr-message-system {\n  justify-content: flex-start;\n  border: 2px solid blue !important;\n  min-height: 30px !important;\n  display: flex !important;\n}\n\n.tradr-message-bubble {\n  max-width: 70%;\n  padding: 10px 14px;\n  border-radius: 16px;\n  word-wrap: break-word;\n  line-height: 1.4;\n}\n\n.tradr-message-user .tradr-message-bubble {\n  background: var(--tradr-message-user-bg);\n  color: white;\n  border-bottom-right-radius: 4px;\n}\n\n.tradr-widget .tradr-message-ai .tradr-message-bubble,\n.tradr-widget .tradr-message-assistant .tradr-message-bubble,\n.tradr-widget .tradr-message-system .tradr-message-bubble {\n  background: var(--tradr-message-assistant-bg);\n  color: var(--tradr-text-color);\n  border-bottom-left-radius: 4px;\n  /* DEBUG: Force visibility */\n  border: 2px solid red !important;\n  min-height: 20px !important;\n  display: block !important;\n}\n\n/* Fallback without widget scope */\n.tradr-message-ai .tradr-message-bubble,\n.tradr-message-assistant .tradr-message-bubble,\n.tradr-message-system .tradr-message-bubble {\n  background: var(--tradr-message-assistant-bg);\n  color: var(--tradr-text-color);\n  border-bottom-left-radius: 4px;\n  /* DEBUG: Force visibility */\n  border: 2px solid red !important;\n  min-height: 20px !important;\n  display: block !important;\n}\n\n.tradr-message-error .tradr-message-bubble {\n  background: #ffebee;\n  color: var(--tradr-error-color);\n  border: 1px solid var(--tradr-error-color);\n}\n\n/* Loading Animation */\n.tradr-loading-dots {\n  display: flex;\n  gap: 4px;\n}\n\n.tradr-loading-dots span {\n  width: 8px;\n  height: 8px;\n  border-radius: 50%;\n  background: var(--tradr-primary-color);\n  animation: bounce 1.4s infinite ease-in-out;\n}\n\n.tradr-loading-dots span:nth-child(1) {\n  animation-delay: -0.32s;\n}\n\n.tradr-loading-dots span:nth-child(2) {\n  animation-delay: -0.16s;\n}\n\n@keyframes bounce {\n  0%, 80%, 100% {\n    transform: scale(0.8);\n    opacity: 0.5;\n  }\n  40% {\n    transform: scale(1);\n    opacity: 1;\n  }\n}\n\n/* Input Container */\n.tradr-widget-input {\n  display: flex;\n  align-items: flex-end;\n  gap: 8px;\n  padding: 12px 16px;\n  border-top: 1px solid var(--tradr-border-color);\n  background: var(--tradr-background-color);\n}\n\n.tradr-widget-input-field {\n  flex: 1;\n  min-height: 36px;\n  max-height: 120px;\n  padding: 8px 12px;\n  border: 1px solid var(--tradr-border-color);\n  border-radius: 20px;\n  font-family: var(--tradr-font-family);\n  font-size: 14px;\n  resize: none;\n  outline: none;\n  transition: border-color 0.2s;\n}\n\n.tradr-widget-input-field:focus {\n  border-color: var(--tradr-primary-color);\n}\n\n.tradr-send-btn,\n.tradr-attach-btn {\n  width: 36px;\n  height: 36px;\n  padding: 0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border: none;\n  border-radius: 50%;\n  background: var(--tradr-primary-color);\n  color: white;\n  cursor: pointer;\n  transition: background-color 0.2s;\n  position: relative;\n}\n\n.tradr-send-btn:hover,\n.tradr-attach-btn:hover {\n  background: color-mix(in srgb, var(--tradr-primary-color) 85%, black);\n}\n\n.tradr-send-btn:disabled,\n.tradr-attach-btn:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Image in messages */\n.tradr-message-bubble img {\n  max-width: 100%;\n  border-radius: 8px;\n  margin-top: 8px;\n}\n\n/* Scrollbar Styling */\n.tradr-widget-messages::-webkit-scrollbar {\n  width: 6px;\n}\n\n.tradr-widget-messages::-webkit-scrollbar-track {\n  background: transparent;\n}\n\n.tradr-widget-messages::-webkit-scrollbar-thumb {\n  background: var(--tradr-border-color);\n  border-radius: 3px;\n}\n\n.tradr-widget-messages::-webkit-scrollbar-thumb:hover {\n  background: color-mix(in srgb, var(--tradr-border-color) 70%, black);\n}\n\n/* Dark Theme */\n.tradr-widget-dark {\n  --tradr-background-color: #1e1e1e;\n  --tradr-text-color: #ffffff;\n  --tradr-border-color: #333333;\n  --tradr-message-assistant-bg: #2d2d2d;\n}\n\n/* Responsive */\n@media (max-width: 480px) {\n  .tradr-message-bubble {\n    max-width: 85%;\n  }\n}\n\n/* Accessibility */\n.tradr-widget:focus-visible,\n.tradr-widget button:focus-visible,\n.tradr-widget-input-field:focus-visible {\n  outline: 2px solid var(--tradr-primary-color);\n  outline-offset: 2px;\n}\n\n/* Reduced Motion */\n@media (prefers-reduced-motion: reduce) {\n  .tradr-message,\n  .tradr-loading-dots span {\n    animation: none;\n  }\n}","",{version:3,sources:["webpack://./src/styles/widget-base.css"],names:[],mappings:"AAAA;;;EAGE;;AAEF,qBAAqB;AACrB;EACE,8BAA8B;EAC9B,iCAAiC;EACjC,2BAA2B;EAC3B,6BAA6B;EAC7B,gCAAgC;EAChC,qCAAqC;EACrC,4BAA4B;EAC5B,sFAAsF;;EAEtF,qCAAqC;EACrC,8BAA8B;EAC9B,yCAAyC;EACzC,2CAA2C;EAC3C,kBAAkB;EAClB,gBAAgB;EAChB,aAAa;EACb,sBAAsB;EACtB,sBAAsB;AACxB;;AAEA;EACE,sBAAsB;AACxB;;AAEA,4BAA4B;AAC5B;EACE,aAAa;EACb,sBAAsB;EACtB,YAAY;EACZ,WAAW;AACb;;AAEA,WAAW;AACX;EACE,aAAa;EACb,8BAA8B;EAC9B,mBAAmB;EACnB,kBAAkB;EAClB,kDAAkD;EAClD,yCAAyC;AAC3C;;AAEA;EACE,SAAS;EACT,eAAe;EACf,gBAAgB;EAChB,8BAA8B;AAChC;;AAEA;EACE,aAAa;EACb,QAAQ;AACV;;AAEA;EACE,gBAAgB;EAChB,2CAA2C;EAC3C,yCAAyC;EACzC,8BAA8B;EAC9B,kBAAkB;EAClB,eAAe;EACf,eAAe;EACf,iCAAiC;AACnC;;AAEA;EACE,qCAAqC;AACvC;;AAEA,uBAAuB;AACvB;EACE,OAAO;EACP,gBAAgB;EAChB,aAAa;EACb,yCAAyC;AAC3C;;AAEA,mBAAmB;AACnB;EACE,mBAAmB;EACnB,aAAa;EACb,8BAA8B;AAChC;;AAEA;EACE;IACE,UAAU;IACV,2BAA2B;EAC7B;EACA;IACE,UAAU;IACV,wBAAwB;EAC1B;AACF;;AAEA;EACE,yBAAyB;AAC3B;;AAEA;;;EAGE,2BAA2B;EAC3B,4BAA4B;EAC5B,iCAAiC;EACjC,2BAA2B;EAC3B,wBAAwB;AAC1B;;AAEA,kCAAkC;AAClC;;;EAGE,2BAA2B;EAC3B,iCAAiC;EACjC,2BAA2B;EAC3B,wBAAwB;AAC1B;;AAEA;EACE,cAAc;EACd,kBAAkB;EAClB,mBAAmB;EACnB,qBAAqB;EACrB,gBAAgB;AAClB;;AAEA;EACE,wCAAwC;EACxC,YAAY;EACZ,+BAA+B;AACjC;;AAEA;;;EAGE,6CAA6C;EAC7C,8BAA8B;EAC9B,8BAA8B;EAC9B,4BAA4B;EAC5B,gCAAgC;EAChC,2BAA2B;EAC3B,yBAAyB;AAC3B;;AAEA,kCAAkC;AAClC;;;EAGE,6CAA6C;EAC7C,8BAA8B;EAC9B,8BAA8B;EAC9B,4BAA4B;EAC5B,gCAAgC;EAChC,2BAA2B;EAC3B,yBAAyB;AAC3B;;AAEA;EACE,mBAAmB;EACnB,+BAA+B;EAC/B,0CAA0C;AAC5C;;AAEA,sBAAsB;AACtB;EACE,aAAa;EACb,QAAQ;AACV;;AAEA;EACE,UAAU;EACV,WAAW;EACX,kBAAkB;EAClB,sCAAsC;EACtC,2CAA2C;AAC7C;;AAEA;EACE,uBAAuB;AACzB;;AAEA;EACE,uBAAuB;AACzB;;AAEA;EACE;IACE,qBAAqB;IACrB,YAAY;EACd;EACA;IACE,mBAAmB;IACnB,UAAU;EACZ;AACF;;AAEA,oBAAoB;AACpB;EACE,aAAa;EACb,qBAAqB;EACrB,QAAQ;EACR,kBAAkB;EAClB,+CAA+C;EAC/C,yCAAyC;AAC3C;;AAEA;EACE,OAAO;EACP,gBAAgB;EAChB,iBAAiB;EACjB,iBAAiB;EACjB,2CAA2C;EAC3C,mBAAmB;EACnB,qCAAqC;EACrC,eAAe;EACf,YAAY;EACZ,aAAa;EACb,6BAA6B;AAC/B;;AAEA;EACE,wCAAwC;AAC1C;;AAEA;;EAEE,WAAW;EACX,YAAY;EACZ,UAAU;EACV,aAAa;EACb,mBAAmB;EACnB,uBAAuB;EACvB,YAAY;EACZ,kBAAkB;EAClB,sCAAsC;EACtC,YAAY;EACZ,eAAe;EACf,iCAAiC;EACjC,kBAAkB;AACpB;;AAEA;;EAEE,qEAAqE;AACvE;;AAEA;;EAEE,YAAY;EACZ,mBAAmB;AACrB;;AAEA,sBAAsB;AACtB;EACE,eAAe;EACf,kBAAkB;EAClB,eAAe;AACjB;;AAEA,sBAAsB;AACtB;EACE,UAAU;AACZ;;AAEA;EACE,uBAAuB;AACzB;;AAEA;EACE,qCAAqC;EACrC,kBAAkB;AACpB;;AAEA;EACE,oEAAoE;AACtE;;AAEA,eAAe;AACf;EACE,iCAAiC;EACjC,2BAA2B;EAC3B,6BAA6B;EAC7B,qCAAqC;AACvC;;AAEA,eAAe;AACf;EACE;IACE,cAAc;EAChB;AACF;;AAEA,kBAAkB;AAClB;;;EAGE,6CAA6C;EAC7C,mBAAmB;AACrB;;AAEA,mBAAmB;AACnB;EACE;;IAEE,eAAe;EACjB;AACF",sourcesContent:["/**\n * TradrLab Widget Base Styles\n * All styles are scoped with .tradr-widget prefix\n */\n\n/* Widget Container */\n.tradr-widget {\n  --tradr-primary-color: #1976d2;\n  --tradr-background-color: #ffffff;\n  --tradr-text-color: #333333;\n  --tradr-border-color: #e0e0e0;\n  --tradr-message-user-bg: #1976d2;\n  --tradr-message-assistant-bg: #f5f5f5;\n  --tradr-error-color: #f44336;\n  --tradr-font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n  \n  font-family: var(--tradr-font-family);\n  color: var(--tradr-text-color);\n  background: var(--tradr-background-color);\n  border: 1px solid var(--tradr-border-color);\n  border-radius: 8px;\n  overflow: hidden;\n  display: flex;\n  flex-direction: column;\n  box-sizing: border-box;\n}\n\n.tradr-widget * {\n  box-sizing: border-box;\n}\n\n/* Widget Container Layout */\n.tradr-widget-container {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  width: 100%;\n}\n\n/* Header */\n.tradr-widget-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 12px 16px;\n  border-bottom: 1px solid var(--tradr-border-color);\n  background: var(--tradr-background-color);\n}\n\n.tradr-widget-header h3 {\n  margin: 0;\n  font-size: 16px;\n  font-weight: 600;\n  color: var(--tradr-text-color);\n}\n\n.tradr-widget-controls {\n  display: flex;\n  gap: 8px;\n}\n\n.tradr-font-size-btn {\n  padding: 4px 8px;\n  border: 1px solid var(--tradr-border-color);\n  background: var(--tradr-background-color);\n  color: var(--tradr-text-color);\n  border-radius: 4px;\n  cursor: pointer;\n  font-size: 12px;\n  transition: background-color 0.2s;\n}\n\n.tradr-font-size-btn:hover {\n  background: var(--tradr-border-color);\n}\n\n/* Messages Container */\n.tradr-widget-messages {\n  flex: 1;\n  overflow-y: auto;\n  padding: 16px;\n  background: var(--tradr-background-color);\n}\n\n/* Message Styles */\n.tradr-message {\n  margin-bottom: 16px;\n  display: flex;\n  animation: fadeIn 0.3s ease-in;\n}\n\n@keyframes fadeIn {\n  from {\n    opacity: 0;\n    transform: translateY(10px);\n  }\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n.tradr-message-user {\n  justify-content: flex-end;\n}\n\n.tradr-widget .tradr-message-ai,\n.tradr-widget .tradr-message-assistant,\n.tradr-widget .tradr-message-system {\n  justify-content: flex-start;\n  /* DEBUG: Force visibility */\n  border: 2px solid blue !important;\n  min-height: 30px !important;\n  display: flex !important;\n}\n\n/* Fallback without widget scope */\n.tradr-message-ai,\n.tradr-message-assistant,\n.tradr-message-system {\n  justify-content: flex-start;\n  border: 2px solid blue !important;\n  min-height: 30px !important;\n  display: flex !important;\n}\n\n.tradr-message-bubble {\n  max-width: 70%;\n  padding: 10px 14px;\n  border-radius: 16px;\n  word-wrap: break-word;\n  line-height: 1.4;\n}\n\n.tradr-message-user .tradr-message-bubble {\n  background: var(--tradr-message-user-bg);\n  color: white;\n  border-bottom-right-radius: 4px;\n}\n\n.tradr-widget .tradr-message-ai .tradr-message-bubble,\n.tradr-widget .tradr-message-assistant .tradr-message-bubble,\n.tradr-widget .tradr-message-system .tradr-message-bubble {\n  background: var(--tradr-message-assistant-bg);\n  color: var(--tradr-text-color);\n  border-bottom-left-radius: 4px;\n  /* DEBUG: Force visibility */\n  border: 2px solid red !important;\n  min-height: 20px !important;\n  display: block !important;\n}\n\n/* Fallback without widget scope */\n.tradr-message-ai .tradr-message-bubble,\n.tradr-message-assistant .tradr-message-bubble,\n.tradr-message-system .tradr-message-bubble {\n  background: var(--tradr-message-assistant-bg);\n  color: var(--tradr-text-color);\n  border-bottom-left-radius: 4px;\n  /* DEBUG: Force visibility */\n  border: 2px solid red !important;\n  min-height: 20px !important;\n  display: block !important;\n}\n\n.tradr-message-error .tradr-message-bubble {\n  background: #ffebee;\n  color: var(--tradr-error-color);\n  border: 1px solid var(--tradr-error-color);\n}\n\n/* Loading Animation */\n.tradr-loading-dots {\n  display: flex;\n  gap: 4px;\n}\n\n.tradr-loading-dots span {\n  width: 8px;\n  height: 8px;\n  border-radius: 50%;\n  background: var(--tradr-primary-color);\n  animation: bounce 1.4s infinite ease-in-out;\n}\n\n.tradr-loading-dots span:nth-child(1) {\n  animation-delay: -0.32s;\n}\n\n.tradr-loading-dots span:nth-child(2) {\n  animation-delay: -0.16s;\n}\n\n@keyframes bounce {\n  0%, 80%, 100% {\n    transform: scale(0.8);\n    opacity: 0.5;\n  }\n  40% {\n    transform: scale(1);\n    opacity: 1;\n  }\n}\n\n/* Input Container */\n.tradr-widget-input {\n  display: flex;\n  align-items: flex-end;\n  gap: 8px;\n  padding: 12px 16px;\n  border-top: 1px solid var(--tradr-border-color);\n  background: var(--tradr-background-color);\n}\n\n.tradr-widget-input-field {\n  flex: 1;\n  min-height: 36px;\n  max-height: 120px;\n  padding: 8px 12px;\n  border: 1px solid var(--tradr-border-color);\n  border-radius: 20px;\n  font-family: var(--tradr-font-family);\n  font-size: 14px;\n  resize: none;\n  outline: none;\n  transition: border-color 0.2s;\n}\n\n.tradr-widget-input-field:focus {\n  border-color: var(--tradr-primary-color);\n}\n\n.tradr-send-btn,\n.tradr-attach-btn {\n  width: 36px;\n  height: 36px;\n  padding: 0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border: none;\n  border-radius: 50%;\n  background: var(--tradr-primary-color);\n  color: white;\n  cursor: pointer;\n  transition: background-color 0.2s;\n  position: relative;\n}\n\n.tradr-send-btn:hover,\n.tradr-attach-btn:hover {\n  background: color-mix(in srgb, var(--tradr-primary-color) 85%, black);\n}\n\n.tradr-send-btn:disabled,\n.tradr-attach-btn:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Image in messages */\n.tradr-message-bubble img {\n  max-width: 100%;\n  border-radius: 8px;\n  margin-top: 8px;\n}\n\n/* Scrollbar Styling */\n.tradr-widget-messages::-webkit-scrollbar {\n  width: 6px;\n}\n\n.tradr-widget-messages::-webkit-scrollbar-track {\n  background: transparent;\n}\n\n.tradr-widget-messages::-webkit-scrollbar-thumb {\n  background: var(--tradr-border-color);\n  border-radius: 3px;\n}\n\n.tradr-widget-messages::-webkit-scrollbar-thumb:hover {\n  background: color-mix(in srgb, var(--tradr-border-color) 70%, black);\n}\n\n/* Dark Theme */\n.tradr-widget-dark {\n  --tradr-background-color: #1e1e1e;\n  --tradr-text-color: #ffffff;\n  --tradr-border-color: #333333;\n  --tradr-message-assistant-bg: #2d2d2d;\n}\n\n/* Responsive */\n@media (max-width: 480px) {\n  .tradr-message-bubble {\n    max-width: 85%;\n  }\n}\n\n/* Accessibility */\n.tradr-widget:focus-visible,\n.tradr-widget button:focus-visible,\n.tradr-widget-input-field:focus-visible {\n  outline: 2px solid var(--tradr-primary-color);\n  outline-offset: 2px;\n}\n\n/* Reduced Motion */\n@media (prefers-reduced-motion: reduce) {\n  .tradr-message,\n  .tradr-loading-dots span {\n    animation: none;\n  }\n}"],sourceRoot:""}]);const o=a},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(n){!function(e,t,n){var s="";n.supports&&(s+="@supports (".concat(n.supports,") {")),n.media&&(s+="@media ".concat(n.media," {"));var i=void 0!==n.layer;i&&(s+="@layer".concat(n.layer.length>0?" ".concat(n.layer):""," {")),s+=n.css,i&&(s+="}"),n.media&&(s+="}"),n.supports&&(s+="}");var r=n.sourceMap;r&&"undefined"!=typeof btoa&&(s+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),t.styleTagTransform(s,e,t.options)}(t,e,n)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}}},t={};function n(s){var i=t[s];if(void 0!==i)return i.exports;var r=t[s]={id:s,exports:{}};return e[s](r,r.exports,n),r.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nc=void 0;var s={};n.d(s,{default:()=>Ye});class i{constructor(){this.messages=[],this.sessions=new Map,this.scenarios=new Map,this.currentMilestone=0,this.journeyType=null,this.listeners=[],this.eventListeners=new Map,this.activeScenarioId=null,this.activeSessionId=null,this.currentSessionId=null}on(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}off(e,t){if(!this.eventListeners.has(e))return;const n=this.eventListeners.get(e),s=n.indexOf(t);s>-1&&n.splice(s,1)}emit(e,...t){if(!this.eventListeners.has(e))return;this.eventListeners.get(e).forEach(e=>{try{e(...t)}catch(e){}})}startSession(e,t,n={}){const s={id:e,templateName:t,startTime:Date.now(),endTime:null,status:"active",milestones:{template:!0,model:!1,evaluation:!1,analysis:!1},metadata:n};return this.sessions.set(e,s),this.activeSessionId=e,this.journeyType="template",this.notifyListeners("session:start",s),s}endSession(e){const t=this.sessions.get(e);return t?(t.endTime=Date.now(),t.status="completed",this.activeSessionId===e&&(this.activeSessionId=null),this.notifyListeners("session:end",t),t):null}getSession(e){return this.sessions.get(e)||null}getActiveSession(){return this.activeSessionId?this.sessions.get(this.activeSessionId):null}updateMilestone(e){const t="string"==typeof e?{explore:0,template:1,model:2,evaluate:3,analyze:4,backtest:5}[e.toLowerCase()]:e;if(this.currentMilestone=t,this.activeSessionId){const e=this.sessions.get(this.activeSessionId);if(e)switch(t){case 1:e.milestones.template=!0;break;case 2:e.milestones.model=!0;break;case 3:e.milestones.evaluation=!0;break;case 4:e.milestones.analysis=!0}}return this.notifyListeners("milestone:update",{milestone:t,journeyType:this.journeyType}),this.emit("milestone:update",{milestone:t,journeyType:this.journeyType}),t}getMilestoneStatus(){return{current:this.currentMilestone,journeyType:this.journeyType,session:this.getActiveSession()}}analyzeMessageForActions(e){const t={showGenerateButton:!1,showRedrawButton:!1,triggerEvaluation:!1,startSession:!1,endSession:!1,updateMilestone:null,showApplyFix:!1,enableAnalysis:!1};if(!e||!e.messageType)return t;switch(e.messageType){case"Steps":e.message&&e.message.includes("Step 1")&&(t.showGenerateButton=!e.userDagRequestId,t.showRedrawButton=!!e.userDagRequestId,t.updateMilestone="model",this.journeyType||(this.journeyType="interactive"));break;case"Scenario":t.showGenerateButton=!e.userDagRequestId,t.showRedrawButton=!!e.userDagRequestId,t.updateMilestone="model",this.journeyType||(this.journeyType="interactive");break;case"Template":t.startSession=!0,t.updateMilestone="template",this.journeyType="template";break;case"Model":t.triggerEvaluation=!0,t.updateMilestone="evaluate","/chat"===e.originalEndpoint&&"template"===this.journeyType&&(t.endSession=!0);break;case"Analysis":t.enableAnalysis=!0,t.updateMilestone="analyze";break;case"Explanation":(e.fixedDag||e.fixedScenario)&&(t.showApplyFix=!0);break;default:this.journeyType||(this.journeyType="interactive")}return t}getLastRelevantMessage(){return this.messages.findLast(e=>"Steps"===e.messageType||"Scenario"===e.messageType||"Template"===e.messageType)}getCurrentAvailableActions(){const e=this.getLastRelevantMessage();if(!e)return{showGenerateButton:!1,showRedrawButton:!1,showBacktestButton:!1,enableAnalysis:!1};const t=this.analyzeMessageForActions(e);return t.showBacktestButton=this.currentMilestone>=3,t}isReadyForGeneration(){return this.getCurrentAvailableActions().showGenerateButton}storeDagMetadata(e){const{scenarioId:t,dagRequestId:n}=e;if(t){const n=this.scenarios.get(t)||{};n.dagMetadata=e,n.status="model_generated",this.scenarios.set(t,n)}const s={id:crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}),type:"system",messageType:"DAGGenerated",content:this.formatDagSummary(e),timestamp:Date.now(),scenarioId:t,dagRequestId:n,metadata:e};return this.addMessage(s),this.notifyListeners("dag:generated",e),this.emit("dag:generated",e),e}formatDagSummary(e){const{nodeCount:t,indicators:n=[],conditions:s=[],triggers:i=[]}=e;let r="✅ **Model Created Successfully!**\n\n";return r+=`📊 **${t} components** generated\n\n`,n.length>0&&(r+=`**Indicators:**\n${n.map(e=>`• ${e}`).join("\n")}\n\n`),s.length>0&&(r+=`**Conditions:**\n${s.map(e=>`• ${e}`).join("\n")}\n\n`),i.length>0&&(r+=`**Triggers:**\n${i.map(e=>`• ${e}`).join("\n")}\n\n`),r+="⏳ **Starting evaluation...**",r}addScenario(e,t){const n={id:e,...t};return this.scenarios.set(e,n),this.activeScenarioId=e,this.notifyListeners("scenario:update",n),n}updateScenarioStatus(e,t){const n=this.scenarios.get(e);return n?(n.status=t,n.updatedAt=Date.now(),this.notifyListeners("scenario:status",{scenarioId:e,status:t}),n):null}getScenario(e){return this.scenarios.get(e)||null}addMessage(e){if(!e.id)throw new Error("EnhancedMessageStore: Message ID is required");const t={id:e.id,timestamp:e.timestamp||(new Date).toISOString(),scenarioId:e.scenarioId,sessionId:e.sessionId,journeyType:this.journeyType,milestone:this.currentMilestone,...e};return e.isAiResponse&&e.sessionId&&this.updateSessionId(e.sessionId),this.messages.push(t),this.detectMilestoneTransition(t),this.notifyListeners("message:add",t),this.emit("message:added",t),t}detectMilestoneTransition(e){switch(e.messageType){case"Template":this.updateMilestone("template"),e.sessionId&&!this.sessions.has(e.sessionId)&&this.startSession(e.sessionId,e.templateName||"Unknown Template");break;case"Model":case"Scenario":this.updateMilestone("model"),"/chat"===e.originalEndpoint&&this.activeSessionId&&setTimeout(()=>this.endSession(this.activeSessionId),100);break;case"Evaluation":case"EvaluationComplete":this.updateMilestone("evaluate");break;case"Analysis":this.updateMilestone("analyze")}}updateMessage(e,t){const n=this.messages.findIndex(t=>t.id===e);return-1!==n?(this.messages[n]={...this.messages[n],...t,updatedAt:(new Date).toISOString()},this.notifyListeners("message:update",this.messages[n]),this.messages[n]):null}getConversationSummary(){return this.messages.filter(e=>"user"===e.type||"ai"===e.type&&"Text"===e.messageType).slice(-10).map(e=>`${"user"===e.type?"User":"AI"}: ${e.content||e.message}`).join("\n")}setJourneyType(e){this.journeyType=e,this.notifyListeners("journey:change",e)}resetJourney(){this.currentMilestone=0,this.journeyType=null,this.activeSessionId=null,this.notifyListeners("journey:reset",null)}removeMessage(e){const t=this.messages.findIndex(t=>t.id===e);if(-1!==t){const e=this.messages.splice(t,1)[0];return this.notifyListeners("message:remove",e),e}return null}getMessages(){return[...this.messages]}getMessage(e){return this.messages.find(t=>t.id===e)||null}clear(){this.messages=[],this.sessions.clear(),this.scenarios.clear(),this.resetJourney(),this.notifyListeners("store:clear",null)}subscribe(e){if("function"!=typeof e)throw new Error("MessageStore: Listener must be a function");return this.listeners.push(e),()=>{const t=this.listeners.indexOf(e);-1!==t&&this.listeners.splice(t,1)}}notifyListeners(e,t){this.listeners.forEach(n=>{try{n({action:e,data:t,messages:this.getMessages(),milestone:this.currentMilestone,journeyType:this.journeyType,activeSession:this.getActiveSession()})}catch(e){}})}getMessagesByType(e){return this.messages.filter(t=>t.type===e||t.messageType===e)}getLastMessage(){return this.messages[this.messages.length-1]||null}getScenarioMessages(e=null){const t=e||this.activeScenarioId;return t?this.messages.filter(e=>e.scenarioId===t):[]}getSessionMessages(e=null){const t=e||this.activeSessionId;return t?this.messages.filter(e=>e.sessionId===t):[]}updateSessionId(e){e&&e!==this.currentSessionId&&(this.currentSessionId=e,this.emit("session:updated",{sessionId:e}))}getCurrentSessionId(){return this.currentSessionId}}const r=[0,2e3,1e4,3e4,null];class a{constructor(e){this._retryDelays=void 0!==e?[...e,null]:r}nextRetryDelayInMilliseconds(e){return this._retryDelays[e.previousRetryCount]}}class o{}o.Authorization="Authorization",o.Cookie="Cookie";class c{constructor(e,t,n){this.statusCode=e,this.statusText=t,this.content=n}}class l{get(e,t){return this.send({...t,method:"GET",url:e})}post(e,t){return this.send({...t,method:"POST",url:e})}delete(e,t){return this.send({...t,method:"DELETE",url:e})}getCookieString(e){return""}}class d extends l{constructor(e,t){super(),this._innerClient=e,this._accessTokenFactory=t}async send(e){let t=!0;this._accessTokenFactory&&(!this._accessToken||e.url&&e.url.indexOf("/negotiate?")>0)&&(t=!1,this._accessToken=await this._accessTokenFactory()),this._setAuthorizationHeader(e);const n=await this._innerClient.send(e);return t&&401===n.statusCode&&this._accessTokenFactory?(this._accessToken=await this._accessTokenFactory(),this._setAuthorizationHeader(e),await this._innerClient.send(e)):n}_setAuthorizationHeader(e){e.headers||(e.headers={}),this._accessToken?e.headers[o.Authorization]=`Bearer ${this._accessToken}`:this._accessTokenFactory&&e.headers[o.Authorization]&&delete e.headers[o.Authorization]}getCookieString(e){return this._innerClient.getCookieString(e)}}class h extends Error{constructor(e,t){const n=new.target.prototype;super(`${e}: Status code '${t}'`),this.statusCode=t,this.__proto__=n}}class g extends Error{constructor(e="A timeout occurred."){const t=new.target.prototype;super(e),this.__proto__=t}}class u extends Error{constructor(e="An abort occurred."){const t=new.target.prototype;super(e),this.__proto__=t}}class p extends Error{constructor(e,t){const n=new.target.prototype;super(e),this.transport=t,this.errorType="UnsupportedTransportError",this.__proto__=n}}class m extends Error{constructor(e,t){const n=new.target.prototype;super(e),this.transport=t,this.errorType="DisabledTransportError",this.__proto__=n}}class f extends Error{constructor(e,t){const n=new.target.prototype;super(e),this.transport=t,this.errorType="FailedToStartTransportError",this.__proto__=n}}class w extends Error{constructor(e){const t=new.target.prototype;super(e),this.errorType="FailedToNegotiateWithServerError",this.__proto__=t}}class y extends Error{constructor(e,t){const n=new.target.prototype;super(e),this.innerErrors=t,this.__proto__=n}}var b;!function(e){e[e.Trace=0]="Trace",e[e.Debug=1]="Debug",e[e.Information=2]="Information",e[e.Warning=3]="Warning",e[e.Error=4]="Error",e[e.Critical=5]="Critical",e[e.None=6]="None"}(b||(b={}));class v{constructor(){}log(e,t){}}v.instance=new v;class A{static isRequired(e,t){if(null==e)throw new Error(`The '${t}' argument is required.`)}static isNotEmpty(e,t){if(!e||e.match(/^\s*$/))throw new Error(`The '${t}' argument should not be empty.`)}static isIn(e,t,n){if(!(e in t))throw new Error(`Unknown ${n} value: ${e}.`)}}class C{static get isBrowser(){return!C.isNode&&"object"==typeof window&&"object"==typeof window.document}static get isWebWorker(){return!C.isNode&&"object"==typeof self&&"importScripts"in self}static get isReactNative(){return!C.isNode&&"object"==typeof window&&void 0===window.document}static get isNode(){return"undefined"!=typeof process&&process.release&&"node"===process.release.name}}function S(e,t){let n="";return _(e)?(n=`Binary data of length ${e.byteLength}`,t&&(n+=`. Content: '${function(e){const t=new Uint8Array(e);let n="";return t.forEach(e=>{n+=`0x${e<16?"0":""}${e.toString(16)} `}),n.substr(0,n.length-1)}(e)}'`)):"string"==typeof e&&(n=`String data of length ${e.length}`,t&&(n+=`. Content: '${e}'`)),n}function _(e){return e&&"undefined"!=typeof ArrayBuffer&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name)}async function k(e,t,n,s,i,r){const a={},[o,c]=T();a[o]=c,e.log(b.Trace,`(${t} transport) sending data. ${S(i,r.logMessageContent)}.`);const l=_(i)?"arraybuffer":"text",d=await n.post(s,{content:i,headers:{...a,...r.headers},responseType:l,timeout:r.timeout,withCredentials:r.withCredentials});e.log(b.Trace,`(${t} transport) request complete. Response status: ${d.statusCode}.`)}class E{constructor(e,t){this._subject=e,this._observer=t}dispose(){const e=this._subject.observers.indexOf(this._observer);e>-1&&this._subject.observers.splice(e,1),0===this._subject.observers.length&&this._subject.cancelCallback&&this._subject.cancelCallback().catch(e=>{})}}class I{constructor(e){this._minLevel=e,this.out=console}log(e,t){if(e>=this._minLevel){const n=`[${(new Date).toISOString()}] ${b[e]}: ${t}`;switch(e){case b.Critical:case b.Error:this.out.error(n);break;case b.Warning:this.out.warn(n);break;case b.Information:this.out.info(n);break;default:this.out.log(n)}}}}function T(){let e="X-SignalR-User-Agent";return C.isNode&&(e="User-Agent"),[e,x("9.0.6",M(),R(),$())]}function x(e,t,n,s){let i="Microsoft SignalR/";const r=e.split(".");return i+=`${r[0]}.${r[1]}`,i+=` (${e}; `,i+=t&&""!==t?`${t}; `:"Unknown OS; ",i+=`${n}`,i+=s?`; ${s}`:"; Unknown Runtime Version",i+=")",i}function M(){if(!C.isNode)return"";switch(process.platform){case"win32":return"Windows NT";case"darwin":return"macOS";case"linux":return"Linux";default:return process.platform}}function $(){if(C.isNode)return process.versions.node}function R(){return C.isNode?"NodeJS":"Browser"}function B(e){return e.stack?e.stack:e.message?e.message:`${e}`}class D extends l{constructor(e){if(super(),this._logger=e,"undefined"==typeof fetch||C.isNode){const e=require;this._jar=new(e("tough-cookie").CookieJar),"undefined"==typeof fetch?this._fetchType=e("node-fetch"):this._fetchType=fetch,this._fetchType=e("fetch-cookie")(this._fetchType,this._jar)}else this._fetchType=fetch.bind(function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==n.g)return n.g;throw new Error("could not find global")}());if("undefined"==typeof AbortController){const e=require;this._abortControllerType=e("abort-controller")}else this._abortControllerType=AbortController}async send(e){if(e.abortSignal&&e.abortSignal.aborted)throw new u;if(!e.method)throw new Error("No method defined.");if(!e.url)throw new Error("No url defined.");const t=new this._abortControllerType;let n;e.abortSignal&&(e.abortSignal.onabort=()=>{t.abort(),n=new u});let s,i=null;if(e.timeout){const s=e.timeout;i=setTimeout(()=>{t.abort(),this._logger.log(b.Warning,"Timeout from HTTP request."),n=new g},s)}""===e.content&&(e.content=void 0),e.content&&(e.headers=e.headers||{},_(e.content)?e.headers["Content-Type"]="application/octet-stream":e.headers["Content-Type"]="text/plain;charset=UTF-8");try{s=await this._fetchType(e.url,{body:e.content,cache:"no-cache",credentials:!0===e.withCredentials?"include":"same-origin",headers:{"X-Requested-With":"XMLHttpRequest",...e.headers},method:e.method,mode:"cors",redirect:"follow",signal:t.signal})}catch(e){if(n)throw n;throw this._logger.log(b.Warning,`Error from HTTP request. ${e}.`),e}finally{i&&clearTimeout(i),e.abortSignal&&(e.abortSignal.onabort=null)}if(!s.ok){const e=await q(s,"text");throw new h(e||s.statusText,s.status)}const r=q(s,e.responseType),a=await r;return new c(s.status,s.statusText,a)}getCookieString(e){let t="";return C.isNode&&this._jar&&this._jar.getCookies(e,(e,n)=>t=n.join("; ")),t}}function q(e,t){let n;switch(t){case"arraybuffer":n=e.arrayBuffer();break;case"text":default:n=e.text();break;case"blob":case"document":case"json":throw new Error(`${t} is not supported.`)}return n}class P extends l{constructor(e){super(),this._logger=e}send(e){return e.abortSignal&&e.abortSignal.aborted?Promise.reject(new u):e.method?e.url?new Promise((t,n)=>{const s=new XMLHttpRequest;s.open(e.method,e.url,!0),s.withCredentials=void 0===e.withCredentials||e.withCredentials,s.setRequestHeader("X-Requested-With","XMLHttpRequest"),""===e.content&&(e.content=void 0),e.content&&(_(e.content)?s.setRequestHeader("Content-Type","application/octet-stream"):s.setRequestHeader("Content-Type","text/plain;charset=UTF-8"));const i=e.headers;i&&Object.keys(i).forEach(e=>{s.setRequestHeader(e,i[e])}),e.responseType&&(s.responseType=e.responseType),e.abortSignal&&(e.abortSignal.onabort=()=>{s.abort(),n(new u)}),e.timeout&&(s.timeout=e.timeout),s.onload=()=>{e.abortSignal&&(e.abortSignal.onabort=null),s.status>=200&&s.status<300?t(new c(s.status,s.statusText,s.response||s.responseText)):n(new h(s.response||s.responseText||s.statusText,s.status))},s.onerror=()=>{this._logger.log(b.Warning,`Error from HTTP request. ${s.status}: ${s.statusText}.`),n(new h(s.statusText,s.status))},s.ontimeout=()=>{this._logger.log(b.Warning,"Timeout from HTTP request."),n(new g)},s.send(e.content)}):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))}}class L extends l{constructor(e){if(super(),"undefined"!=typeof fetch||C.isNode)this._httpClient=new D(e);else{if("undefined"==typeof XMLHttpRequest)throw new Error("No usable HttpClient found.");this._httpClient=new P(e)}}send(e){return e.abortSignal&&e.abortSignal.aborted?Promise.reject(new u):e.method?e.url?this._httpClient.send(e):Promise.reject(new Error("No url defined.")):Promise.reject(new Error("No method defined."))}getCookieString(e){return this._httpClient.getCookieString(e)}}var U,N;!function(e){e[e.None=0]="None",e[e.WebSockets=1]="WebSockets",e[e.ServerSentEvents=2]="ServerSentEvents",e[e.LongPolling=4]="LongPolling"}(U||(U={})),function(e){e[e.Text=1]="Text",e[e.Binary=2]="Binary"}(N||(N={}));class j{constructor(){this._isAborted=!1,this.onabort=null}abort(){this._isAborted||(this._isAborted=!0,this.onabort&&this.onabort())}get signal(){return this}get aborted(){return this._isAborted}}class F{get pollAborted(){return this._pollAbort.aborted}constructor(e,t,n){this._httpClient=e,this._logger=t,this._pollAbort=new j,this._options=n,this._running=!1,this.onreceive=null,this.onclose=null}async connect(e,t){if(A.isRequired(e,"url"),A.isRequired(t,"transferFormat"),A.isIn(t,N,"transferFormat"),this._url=e,this._logger.log(b.Trace,"(LongPolling transport) Connecting."),t===N.Binary&&"undefined"!=typeof XMLHttpRequest&&"string"!=typeof(new XMLHttpRequest).responseType)throw new Error("Binary protocols over XmlHttpRequest not implementing advanced features are not supported.");const[n,s]=T(),i={[n]:s,...this._options.headers},r={abortSignal:this._pollAbort.signal,headers:i,timeout:1e5,withCredentials:this._options.withCredentials};t===N.Binary&&(r.responseType="arraybuffer");const a=`${e}&_=${Date.now()}`;this._logger.log(b.Trace,`(LongPolling transport) polling: ${a}.`);const o=await this._httpClient.get(a,r);200!==o.statusCode?(this._logger.log(b.Error,`(LongPolling transport) Unexpected response code: ${o.statusCode}.`),this._closeError=new h(o.statusText||"",o.statusCode),this._running=!1):this._running=!0,this._receiving=this._poll(this._url,r)}async _poll(e,t){try{for(;this._running;)try{const n=`${e}&_=${Date.now()}`;this._logger.log(b.Trace,`(LongPolling transport) polling: ${n}.`);const s=await this._httpClient.get(n,t);204===s.statusCode?(this._logger.log(b.Information,"(LongPolling transport) Poll terminated by server."),this._running=!1):200!==s.statusCode?(this._logger.log(b.Error,`(LongPolling transport) Unexpected response code: ${s.statusCode}.`),this._closeError=new h(s.statusText||"",s.statusCode),this._running=!1):s.content?(this._logger.log(b.Trace,`(LongPolling transport) data received. ${S(s.content,this._options.logMessageContent)}.`),this.onreceive&&this.onreceive(s.content)):this._logger.log(b.Trace,"(LongPolling transport) Poll timed out, reissuing.")}catch(e){this._running?e instanceof g?this._logger.log(b.Trace,"(LongPolling transport) Poll timed out, reissuing."):(this._closeError=e,this._running=!1):this._logger.log(b.Trace,`(LongPolling transport) Poll errored after shutdown: ${e.message}`)}}finally{this._logger.log(b.Trace,"(LongPolling transport) Polling complete."),this.pollAborted||this._raiseOnClose()}}async send(e){return this._running?k(this._logger,"LongPolling",this._httpClient,this._url,e,this._options):Promise.reject(new Error("Cannot send until the transport is connected"))}async stop(){this._logger.log(b.Trace,"(LongPolling transport) Stopping polling."),this._running=!1,this._pollAbort.abort();try{await this._receiving,this._logger.log(b.Trace,`(LongPolling transport) sending DELETE request to ${this._url}.`);const e={},[t,n]=T();e[t]=n;const s={headers:{...e,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials};let i;try{await this._httpClient.delete(this._url,s)}catch(e){i=e}i?i instanceof h&&(404===i.statusCode?this._logger.log(b.Trace,"(LongPolling transport) A 404 response was returned from sending a DELETE request."):this._logger.log(b.Trace,`(LongPolling transport) Error sending a DELETE request: ${i}`)):this._logger.log(b.Trace,"(LongPolling transport) DELETE request accepted.")}finally{this._logger.log(b.Trace,"(LongPolling transport) Stop finished."),this._raiseOnClose()}}_raiseOnClose(){if(this.onclose){let e="(LongPolling transport) Firing onclose event.";this._closeError&&(e+=" Error: "+this._closeError),this._logger.log(b.Trace,e),this.onclose(this._closeError)}}}class W{constructor(e,t,n,s){this._httpClient=e,this._accessToken=t,this._logger=n,this._options=s,this.onreceive=null,this.onclose=null}async connect(e,t){return A.isRequired(e,"url"),A.isRequired(t,"transferFormat"),A.isIn(t,N,"transferFormat"),this._logger.log(b.Trace,"(SSE transport) Connecting."),this._url=e,this._accessToken&&(e+=(e.indexOf("?")<0?"?":"&")+`access_token=${encodeURIComponent(this._accessToken)}`),new Promise((n,s)=>{let i,r=!1;if(t===N.Text){if(C.isBrowser||C.isWebWorker)i=new this._options.EventSource(e,{withCredentials:this._options.withCredentials});else{const t=this._httpClient.getCookieString(e),n={};n.Cookie=t;const[s,r]=T();n[s]=r,i=new this._options.EventSource(e,{withCredentials:this._options.withCredentials,headers:{...n,...this._options.headers}})}try{i.onmessage=e=>{if(this.onreceive)try{this._logger.log(b.Trace,`(SSE transport) data received. ${S(e.data,this._options.logMessageContent)}.`),this.onreceive(e.data)}catch(e){return void this._close(e)}},i.onerror=e=>{r?this._close():s(new Error("EventSource failed to connect. The connection could not be found on the server, either the connection ID is not present on the server, or a proxy is refusing/buffering the connection. If you have multiple servers check that sticky sessions are enabled."))},i.onopen=()=>{this._logger.log(b.Information,`SSE connected to ${this._url}`),this._eventSource=i,r=!0,n()}}catch(e){return void s(e)}}else s(new Error("The Server-Sent Events transport only supports the 'Text' transfer format"))})}async send(e){return this._eventSource?k(this._logger,"SSE",this._httpClient,this._url,e,this._options):Promise.reject(new Error("Cannot send until the transport is connected"))}stop(){return this._close(),Promise.resolve()}_close(e){this._eventSource&&(this._eventSource.close(),this._eventSource=void 0,this.onclose&&this.onclose(e))}}class H{constructor(e,t,n,s,i,r){this._logger=n,this._accessTokenFactory=t,this._logMessageContent=s,this._webSocketConstructor=i,this._httpClient=e,this.onreceive=null,this.onclose=null,this._headers=r}async connect(e,t){let n;return A.isRequired(e,"url"),A.isRequired(t,"transferFormat"),A.isIn(t,N,"transferFormat"),this._logger.log(b.Trace,"(WebSockets transport) Connecting."),this._accessTokenFactory&&(n=await this._accessTokenFactory()),new Promise((s,i)=>{let r;e=e.replace(/^http/,"ws");const a=this._httpClient.getCookieString(e);let c=!1;if(C.isNode||C.isReactNative){const t={},[s,i]=T();t[s]=i,n&&(t[o.Authorization]=`Bearer ${n}`),a&&(t[o.Cookie]=a),r=new this._webSocketConstructor(e,void 0,{headers:{...t,...this._headers}})}else n&&(e+=(e.indexOf("?")<0?"?":"&")+`access_token=${encodeURIComponent(n)}`);r||(r=new this._webSocketConstructor(e)),t===N.Binary&&(r.binaryType="arraybuffer"),r.onopen=t=>{this._logger.log(b.Information,`WebSocket connected to ${e}.`),this._webSocket=r,c=!0,s()},r.onerror=e=>{let t=null;t="undefined"!=typeof ErrorEvent&&e instanceof ErrorEvent?e.error:"There was an error with the transport",this._logger.log(b.Information,`(WebSockets transport) ${t}.`)},r.onmessage=e=>{if(this._logger.log(b.Trace,`(WebSockets transport) data received. ${S(e.data,this._logMessageContent)}.`),this.onreceive)try{this.onreceive(e.data)}catch(e){return void this._close(e)}},r.onclose=e=>{if(c)this._close(e);else{let t=null;t="undefined"!=typeof ErrorEvent&&e instanceof ErrorEvent?e.error:"WebSocket failed to connect. The connection could not be found on the server, either the endpoint may not be a SignalR endpoint, the connection ID is not present on the server, or there is a proxy blocking WebSockets. If you have multiple servers check that sticky sessions are enabled.",i(new Error(t))}}})}send(e){return this._webSocket&&this._webSocket.readyState===this._webSocketConstructor.OPEN?(this._logger.log(b.Trace,`(WebSockets transport) sending data. ${S(e,this._logMessageContent)}.`),this._webSocket.send(e),Promise.resolve()):Promise.reject("WebSocket is not in the OPEN state")}stop(){return this._webSocket&&this._close(void 0),Promise.resolve()}_close(e){this._webSocket&&(this._webSocket.onclose=()=>{},this._webSocket.onmessage=()=>{},this._webSocket.onerror=()=>{},this._webSocket.close(),this._webSocket=void 0),this._logger.log(b.Trace,"(WebSockets transport) socket closed."),this.onclose&&(!this._isCloseEvent(e)||!1!==e.wasClean&&1e3===e.code?e instanceof Error?this.onclose(e):this.onclose():this.onclose(new Error(`WebSocket closed with status code: ${e.code} (${e.reason||"no reason given"}).`)))}_isCloseEvent(e){return e&&"boolean"==typeof e.wasClean&&"number"==typeof e.code}}class z{constructor(e,t={}){var n;if(this._stopPromiseResolver=()=>{},this.features={},this._negotiateVersion=1,A.isRequired(e,"url"),this._logger=void 0===(n=t.logger)?new I(b.Information):null===n?v.instance:void 0!==n.log?n:new I(n),this.baseUrl=this._resolveUrl(e),(t=t||{}).logMessageContent=void 0!==t.logMessageContent&&t.logMessageContent,"boolean"!=typeof t.withCredentials&&void 0!==t.withCredentials)throw new Error("withCredentials option was not a 'boolean' or 'undefined' value");t.withCredentials=void 0===t.withCredentials||t.withCredentials,t.timeout=void 0===t.timeout?1e5:t.timeout;let s=null,i=null;if(C.isNode){const e=require;s=e("ws"),i=e("eventsource")}C.isNode||"undefined"==typeof WebSocket||t.WebSocket?C.isNode&&!t.WebSocket&&s&&(t.WebSocket=s):t.WebSocket=WebSocket,C.isNode||"undefined"==typeof EventSource||t.EventSource?C.isNode&&!t.EventSource&&void 0!==i&&(t.EventSource=i):t.EventSource=EventSource,this._httpClient=new d(t.httpClient||new L(this._logger),t.accessTokenFactory),this._connectionState="Disconnected",this._connectionStarted=!1,this._options=t,this.onreceive=null,this.onclose=null}async start(e){if(e=e||N.Binary,A.isIn(e,N,"transferFormat"),this._logger.log(b.Debug,`Starting connection with transfer format '${N[e]}'.`),"Disconnected"!==this._connectionState)return Promise.reject(new Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."));if(this._connectionState="Connecting",this._startInternalPromise=this._startInternal(e),await this._startInternalPromise,"Disconnecting"===this._connectionState){const e="Failed to start the HttpConnection before stop() was called.";return this._logger.log(b.Error,e),await this._stopPromise,Promise.reject(new u(e))}if("Connected"!==this._connectionState){const e="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!";return this._logger.log(b.Error,e),Promise.reject(new u(e))}this._connectionStarted=!0}send(e){return"Connected"!==this._connectionState?Promise.reject(new Error("Cannot send data if the connection is not in the 'Connected' State.")):(this._sendQueue||(this._sendQueue=new O(this.transport)),this._sendQueue.send(e))}async stop(e){return"Disconnected"===this._connectionState?(this._logger.log(b.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnected state.`),Promise.resolve()):"Disconnecting"===this._connectionState?(this._logger.log(b.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnecting state.`),this._stopPromise):(this._connectionState="Disconnecting",this._stopPromise=new Promise(e=>{this._stopPromiseResolver=e}),await this._stopInternal(e),void await this._stopPromise)}async _stopInternal(e){this._stopError=e;try{await this._startInternalPromise}catch(e){}if(this.transport){try{await this.transport.stop()}catch(e){this._logger.log(b.Error,`HttpConnection.transport.stop() threw error '${e}'.`),this._stopConnection()}this.transport=void 0}else this._logger.log(b.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed.")}async _startInternal(e){let t=this.baseUrl;this._accessTokenFactory=this._options.accessTokenFactory,this._httpClient._accessTokenFactory=this._accessTokenFactory;try{if(this._options.skipNegotiation){if(this._options.transport!==U.WebSockets)throw new Error("Negotiation can only be skipped when using the WebSocket transport directly.");this.transport=this._constructTransport(U.WebSockets),await this._startTransport(t,e)}else{let n=null,s=0;do{if(n=await this._getNegotiationResponse(t),"Disconnecting"===this._connectionState||"Disconnected"===this._connectionState)throw new u("The connection was stopped during negotiation.");if(n.error)throw new Error(n.error);if(n.ProtocolVersion)throw new Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");if(n.url&&(t=n.url),n.accessToken){const e=n.accessToken;this._accessTokenFactory=()=>e,this._httpClient._accessToken=e,this._httpClient._accessTokenFactory=void 0}s++}while(n.url&&s<100);if(100===s&&n.url)throw new Error("Negotiate redirection limit exceeded.");await this._createTransport(t,this._options.transport,n,e)}this.transport instanceof F&&(this.features.inherentKeepAlive=!0),"Connecting"===this._connectionState&&(this._logger.log(b.Debug,"The HttpConnection connected successfully."),this._connectionState="Connected")}catch(e){return this._logger.log(b.Error,"Failed to start the connection: "+e),this._connectionState="Disconnected",this.transport=void 0,this._stopPromiseResolver(),Promise.reject(e)}}async _getNegotiationResponse(e){const t={},[n,s]=T();t[n]=s;const i=this._resolveNegotiateUrl(e);this._logger.log(b.Debug,`Sending negotiation request: ${i}.`);try{const e=await this._httpClient.post(i,{content:"",headers:{...t,...this._options.headers},timeout:this._options.timeout,withCredentials:this._options.withCredentials});if(200!==e.statusCode)return Promise.reject(new Error(`Unexpected status code returned from negotiate '${e.statusCode}'`));const n=JSON.parse(e.content);return(!n.negotiateVersion||n.negotiateVersion<1)&&(n.connectionToken=n.connectionId),n.useStatefulReconnect&&!0!==this._options._useStatefulReconnect?Promise.reject(new w("Client didn't negotiate Stateful Reconnect but the server did.")):n}catch(e){let t="Failed to complete negotiation with the server: "+e;return e instanceof h&&404===e.statusCode&&(t+=" Either this is not a SignalR endpoint or there is a proxy blocking the connection."),this._logger.log(b.Error,t),Promise.reject(new w(t))}}_createConnectUrl(e,t){return t?e+(-1===e.indexOf("?")?"?":"&")+`id=${t}`:e}async _createTransport(e,t,n,s){let i=this._createConnectUrl(e,n.connectionToken);if(this._isITransport(t))return this._logger.log(b.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=t,await this._startTransport(i,s),void(this.connectionId=n.connectionId);const r=[],a=n.availableTransports||[];let o=n;for(const n of a){const a=this._resolveTransportOrError(n,t,s,!0===(null==o?void 0:o.useStatefulReconnect));if(a instanceof Error)r.push(`${n.transport} failed:`),r.push(a);else if(this._isITransport(a)){if(this.transport=a,!o){try{o=await this._getNegotiationResponse(e)}catch(e){return Promise.reject(e)}i=this._createConnectUrl(e,o.connectionToken)}try{return await this._startTransport(i,s),void(this.connectionId=o.connectionId)}catch(e){if(this._logger.log(b.Error,`Failed to start the transport '${n.transport}': ${e}`),o=void 0,r.push(new f(`${n.transport} failed: ${e}`,U[n.transport])),"Connecting"!==this._connectionState){const e="Failed to select transport before stop() was called.";return this._logger.log(b.Debug,e),Promise.reject(new u(e))}}}}return r.length>0?Promise.reject(new y(`Unable to connect to the server with any of the available transports. ${r.join(" ")}`,r)):Promise.reject(new Error("None of the transports supported by the client are supported by the server."))}_constructTransport(e){switch(e){case U.WebSockets:if(!this._options.WebSocket)throw new Error("'WebSocket' is not supported in your environment.");return new H(this._httpClient,this._accessTokenFactory,this._logger,this._options.logMessageContent,this._options.WebSocket,this._options.headers||{});case U.ServerSentEvents:if(!this._options.EventSource)throw new Error("'EventSource' is not supported in your environment.");return new W(this._httpClient,this._httpClient._accessToken,this._logger,this._options);case U.LongPolling:return new F(this._httpClient,this._logger,this._options);default:throw new Error(`Unknown transport: ${e}.`)}}_startTransport(e,t){return this.transport.onreceive=this.onreceive,this.features.reconnect?this.transport.onclose=async n=>{let s=!1;if(this.features.reconnect){try{this.features.disconnected(),await this.transport.connect(e,t),await this.features.resend()}catch{s=!0}s&&this._stopConnection(n)}else this._stopConnection(n)}:this.transport.onclose=e=>this._stopConnection(e),this.transport.connect(e,t)}_resolveTransportOrError(e,t,n,s){const i=U[e.transport];if(null==i)return this._logger.log(b.Debug,`Skipping transport '${e.transport}' because it is not supported by this client.`),new Error(`Skipping transport '${e.transport}' because it is not supported by this client.`);if(!function(e,t){return!e||0!==(t&e)}(t,i))return this._logger.log(b.Debug,`Skipping transport '${U[i]}' because it was disabled by the client.`),new m(`'${U[i]}' is disabled by the client.`,i);if(!(e.transferFormats.map(e=>N[e]).indexOf(n)>=0))return this._logger.log(b.Debug,`Skipping transport '${U[i]}' because it does not support the requested transfer format '${N[n]}'.`),new Error(`'${U[i]}' does not support ${N[n]}.`);if(i===U.WebSockets&&!this._options.WebSocket||i===U.ServerSentEvents&&!this._options.EventSource)return this._logger.log(b.Debug,`Skipping transport '${U[i]}' because it is not supported in your environment.'`),new p(`'${U[i]}' is not supported in your environment.`,i);this._logger.log(b.Debug,`Selecting transport '${U[i]}'.`);try{return this.features.reconnect=i===U.WebSockets?s:void 0,this._constructTransport(i)}catch(e){return e}}_isITransport(e){return e&&"object"==typeof e&&"connect"in e}_stopConnection(e){if(this._logger.log(b.Debug,`HttpConnection.stopConnection(${e}) called while in state ${this._connectionState}.`),this.transport=void 0,e=this._stopError||e,this._stopError=void 0,"Disconnected"!==this._connectionState){if("Connecting"===this._connectionState)throw this._logger.log(b.Warning,`Call to HttpConnection.stopConnection(${e}) was ignored because the connection is still in the connecting state.`),new Error(`HttpConnection.stopConnection(${e}) was called while the connection is still in the connecting state.`);if("Disconnecting"===this._connectionState&&this._stopPromiseResolver(),e?this._logger.log(b.Error,`Connection disconnected with error '${e}'.`):this._logger.log(b.Information,"Connection disconnected."),this._sendQueue&&(this._sendQueue.stop().catch(e=>{this._logger.log(b.Error,`TransportSendQueue.stop() threw error '${e}'.`)}),this._sendQueue=void 0),this.connectionId=void 0,this._connectionState="Disconnected",this._connectionStarted){this._connectionStarted=!1;try{this.onclose&&this.onclose(e)}catch(t){this._logger.log(b.Error,`HttpConnection.onclose(${e}) threw error '${t}'.`)}}}else this._logger.log(b.Debug,`Call to HttpConnection.stopConnection(${e}) was ignored because the connection is already in the disconnected state.`)}_resolveUrl(e){if(0===e.lastIndexOf("https://",0)||0===e.lastIndexOf("http://",0))return e;if(!C.isBrowser)throw new Error(`Cannot resolve '${e}'.`);const t=window.document.createElement("a");return t.href=e,this._logger.log(b.Information,`Normalizing '${e}' to '${t.href}'.`),t.href}_resolveNegotiateUrl(e){const t=new URL(e);t.pathname.endsWith("/")?t.pathname+="negotiate":t.pathname+="/negotiate";const n=new URLSearchParams(t.searchParams);return n.has("negotiateVersion")||n.append("negotiateVersion",this._negotiateVersion.toString()),n.has("useStatefulReconnect")?"true"===n.get("useStatefulReconnect")&&(this._options._useStatefulReconnect=!0):!0===this._options._useStatefulReconnect&&n.append("useStatefulReconnect","true"),t.search=n.toString(),t.toString()}}class O{constructor(e){this._transport=e,this._buffer=[],this._executing=!0,this._sendBufferedData=new G,this._transportResult=new G,this._sendLoopPromise=this._sendLoop()}send(e){return this._bufferData(e),this._transportResult||(this._transportResult=new G),this._transportResult.promise}stop(){return this._executing=!1,this._sendBufferedData.resolve(),this._sendLoopPromise}_bufferData(e){if(this._buffer.length&&typeof this._buffer[0]!=typeof e)throw new Error(`Expected data to be of type ${typeof this._buffer} but was of type ${typeof e}`);this._buffer.push(e),this._sendBufferedData.resolve()}async _sendLoop(){for(;;){if(await this._sendBufferedData.promise,!this._executing){this._transportResult&&this._transportResult.reject("Connection stopped.");break}this._sendBufferedData=new G;const e=this._transportResult;this._transportResult=void 0;const t="string"==typeof this._buffer[0]?this._buffer.join(""):O._concatBuffers(this._buffer);this._buffer.length=0;try{await this._transport.send(t),e.resolve()}catch(t){e.reject(t)}}}static _concatBuffers(e){const t=e.map(e=>e.byteLength).reduce((e,t)=>e+t),n=new Uint8Array(t);let s=0;for(const t of e)n.set(new Uint8Array(t),s),s+=t.byteLength;return n.buffer}}class G{constructor(){this.promise=new Promise((e,t)=>[this._resolver,this._rejecter]=[e,t])}resolve(){this._resolver()}reject(e){this._rejecter(e)}}class V{static write(e){return`${e}${V.RecordSeparator}`}static parse(e){if(e[e.length-1]!==V.RecordSeparator)throw new Error("Message is incomplete.");const t=e.split(V.RecordSeparator);return t.pop(),t}}V.RecordSeparatorCode=30,V.RecordSeparator=String.fromCharCode(V.RecordSeparatorCode);class J{writeHandshakeRequest(e){return V.write(JSON.stringify(e))}parseHandshakeResponse(e){let t,n;if(_(e)){const s=new Uint8Array(e),i=s.indexOf(V.RecordSeparatorCode);if(-1===i)throw new Error("Message is incomplete.");const r=i+1;t=String.fromCharCode.apply(null,Array.prototype.slice.call(s.slice(0,r))),n=s.byteLength>r?s.slice(r).buffer:null}else{const s=e,i=s.indexOf(V.RecordSeparator);if(-1===i)throw new Error("Message is incomplete.");const r=i+1;t=s.substring(0,r),n=s.length>r?s.substring(r):null}const s=V.parse(t),i=JSON.parse(s[0]);if(i.type)throw new Error("Expected a handshake response from the server.");return[n,i]}}var Q;!function(e){e[e.Invocation=1]="Invocation",e[e.StreamItem=2]="StreamItem",e[e.Completion=3]="Completion",e[e.StreamInvocation=4]="StreamInvocation",e[e.CancelInvocation=5]="CancelInvocation",e[e.Ping=6]="Ping",e[e.Close=7]="Close",e[e.Ack=8]="Ack",e[e.Sequence=9]="Sequence"}(Q||(Q={}));class Y{constructor(){this.observers=[]}next(e){for(const t of this.observers)t.next(e)}error(e){for(const t of this.observers)t.error&&t.error(e)}complete(){for(const e of this.observers)e.complete&&e.complete()}subscribe(e){return this.observers.push(e),new E(this,e)}}class K{constructor(e,t,n){this._bufferSize=1e5,this._messages=[],this._totalMessageCount=0,this._waitForSequenceMessage=!1,this._nextReceivingSequenceId=1,this._latestReceivedSequenceId=0,this._bufferedByteCount=0,this._reconnectInProgress=!1,this._protocol=e,this._connection=t,this._bufferSize=n}async _send(e){const t=this._protocol.writeMessage(e);let n=Promise.resolve();if(this._isInvocationMessage(e)){this._totalMessageCount++;let e=()=>{},s=()=>{};_(t)?this._bufferedByteCount+=t.byteLength:this._bufferedByteCount+=t.length,this._bufferedByteCount>=this._bufferSize&&(n=new Promise((t,n)=>{e=t,s=n})),this._messages.push(new X(t,this._totalMessageCount,e,s))}try{this._reconnectInProgress||await this._connection.send(t)}catch{this._disconnected()}await n}_ack(e){let t=-1;for(let n=0;n<this._messages.length;n++){const s=this._messages[n];if(s._id<=e.sequenceId)t=n,_(s._message)?this._bufferedByteCount-=s._message.byteLength:this._bufferedByteCount-=s._message.length,s._resolver();else{if(!(this._bufferedByteCount<this._bufferSize))break;s._resolver()}}-1!==t&&(this._messages=this._messages.slice(t+1))}_shouldProcessMessage(e){if(this._waitForSequenceMessage)return e.type===Q.Sequence&&(this._waitForSequenceMessage=!1,!0);if(!this._isInvocationMessage(e))return!0;const t=this._nextReceivingSequenceId;return this._nextReceivingSequenceId++,t<=this._latestReceivedSequenceId?(t===this._latestReceivedSequenceId&&this._ackTimer(),!1):(this._latestReceivedSequenceId=t,this._ackTimer(),!0)}_resetSequence(e){e.sequenceId>this._nextReceivingSequenceId?this._connection.stop(new Error("Sequence ID greater than amount of messages we've received.")):this._nextReceivingSequenceId=e.sequenceId}_disconnected(){this._reconnectInProgress=!0,this._waitForSequenceMessage=!0}async _resend(){const e=0!==this._messages.length?this._messages[0]._id:this._totalMessageCount+1;await this._connection.send(this._protocol.writeMessage({type:Q.Sequence,sequenceId:e}));const t=this._messages;for(const e of t)await this._connection.send(e._message);this._reconnectInProgress=!1}_dispose(e){null!=e||(e=new Error("Unable to reconnect to server."));for(const t of this._messages)t._rejector(e)}_isInvocationMessage(e){switch(e.type){case Q.Invocation:case Q.StreamItem:case Q.Completion:case Q.StreamInvocation:case Q.CancelInvocation:return!0;case Q.Close:case Q.Sequence:case Q.Ping:case Q.Ack:return!1}}_ackTimer(){void 0===this._ackTimerHandle&&(this._ackTimerHandle=setTimeout(async()=>{try{this._reconnectInProgress||await this._connection.send(this._protocol.writeMessage({type:Q.Ack,sequenceId:this._latestReceivedSequenceId}))}catch{}clearTimeout(this._ackTimerHandle),this._ackTimerHandle=void 0},1e3))}}class X{constructor(e,t,n,s){this._message=e,this._id=t,this._resolver=n,this._rejector=s}}var Z;!function(e){e.Disconnected="Disconnected",e.Connecting="Connecting",e.Connected="Connected",e.Disconnecting="Disconnecting",e.Reconnecting="Reconnecting"}(Z||(Z={}));class ee{static create(e,t,n,s,i,r,a){return new ee(e,t,n,s,i,r,a)}constructor(e,t,n,s,i,r,a){this._nextKeepAlive=0,this._freezeEventListener=()=>{this._logger.log(b.Warning,"The page is being frozen, this will likely lead to the connection being closed and messages being lost. For more information see the docs at https://learn.microsoft.com/aspnet/core/signalr/javascript-client#bsleep")},A.isRequired(e,"connection"),A.isRequired(t,"logger"),A.isRequired(n,"protocol"),this.serverTimeoutInMilliseconds=null!=i?i:3e4,this.keepAliveIntervalInMilliseconds=null!=r?r:15e3,this._statefulReconnectBufferSize=null!=a?a:1e5,this._logger=t,this._protocol=n,this.connection=e,this._reconnectPolicy=s,this._handshakeProtocol=new J,this.connection.onreceive=e=>this._processIncomingData(e),this.connection.onclose=e=>this._connectionClosed(e),this._callbacks={},this._methods={},this._closedCallbacks=[],this._reconnectingCallbacks=[],this._reconnectedCallbacks=[],this._invocationId=0,this._receivedHandshakeResponse=!1,this._connectionState=Z.Disconnected,this._connectionStarted=!1,this._cachedPingMessage=this._protocol.writeMessage({type:Q.Ping})}get state(){return this._connectionState}get connectionId(){return this.connection&&this.connection.connectionId||null}get baseUrl(){return this.connection.baseUrl||""}set baseUrl(e){if(this._connectionState!==Z.Disconnected&&this._connectionState!==Z.Reconnecting)throw new Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!e)throw new Error("The HubConnection url must be a valid url.");this.connection.baseUrl=e}start(){return this._startPromise=this._startWithStateTransitions(),this._startPromise}async _startWithStateTransitions(){if(this._connectionState!==Z.Disconnected)return Promise.reject(new Error("Cannot start a HubConnection that is not in the 'Disconnected' state."));this._connectionState=Z.Connecting,this._logger.log(b.Debug,"Starting HubConnection.");try{await this._startInternal(),C.isBrowser&&window.document.addEventListener("freeze",this._freezeEventListener),this._connectionState=Z.Connected,this._connectionStarted=!0,this._logger.log(b.Debug,"HubConnection connected successfully.")}catch(e){return this._connectionState=Z.Disconnected,this._logger.log(b.Debug,`HubConnection failed to start successfully because of error '${e}'.`),Promise.reject(e)}}async _startInternal(){this._stopDuringStartError=void 0,this._receivedHandshakeResponse=!1;const e=new Promise((e,t)=>{this._handshakeResolver=e,this._handshakeRejecter=t});await this.connection.start(this._protocol.transferFormat);try{let t=this._protocol.version;this.connection.features.reconnect||(t=1);const n={protocol:this._protocol.name,version:t};if(this._logger.log(b.Debug,"Sending handshake request."),await this._sendMessage(this._handshakeProtocol.writeHandshakeRequest(n)),this._logger.log(b.Information,`Using HubProtocol '${this._protocol.name}'.`),this._cleanupTimeout(),this._resetTimeoutPeriod(),this._resetKeepAliveInterval(),await e,this._stopDuringStartError)throw this._stopDuringStartError;(this.connection.features.reconnect||!1)&&(this._messageBuffer=new K(this._protocol,this.connection,this._statefulReconnectBufferSize),this.connection.features.disconnected=this._messageBuffer._disconnected.bind(this._messageBuffer),this.connection.features.resend=()=>{if(this._messageBuffer)return this._messageBuffer._resend()}),this.connection.features.inherentKeepAlive||await this._sendMessage(this._cachedPingMessage)}catch(e){throw this._logger.log(b.Debug,`Hub handshake failed with error '${e}' during start(). Stopping HubConnection.`),this._cleanupTimeout(),this._cleanupPingTimer(),await this.connection.stop(e),e}}async stop(){const e=this._startPromise;this.connection.features.reconnect=!1,this._stopPromise=this._stopInternal(),await this._stopPromise;try{await e}catch(e){}}_stopInternal(e){if(this._connectionState===Z.Disconnected)return this._logger.log(b.Debug,`Call to HubConnection.stop(${e}) ignored because it is already in the disconnected state.`),Promise.resolve();if(this._connectionState===Z.Disconnecting)return this._logger.log(b.Debug,`Call to HttpConnection.stop(${e}) ignored because the connection is already in the disconnecting state.`),this._stopPromise;const t=this._connectionState;return this._connectionState=Z.Disconnecting,this._logger.log(b.Debug,"Stopping HubConnection."),this._reconnectDelayHandle?(this._logger.log(b.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this._reconnectDelayHandle),this._reconnectDelayHandle=void 0,this._completeClose(),Promise.resolve()):(t===Z.Connected&&this._sendCloseMessage(),this._cleanupTimeout(),this._cleanupPingTimer(),this._stopDuringStartError=e||new u("The connection was stopped before the hub handshake could complete."),this.connection.stop(e))}async _sendCloseMessage(){try{await this._sendWithProtocol(this._createCloseMessage())}catch{}}stream(e,...t){const[n,s]=this._replaceStreamingParams(t),i=this._createStreamInvocation(e,t,s);let r;const a=new Y;return a.cancelCallback=()=>{const e=this._createCancelInvocation(i.invocationId);return delete this._callbacks[i.invocationId],r.then(()=>this._sendWithProtocol(e))},this._callbacks[i.invocationId]=(e,t)=>{t?a.error(t):e&&(e.type===Q.Completion?e.error?a.error(new Error(e.error)):a.complete():a.next(e.item))},r=this._sendWithProtocol(i).catch(e=>{a.error(e),delete this._callbacks[i.invocationId]}),this._launchStreams(n,r),a}_sendMessage(e){return this._resetKeepAliveInterval(),this.connection.send(e)}_sendWithProtocol(e){return this._messageBuffer?this._messageBuffer._send(e):this._sendMessage(this._protocol.writeMessage(e))}send(e,...t){const[n,s]=this._replaceStreamingParams(t),i=this._sendWithProtocol(this._createInvocation(e,t,!0,s));return this._launchStreams(n,i),i}invoke(e,...t){const[n,s]=this._replaceStreamingParams(t),i=this._createInvocation(e,t,!1,s);return new Promise((e,t)=>{this._callbacks[i.invocationId]=(n,s)=>{s?t(s):n&&(n.type===Q.Completion?n.error?t(new Error(n.error)):e(n.result):t(new Error(`Unexpected message type: ${n.type}`)))};const s=this._sendWithProtocol(i).catch(e=>{t(e),delete this._callbacks[i.invocationId]});this._launchStreams(n,s)})}on(e,t){e&&t&&(e=e.toLowerCase(),this._methods[e]||(this._methods[e]=[]),-1===this._methods[e].indexOf(t)&&this._methods[e].push(t))}off(e,t){if(!e)return;e=e.toLowerCase();const n=this._methods[e];if(n)if(t){const s=n.indexOf(t);-1!==s&&(n.splice(s,1),0===n.length&&delete this._methods[e])}else delete this._methods[e]}onclose(e){e&&this._closedCallbacks.push(e)}onreconnecting(e){e&&this._reconnectingCallbacks.push(e)}onreconnected(e){e&&this._reconnectedCallbacks.push(e)}_processIncomingData(e){if(this._cleanupTimeout(),this._receivedHandshakeResponse||(e=this._processHandshakeResponse(e),this._receivedHandshakeResponse=!0),e){const t=this._protocol.parseMessages(e,this._logger);for(const e of t)if(!this._messageBuffer||this._messageBuffer._shouldProcessMessage(e))switch(e.type){case Q.Invocation:this._invokeClientMethod(e).catch(e=>{this._logger.log(b.Error,`Invoke client method threw error: ${B(e)}`)});break;case Q.StreamItem:case Q.Completion:{const t=this._callbacks[e.invocationId];if(t){e.type===Q.Completion&&delete this._callbacks[e.invocationId];try{t(e)}catch(e){this._logger.log(b.Error,`Stream callback threw error: ${B(e)}`)}}break}case Q.Ping:break;case Q.Close:{this._logger.log(b.Information,"Close message received from server.");const t=e.error?new Error("Server returned an error on close: "+e.error):void 0;!0===e.allowReconnect?this.connection.stop(t):this._stopPromise=this._stopInternal(t);break}case Q.Ack:this._messageBuffer&&this._messageBuffer._ack(e);break;case Q.Sequence:this._messageBuffer&&this._messageBuffer._resetSequence(e);break;default:this._logger.log(b.Warning,`Invalid message type: ${e.type}.`)}}this._resetTimeoutPeriod()}_processHandshakeResponse(e){let t,n;try{[n,t]=this._handshakeProtocol.parseHandshakeResponse(e)}catch(e){const t="Error parsing handshake response: "+e;this._logger.log(b.Error,t);const n=new Error(t);throw this._handshakeRejecter(n),n}if(t.error){const e="Server returned handshake error: "+t.error;this._logger.log(b.Error,e);const n=new Error(e);throw this._handshakeRejecter(n),n}return this._logger.log(b.Debug,"Server handshake complete."),this._handshakeResolver(),n}_resetKeepAliveInterval(){this.connection.features.inherentKeepAlive||(this._nextKeepAlive=(new Date).getTime()+this.keepAliveIntervalInMilliseconds,this._cleanupPingTimer())}_resetTimeoutPeriod(){if(!(this.connection.features&&this.connection.features.inherentKeepAlive||(this._timeoutHandle=setTimeout(()=>this.serverTimeout(),this.serverTimeoutInMilliseconds),void 0!==this._pingServerHandle))){let e=this._nextKeepAlive-(new Date).getTime();e<0&&(e=0),this._pingServerHandle=setTimeout(async()=>{if(this._connectionState===Z.Connected)try{await this._sendMessage(this._cachedPingMessage)}catch{this._cleanupPingTimer()}},e)}}serverTimeout(){this.connection.stop(new Error("Server timeout elapsed without receiving a message from the server."))}async _invokeClientMethod(e){const t=e.target.toLowerCase(),n=this._methods[t];if(!n)return this._logger.log(b.Warning,`No client method with the name '${t}' found.`),void(e.invocationId&&(this._logger.log(b.Warning,`No result given for '${t}' method and invocation ID '${e.invocationId}'.`),await this._sendWithProtocol(this._createCompletionMessage(e.invocationId,"Client didn't provide a result.",null))));const s=n.slice(),i=!!e.invocationId;let r,a,o;for(const n of s)try{const s=r;r=await n.apply(this,e.arguments),i&&r&&s&&(this._logger.log(b.Error,`Multiple results provided for '${t}'. Sending error to server.`),o=this._createCompletionMessage(e.invocationId,"Client provided multiple results.",null)),a=void 0}catch(e){a=e,this._logger.log(b.Error,`A callback for the method '${t}' threw error '${e}'.`)}o?await this._sendWithProtocol(o):i?(a?o=this._createCompletionMessage(e.invocationId,`${a}`,null):void 0!==r?o=this._createCompletionMessage(e.invocationId,null,r):(this._logger.log(b.Warning,`No result given for '${t}' method and invocation ID '${e.invocationId}'.`),o=this._createCompletionMessage(e.invocationId,"Client didn't provide a result.",null)),await this._sendWithProtocol(o)):r&&this._logger.log(b.Error,`Result given for '${t}' method but server is not expecting a result.`)}_connectionClosed(e){this._logger.log(b.Debug,`HubConnection.connectionClosed(${e}) called while in state ${this._connectionState}.`),this._stopDuringStartError=this._stopDuringStartError||e||new u("The underlying connection was closed before the hub handshake could complete."),this._handshakeResolver&&this._handshakeResolver(),this._cancelCallbacksWithError(e||new Error("Invocation canceled due to the underlying connection being closed.")),this._cleanupTimeout(),this._cleanupPingTimer(),this._connectionState===Z.Disconnecting?this._completeClose(e):this._connectionState===Z.Connected&&this._reconnectPolicy?this._reconnect(e):this._connectionState===Z.Connected&&this._completeClose(e)}_completeClose(e){if(this._connectionStarted){this._connectionState=Z.Disconnected,this._connectionStarted=!1,this._messageBuffer&&(this._messageBuffer._dispose(null!=e?e:new Error("Connection closed.")),this._messageBuffer=void 0),C.isBrowser&&window.document.removeEventListener("freeze",this._freezeEventListener);try{this._closedCallbacks.forEach(t=>t.apply(this,[e]))}catch(t){this._logger.log(b.Error,`An onclose callback called with error '${e}' threw error '${t}'.`)}}}async _reconnect(e){const t=Date.now();let n=0,s=void 0!==e?e:new Error("Attempting to reconnect due to a unknown error."),i=this._getNextRetryDelay(n++,0,s);if(null===i)return this._logger.log(b.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),void this._completeClose(e);if(this._connectionState=Z.Reconnecting,e?this._logger.log(b.Information,`Connection reconnecting because of error '${e}'.`):this._logger.log(b.Information,"Connection reconnecting."),0!==this._reconnectingCallbacks.length){try{this._reconnectingCallbacks.forEach(t=>t.apply(this,[e]))}catch(t){this._logger.log(b.Error,`An onreconnecting callback called with error '${e}' threw error '${t}'.`)}if(this._connectionState!==Z.Reconnecting)return void this._logger.log(b.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting.")}for(;null!==i;){if(this._logger.log(b.Information,`Reconnect attempt number ${n} will start in ${i} ms.`),await new Promise(e=>{this._reconnectDelayHandle=setTimeout(e,i)}),this._reconnectDelayHandle=void 0,this._connectionState!==Z.Reconnecting)return void this._logger.log(b.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting.");try{if(await this._startInternal(),this._connectionState=Z.Connected,this._logger.log(b.Information,"HubConnection reconnected successfully."),0!==this._reconnectedCallbacks.length)try{this._reconnectedCallbacks.forEach(e=>e.apply(this,[this.connection.connectionId]))}catch(e){this._logger.log(b.Error,`An onreconnected callback called with connectionId '${this.connection.connectionId}; threw error '${e}'.`)}return}catch(e){if(this._logger.log(b.Information,`Reconnect attempt failed because of error '${e}'.`),this._connectionState!==Z.Reconnecting)return this._logger.log(b.Debug,`Connection moved to the '${this._connectionState}' from the reconnecting state during reconnect attempt. Done reconnecting.`),void(this._connectionState===Z.Disconnecting&&this._completeClose());s=e instanceof Error?e:new Error(e.toString()),i=this._getNextRetryDelay(n++,Date.now()-t,s)}}this._logger.log(b.Information,`Reconnect retries have been exhausted after ${Date.now()-t} ms and ${n} failed attempts. Connection disconnecting.`),this._completeClose()}_getNextRetryDelay(e,t,n){try{return this._reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:t,previousRetryCount:e,retryReason:n})}catch(n){return this._logger.log(b.Error,`IRetryPolicy.nextRetryDelayInMilliseconds(${e}, ${t}) threw error '${n}'.`),null}}_cancelCallbacksWithError(e){const t=this._callbacks;this._callbacks={},Object.keys(t).forEach(n=>{const s=t[n];try{s(null,e)}catch(t){this._logger.log(b.Error,`Stream 'error' callback called with '${e}' threw error: ${B(t)}`)}})}_cleanupPingTimer(){this._pingServerHandle&&(clearTimeout(this._pingServerHandle),this._pingServerHandle=void 0)}_cleanupTimeout(){this._timeoutHandle&&clearTimeout(this._timeoutHandle)}_createInvocation(e,t,n,s){if(n)return 0!==s.length?{target:e,arguments:t,streamIds:s,type:Q.Invocation}:{target:e,arguments:t,type:Q.Invocation};{const n=this._invocationId;return this._invocationId++,0!==s.length?{target:e,arguments:t,invocationId:n.toString(),streamIds:s,type:Q.Invocation}:{target:e,arguments:t,invocationId:n.toString(),type:Q.Invocation}}}_launchStreams(e,t){if(0!==e.length){t||(t=Promise.resolve());for(const n in e)e[n].subscribe({complete:()=>{t=t.then(()=>this._sendWithProtocol(this._createCompletionMessage(n)))},error:e=>{let s;s=e instanceof Error?e.message:e&&e.toString?e.toString():"Unknown error",t=t.then(()=>this._sendWithProtocol(this._createCompletionMessage(n,s)))},next:e=>{t=t.then(()=>this._sendWithProtocol(this._createStreamItemMessage(n,e)))}})}}_replaceStreamingParams(e){const t=[],n=[];for(let s=0;s<e.length;s++){const i=e[s];if(this._isObservable(i)){const r=this._invocationId;this._invocationId++,t[r]=i,n.push(r.toString()),e.splice(s,1)}}return[t,n]}_isObservable(e){return e&&e.subscribe&&"function"==typeof e.subscribe}_createStreamInvocation(e,t,n){const s=this._invocationId;return this._invocationId++,0!==n.length?{target:e,arguments:t,invocationId:s.toString(),streamIds:n,type:Q.StreamInvocation}:{target:e,arguments:t,invocationId:s.toString(),type:Q.StreamInvocation}}_createCancelInvocation(e){return{invocationId:e,type:Q.CancelInvocation}}_createStreamItemMessage(e,t){return{invocationId:e,item:t,type:Q.StreamItem}}_createCompletionMessage(e,t,n){return t?{error:t,invocationId:e,type:Q.Completion}:{invocationId:e,result:n,type:Q.Completion}}_createCloseMessage(){return{type:Q.Close}}}class te{constructor(){this.name="json",this.version=2,this.transferFormat=N.Text}parseMessages(e,t){if("string"!=typeof e)throw new Error("Invalid input for JSON hub protocol. Expected a string.");if(!e)return[];null===t&&(t=v.instance);const n=V.parse(e),s=[];for(const e of n){const n=JSON.parse(e);if("number"!=typeof n.type)throw new Error("Invalid payload.");switch(n.type){case Q.Invocation:this._isInvocationMessage(n);break;case Q.StreamItem:this._isStreamItemMessage(n);break;case Q.Completion:this._isCompletionMessage(n);break;case Q.Ping:case Q.Close:break;case Q.Ack:this._isAckMessage(n);break;case Q.Sequence:this._isSequenceMessage(n);break;default:t.log(b.Information,"Unknown message type '"+n.type+"' ignored.");continue}s.push(n)}return s}writeMessage(e){return V.write(JSON.stringify(e))}_isInvocationMessage(e){this._assertNotEmptyString(e.target,"Invalid payload for Invocation message."),void 0!==e.invocationId&&this._assertNotEmptyString(e.invocationId,"Invalid payload for Invocation message.")}_isStreamItemMessage(e){if(this._assertNotEmptyString(e.invocationId,"Invalid payload for StreamItem message."),void 0===e.item)throw new Error("Invalid payload for StreamItem message.")}_isCompletionMessage(e){if(e.result&&e.error)throw new Error("Invalid payload for Completion message.");!e.result&&e.error&&this._assertNotEmptyString(e.error,"Invalid payload for Completion message."),this._assertNotEmptyString(e.invocationId,"Invalid payload for Completion message.")}_isAckMessage(e){if("number"!=typeof e.sequenceId)throw new Error("Invalid SequenceId for Ack message.")}_isSequenceMessage(e){if("number"!=typeof e.sequenceId)throw new Error("Invalid SequenceId for Sequence message.")}_assertNotEmptyString(e,t){if("string"!=typeof e||""===e)throw new Error(t)}}const ne={trace:b.Trace,debug:b.Debug,info:b.Information,information:b.Information,warn:b.Warning,warning:b.Warning,error:b.Error,critical:b.Critical,none:b.None};class se{configureLogging(e){if(A.isRequired(e,"logging"),void 0!==e.log)this.logger=e;else if("string"==typeof e){const t=function(e){const t=ne[e.toLowerCase()];if(void 0!==t)return t;throw new Error(`Unknown log level: ${e}`)}(e);this.logger=new I(t)}else this.logger=new I(e);return this}withUrl(e,t){return A.isRequired(e,"url"),A.isNotEmpty(e,"url"),this.url=e,this.httpConnectionOptions="object"==typeof t?{...this.httpConnectionOptions,...t}:{...this.httpConnectionOptions,transport:t},this}withHubProtocol(e){return A.isRequired(e,"protocol"),this.protocol=e,this}withAutomaticReconnect(e){if(this.reconnectPolicy)throw new Error("A reconnectPolicy has already been set.");return e?Array.isArray(e)?this.reconnectPolicy=new a(e):this.reconnectPolicy=e:this.reconnectPolicy=new a,this}withServerTimeout(e){return A.isRequired(e,"milliseconds"),this._serverTimeoutInMilliseconds=e,this}withKeepAliveInterval(e){return A.isRequired(e,"milliseconds"),this._keepAliveIntervalInMilliseconds=e,this}withStatefulReconnect(e){return void 0===this.httpConnectionOptions&&(this.httpConnectionOptions={}),this.httpConnectionOptions._useStatefulReconnect=!0,this._statefulReconnectBufferSize=null==e?void 0:e.bufferSize,this}build(){const e=this.httpConnectionOptions||{};if(void 0===e.logger&&(e.logger=this.logger),!this.url)throw new Error("The 'HubConnectionBuilder.withUrl' method must be called before building the connection.");const t=new z(this.url,e);return ee.create(t,this.logger||v.instance,this.protocol||new te,this.reconnectPolicy,this._serverTimeoutInMilliseconds,this._keepAliveIntervalInMilliseconds,this._statefulReconnectBufferSize)}}class ie{constructor(e,t,n=null,s=null){this.config=e,this.messageStore=t,this.apiClient=n,this.thinkingManager=s,this.connection=null,this.listeners=new Map,this.connected=!1,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.socketId=null,this.waitingForResponse=!1}async connect(){if(this.connected)return;const e=this.config.get("signalRUrl");if(!e)throw new Error("SignalRClient: SignalR URL not configured");const t=this.config.get("jwtToken");try{const n=t?`${e}?access_token=${t}`:e;this.connection=(new se).withUrl(n,{accessTokenFactory:()=>t||this.config.get("apikey")}).withAutomaticReconnect({nextRetryDelayInMilliseconds:e=>e.previousRetryCount>=this.maxReconnectAttempts?null:Math.min(1e3*Math.pow(2,e.previousRetryCount),3e4)}).configureLogging(this.config.get("debug")?b.Debug:b.Warning).build(),this.setupEventHandlers(),await this.connection.start(),this.connected=!0,this.reconnectAttempts=0,this.socketId=this.connection.connectionId,await this.registerForMessages()}catch(e){throw e}}setupEventHandlers(){this.connection.on("AiResponseReceived",e=>{const t=this.config.get("onSignalRMessage");t&&t(e),this.handleUnifiedMessage(e)}),this.connection.onmessage=e=>{e&&1===e.type&&e.arguments},this.connection.on("ScenarioQueryMessage",e=>{}),["AiResponseReceived","UnifiedAiMessage","ScenarioGenerated","ScenarioQueryMessage","BackTestExecuted"].forEach(e=>{this.connection.on(e,t=>{if("ScenarioGenerated"===e){const e=t.aiResponse||t.AiResponse;if(e)try{"string"==typeof e&&JSON.parse(e)}catch(e){}}})}),this.connection.on("UnifiedAiMessage",e=>{this.handleUnifiedMessage(e)}),this.connection.on("ScenarioGenerated",e=>{const t={messageType:e.messageType||e.MessageType||"Model",originalEndpoint:e.originalEndpoint||e.OriginalEndpoint||"/query",scenarioId:e.scenarioId||e.ScenarioId,sessionId:e.sessionId||e.SessionId,aiResponse:e.aiResponse||e.AiResponse,dagRequestId:e.dagRequestId||e.DagRequestId,relatedUserMessageId:e.relatedUserMessageId||e.RelatedUserMessageId,requestId:e.requestId||e.RequestId,statusCode:e.statusCode||e.StatusCode||200};this.handleUnifiedMessage(t)}),this.connection.on("ScenarioQueryMessage",e=>{this.handleScenarioQueryMessage(e)}),this.connection.on("ScenarioUpdated",e=>{this.emit("scenarioUpdated",e)}),this.connection.on("Error",e=>{this.emit("error",e)}),this.connection.onreconnecting(e=>{this.connected=!1,this.reconnectAttempts++,this.emit("reconnecting",{attempt:this.reconnectAttempts,error:e})}),this.connection.onreconnected(e=>{this.connected=!0,this.reconnectAttempts=0,this.socketId=e,this.emit("reconnected",e),this.registerForMessages().catch(console.error)}),this.connection.onclose(e=>{this.connected=!1,this.emit("disconnected",e)})}handleUnifiedMessage(e){const{messageType:t,originalEndpoint:n,sessionId:s,scenarioId:i}=e;if(this.thinkingManager){const e=Array.from(this.thinkingManager.activeIndicators.keys());"/chat"===n?e.forEach(e=>{(e.startsWith("chat-")||e.startsWith("template-"))&&this.thinkingManager.stopThinking(e)}):"/query"===n&&e.forEach(e=>{e.startsWith("query-")&&this.thinkingManager.stopThinking(e)});Array.from(this.thinkingManager.activeIndicators.keys())}switch(s&&(this.config.set("sessionId",s),this.messageStore&&(this.messageStore.currentSessionId=s)),"/chat"===n&&("Template"===t?this.messageStore.startSession(s,e.templateName||"Template"):"Model"===t&&s&&this.messageStore.endSession(s)),t){case"Text":case"Steps":default:this.handleChatMessage(e);break;case"Template":this.handleTemplateMessage(e);break;case"Model":this.handleModelMessage(e);break;case"Analysis":this.handleAnalysisMessage(e);break;case"Scenario":case"Explanation":this.handleSpecialMessage(e);break;case"Evaluation":case"EvaluationComplete":this.handleEvaluationMessage(e)}this.waitingForResponse&&(this.waitingForResponse=!1,this.emit("responseReceived",e))}handleChatMessage(e){const t={id:e.aiMessageId||e.id,content:e.aiResponse||e.message,messageType:e.messageType,type:"ai",isAiResponse:!0,scenarioId:e.scenarioId,sessionId:e.sessionId,timestamp:(new Date).toISOString(),originalEndpoint:e.originalEndpoint,parentMessageId:e.relatedUserMessageId};this.messageStore.addMessage(t),this.emit("chatMessage",t)}handleTemplateMessage(e){const t={id:e.aiMessageId||e.id,content:e.aiResponse||e.templateContent,messageType:"Template",type:"ai",isAiResponse:!0,templateName:e.templateName,scenarioId:e.scenarioId,sessionId:e.sessionId,timestamp:(new Date).toISOString(),originalEndpoint:e.originalEndpoint};this.messageStore.addMessage(t),this.emit("templateMessage",t),this.emit("templateReady",t)}handleModelMessage(e){let t=null;try{t="string"==typeof e.aiResponse?JSON.parse(e.aiResponse):e.aiResponse}catch(e){}const n={id:e.aiMessageId||e.dagRequestId,messageType:"Model",type:"ai",isAiResponse:!0,scenarioId:e.scenarioId,sessionId:e.sessionId,dagRequestId:e.dagRequestId,dagData:t,aiResponse:e.aiResponse,timestamp:(new Date).toISOString(),originalEndpoint:e.originalEndpoint,parentMessageId:e.relatedUserMessageId};this.messageStore.addMessage(n),"/query"===e.originalEndpoint?this.emit("dagGenerated",n):"/chat"===e.originalEndpoint&&this.emit("templateDagGenerated",n),this.emit("modelMessage",n),this.autoExecuteAfterDagGeneration(n)}async autoExecuteAfterDagGeneration(e){!1!==this.config.get("autoExecuteAfterDag")&&this.emit("dagGenerationComplete",{scenarioId:e.scenarioId,dagData:e.dagData,messageType:"Model"})}handleAnalysisMessage(e){let t=null,n=null,s=null;try{if("string"==typeof e.aiResponse)try{const i=JSON.parse(e.aiResponse);let r=i.text||i.message||e.aiResponse;if("string"==typeof r&&r.startsWith("{"))try{const e=JSON.parse(r);t=e.text||e.message||r}catch{t=r}else t=r;n=i.tableMarkdown,s=i.tableJson}catch{t=e.aiResponse}else{let i=e.aiResponse?.text||e.aiResponse?.message||"";if("string"==typeof i&&i.startsWith("{"))try{const e=JSON.parse(i);t=e.text||e.message||i}catch{t=i}else t=i;n=e.aiResponse?.tableMarkdown,s=e.aiResponse?.tableJson}}catch(n){t=e.aiResponse||""}const i={id:e.aiMessageId||e.id,content:t,messageType:"Analysis",type:"ai",isAiResponse:!0,scenarioId:e.scenarioId,sessionId:e.sessionId,tableMarkdown:n,tableJson:s,timestamp:(new Date).toISOString(),originalEndpoint:e.originalEndpoint,parentMessageId:e.relatedUserMessageId};this.messageStore.addMessage(i),this.emit("analysisMessage",i)}handleSpecialMessage(e){const t={id:e.aiMessageId||e.id,content:e.aiResponse||e.message,messageType:e.messageType,type:"ai",isAiResponse:!0,scenarioId:e.scenarioId,sessionId:e.sessionId,timestamp:(new Date).toISOString(),originalEndpoint:e.originalEndpoint,parentMessageId:e.relatedUserMessageId,fixedDag:e.fixedDag,fixedScenario:e.fixedScenario};this.messageStore.addMessage(t),this.emit(`${e.messageType.toLowerCase()}Message`,t)}handleEvaluationMessage(e){const t={id:e.id,messageType:e.messageType,type:"system",scenarioId:e.scenarioId,sessionId:e.sessionId,status:e.status,hasResults:e.hasResults,totalRecords:e.totalRecords,timestamp:(new Date).toISOString()};this.messageStore.addMessage(t),this.emit("evaluationMessage",t),e.scenarioId&&this.messageStore.updateScenarioStatus(e.scenarioId,e.status)}handleScenarioQueryMessage(e){const t={messageType:"Model",originalEndpoint:"/query",scenarioId:e.scenarioId,dagRequestId:e.dagRequestId,aiResponse:e.aiData,relatedUserMessageId:e.relatedUserMessageId,statusCode:e.statusCode};this.handleUnifiedMessage(t)}handleLegacyMessage(e){const t={messageType:e.type||"Text",originalEndpoint:"/chat",aiResponse:e.content||e.message,aiMessageId:e.id,scenarioId:e.scenarioId,timestamp:e.timestamp};this.handleUnifiedMessage(t)}async registerForMessages(){const e=this.config.get("scenarioId");if(e&&this.connection)try{await this.connection.invoke("JoinScenario",e)}catch(e){}const t=this.config.get("widgetId");if(t&&this.connection)try{await this.connection.invoke("JoinWidget",t)}catch(e){}}setWaitingForResponse(e){this.waitingForResponse=e,this.emit("waitingStateChanged",e)}getConnectionId(){return this.socketId||this.connection?.connectionId}async disconnect(){if(this.connection)try{await this.connection.stop(),this.connected=!1,this.connection=null,this.socketId=null}catch(e){}}async send(e,...t){if(!this.connected||!this.connection)throw new Error("SignalRClient: Not connected");try{return await this.connection.invoke(e,...t)}catch(e){throw e}}on(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),()=>{const n=this.listeners.get(e);if(n){const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}}off(e,t){const n=this.listeners.get(e);if(n){const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}emit(e,t){const n=this.listeners.get(e);n&&n.forEach(e=>{try{e(t)}catch(e){}})}getState(){if(!this.connection)return"Disconnected";switch(this.connection.state){case Z.Connected:return"Connected";case Z.Connecting:return"Connecting";case Z.Reconnecting:return"Reconnecting";case Z.Disconnected:return"Disconnected";case Z.Disconnecting:return"Disconnecting";default:return"Unknown"}}isConnected(){return this.connected&&this.connection?.state===Z.Connected}}const re={isWidget:!0,widgetVersion:"2.0.0",returnFormat:"simplified",includeLinks:!0,compressImages:!0,paginateResults:!0,pageSize:50,skipVisualization:!0,includeTableData:!0,simplifyDAG:!0,trackSessions:!0,sendAnalytics:!0},ae=[{id:0,name:"Explore",icon:"💭",description:"Explore ideas and refine your trading scenario"},{id:1,name:"Template",icon:"📝",description:"Select or create a scenario template"},{id:2,name:"Model",icon:"🔧",description:"Generate the trading model"},{id:3,name:"Evaluate",icon:"📊",description:"Run evaluation on market data"},{id:4,name:"Analyze",icon:"🔍",description:"Analyze results and patterns"},{id:5,name:"Backtest",icon:"📈",description:"Run historical backtests"}],oe={INITIALIZING:"initializing",LANDING:"landing",CHATTING:"chatting",GENERATING:"generating",EVALUATING:"evaluating",ANALYZING:"analyzing",ERROR:"error",DISCONNECTED:"disconnected"};class ce{constructor(e){this.config=e,this.baseUrl=e.get("apiBaseUrl"),this.apiKey=e.get("apikey"),this.headers={"Content-Type":"application/json","X-API-Key":this.apiKey,"X-Widget-Version":"1.0.0","X-Widget-Session":e.get("sessionId")||"unknown"}}async getJwtToken(){const e=`${this.baseUrl}/api/widget/auth/token`,t={ExternalUserId:this.config.get("externalUserId"),DisplayName:this.config.get("userDisplayName"),Metadata:this.config.get("userMetadata")||{}};try{return await this.request("POST",e,t)}catch(e){throw e}}async createOrGetUser(e,t=null,n={}){const s=`${this.baseUrl}/api/widget/users`,i={externalUserId:e,displayName:t,metadata:n};try{return await this.request("POST",s,i)}catch(e){throw e}}async sendMessage(e,t={}){const n=`${this.baseUrl}/api/widget/chat`,s=t.sessionId||this.config.get("sessionId")||null,i=this.config.get("externalUserId");if(!i)throw new Error("ApiClient: ExternalUserId is required but not set in config");let r;if(t.scenarioId)r=t.scenarioId;else{if(!this.config.get("scenarioId"))throw new Error("ApiClient: ScenarioId is required but not found. Backend must create ScenarioId first.");r=this.config.get("scenarioId")}const a={Message:e,ExternalUserId:i,MessageType:t.messageType||"Text",ScenarioId:r,SessionId:s,Image:t.image||null,ParentMessageId:t.parentMessageId||null,prompt:e,gpt_version:"v3",postId:this.generatePostId(),userId:this.config.get("userId"),isAiResponse:!1,message:e};this.addScenarioContext(a,t),this.addMarketInfo(a,t),t.socketId&&(a.frontendSocketId=t.socketId),Object.assign(a,re);try{return await this.request("POST",n,a)}catch(e){throw e}}addScenarioContext(e,t){const n=this.buildScenarioRequest();n&&(e.scenarioRequest=n);const s=this.buildScenarioExecuteRequest();s&&(e.scenarioExecuteRequest=s)}buildScenarioRequest(){const e=this.config.get("scenarioId");if(!e)return null;const t={scenarioId:e,scenarioName:this.config.get("scenarioName")||""},n=this.config.get("defaultSymbol");n&&(t.symbol=n);const s=this.config.get("defaultTimeframe");if(s){const e=this.parseTimeframeToMinutes(s);t.inputFreq=e,t.outputFreq=e}const i=this.config.get("weekDays");t.weekDays=i||[1,2,3,4,5,6,7];const r=this.config.get("months");t.months=r||[1,2,3,4,5,6,7,8,9,10,11,12];const a=this.config.get("fromTime"),o=this.config.get("toTime"),c=this.config.get("timeZone");a&&(t.fromTime=a),o&&(t.toTime=o),c&&(t.timeZone=c);const l=this.config.get("refreshDatetime");return l&&(t.refreshDatetime=l),t}buildScenarioExecuteRequest(){const e=this.config.get("scenarioData");if(!e)return null;const t=this.config.get("defaultSymbol"),n=this.config.get("defaultTimeframe");if(!t||!n)return null;const s=this.parseTimeframeToMinutes(n),i={intervalInMinutes:s,symbol:t,dataIntervalInMinutes:s,scenarioData:e},r=this.config.get("exchange");r&&(i.Exchange=r),i.weekDays=this.config.get("weekDays")||[1,2,3,4,5,6,7],i.months=this.config.get("months")||[1,2,3,4,5,6,7,8,9,10,11,12];const a=this.config.get("fromTime"),o=this.config.get("toTime"),c=this.config.get("timeZone");return a&&(i.fromTime=a),o&&(i.toTime=o),c&&(i.timezone=c),i}addMarketInfo(e,t){let n=this.config.get("defaultSymbol");n||(n="EURUSD",this.config.set("defaultSymbol",n));const s={symbol:n,timeframe:this.config.get("defaultTimeframe")||"1H",interval_minutes:this.parseTimeframeToMinutes(this.config.get("defaultTimeframe")||"1H"),exchange:this.config.get("exchange")||"DUKASCOPY"};e.marketinfo=s}parseTimeframeToMinutes(e){if(!e||"string"!=typeof e)return 60;const t=e.toUpperCase();if(t.endsWith("M"))return parseInt(t.slice(0,-1))||15;if(t.endsWith("H"))return 60*(parseInt(t.slice(0,-1))||1);if(t.endsWith("D"))return 1440*(parseInt(t.slice(0,-1))||1);const n=parseInt(e);return isNaN(n)?60:n}generatePostId(){return Math.floor(Date.now()/1e3).toString(16).padStart(8,"0")+Array.from({length:16},()=>Math.floor(16*Math.random()).toString(16)).join("")}async sendFeedback(e,t){const n=`${this.baseUrl}/api/widget/feedback`,s={MessageId:e,Feedback:t.type,Comments:t.comments};try{return await this.request("POST",n,s)}catch(e){throw e}}async createScenario(e="New Scenario"){const t=`${this.baseUrl}/api/widget/scenarios`,n=this.config.get("externalUserId");if(!n)throw new Error("ApiClient: ExternalUserId is required to create scenario");const s={ExternalUserId:n,Name:e};try{const n=await this.request("POST",t,s);return n.scenarioId&&(this.config.set("scenarioId",n.scenarioId),this.config.set("scenarioName",e)),n}catch(e){throw e}}async getMessages(e){const t=`${this.baseUrl}/api/widget/messages/${e}`;try{return await this.request("GET",t)}catch(e){throw e}}async uploadImage(e){let t=e;return e instanceof File&&(t=await this.fileToBase64(e)),{base64:t,url:`data:image/jpeg;base64,${t}`}}async generateScenario(e={}){const t=`${this.baseUrl}/api/widget/query`,n=this.config.get("externalUserId");if(!n)throw new Error("ApiClient: ExternalUserId is required for scenario generation");const s=e.scenarioId||this.config.get("scenarioId");if(!s)throw new Error("ApiClient: ScenarioId is required for generateScenario - must have previous chat messages first");const i=e.sessionId||this.config.get("sessionId"),r={ExternalUserId:n,ConversationContext:e.conversationContext||"",ScenarioId:s,SessionId:i,SocketId:e.socketId||this.config.get("socketId"),PostId:crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})};try{return await this.request("POST",t,r)}catch(e){throw e}}async executeWidget(e,t={}){const n=`${this.baseUrl}/api/widget/execute`,s=this.config.get("externalUserId");if(!s)throw new Error("ApiClient: ExternalUserId is required for widget execution");const i=t.scenarioId||this.config.get("scenarioId");if(!i)throw new Error("ApiClient: ScenarioId is required for widget execution");if(!e||!e.Nodes||!e.Edges)throw new Error("ApiClient: ScenarioData with Nodes and Edges is required for execution");const r={ExternalUserId:s,ScenarioId:i,ScenarioData:e,Symbol:t.symbol||this.config.get("defaultSymbol"),IntervalInMinutes:t.intervalInMinutes||this.parseTimeframeToMinutes(this.config.get("defaultTimeframe"))};try{return await this.request("POST",n,r)}catch(e){throw e}}async loadBlocksData(){const e=`${this.baseUrl}/api/widget/blocks`;try{const t=await this.request("GET",e);return this.config.set("blocksData",t),t}catch(e){throw e}}async loadCurrencies(){const e=`${this.baseUrl}/candlechart/data/currencies`;try{const t=await this.request("GET",e);return this.config.set("currencies",t),t}catch(e){throw e}}async loadCurrenciesOld(){const e=`${this.baseUrl}/api/currencies`;try{const t=await this.request("GET",e);return this.config.set("currencies",t),t}catch(e){throw e}}async request(e,t,n=null){const s={method:e,headers:this.headers};n&&"GET"!==e&&(s.body=JSON.stringify(n));try{const e=await fetch(t,s);if(!e.ok){const t=await e.text();throw new Error(`API Error ${e.status}: ${t}`)}const n=e.headers.get("content-type");return n&&n.includes("application/json")?await e.json():await e.text()}catch(e){throw this.config.get("debug"),e}}fileToBase64(e){return new Promise((t,n)=>{const s=new FileReader;s.onload=()=>{const e=s.result.split(",")[1];t(e)},s.onerror=n,s.readAsDataURL(e)})}async checkRateLimits(){return{dagRequests:{used:0,limit:this.config.get("rateLimits").maxDagRequests},chatRequests:{used:0,limit:this.config.get("rateLimits").maxChatRequests}}}async get(e,t={}){const n=e.startsWith("http")?e:`${this.baseUrl}${e}`;return await this.request("GET",n,null)}async post(e,t=null,n={}){const s=e.startsWith("http")?e:`${this.baseUrl}${e}`;return await this.request("POST",s,t)}async put(e,t=null,n={}){const s=e.startsWith("http")?e:`${this.baseUrl}${e}`;return await this.request("PUT",s,t)}async delete(e,t={}){const n=e.startsWith("http")?e:`${this.baseUrl}${e}`;return await this.request("DELETE",n,null)}}class le{constructor(){this.activeIndicators=new Map,this.progressiveMessages={"/chat":{0:"💭 Thinking...",5e3:"🧠 Analyzing your request...",1e4:"📝 Crafting response...",3e4:"⏳ Almost done...",45e3:"🤔 This is taking a bit longer..."},"/query":{0:"🚀 Creating your model...",3e3:"🔨 Constructing DAG structure...",8e3:"⚡ Optimizing parameters...",15e3:"🎯 Fine-tuning logic...",3e4:"⚠️ Complex model taking time...",6e4:"❌ Timeout - Please try again"},"/execute":{0:"⚡ Running the model...",1500:"📈 Processing market data...",4e3:"🔍 Finding trading opportunities...",8e3:"📊 Analyzing results...",15e3:"⚠️ Large dataset processing..."},template:{0:"📝 Processing template...",3e3:"🎯 Customizing parameters...",8e3:"✨ Generating scenario...",15e3:"🔧 Applying configurations...",3e4:"⚠️ Template taking time..."},analysis:{0:"🔍 Analyzing data...",3e3:"💡 Processing your question...",8e3:"📊 Generating insights...",15e3:"🎯 Deep diving into data...",3e4:"⚠️ Complex analysis in progress..."}}}startThinking(e,t,n=null,s=null,i=6e4){this.stopThinking(e);const r={id:e,type:t,startTime:Date.now(),element:null,timers:[],customMessage:n,onTimeout:s,timeoutMs:i,timedOut:!1};return this.activeIndicators.set(e,r),this.createIndicatorElement(r),this.scheduleProgressiveUpdates(r),s&&i>0&&this.setupTimeoutHandler(r),"/chat"===r.type&&this.startProgressBar(r),r}stopThinking(e){const t=this.activeIndicators.get(e);return!!t&&(t.timers.forEach(e=>clearTimeout(e)),t.progressTimer&&clearTimeout(t.progressTimer),t.element&&(t.element.style.opacity="0",t.element.style.transform="translateY(-10px)",setTimeout(()=>{t.element&&t.element.parentNode&&t.element.parentNode.removeChild(t.element)},300)),this.activeIndicators.delete(e),!0)}createIndicatorElement(e){const t=this.progressiveMessages[e.type]||this.progressiveMessages["/chat"],n=e.customMessage||t[0],s=document.createElement("div");s.className="tlw-thinking-indicator",s.setAttribute("data-type",e.type),s.innerHTML=`\n      <div class="tlw-thinking-content">\n        <div class="tlw-thinking-animation">\n          <span class="tlw-thinking-dot"></span>\n          <span class="tlw-thinking-dot"></span>\n          <span class="tlw-thinking-dot"></span>\n        </div>\n        <div class="tlw-thinking-message">\n          ${n}\n        </div>\n        <div class="tlw-thinking-timer" style="display: none;">\n          <span class="tlw-timer-text">0s</span>\n        </div>\n      </div>\n      <div class="tlw-progress-bar">\n        <div class="tlw-progress-fill"></div>\n      </div>\n    `;const i=document.getElementById("chatContainer")||document.querySelector(".tlw-messages-container")||document.querySelector(".tlw-chat-container")||document.querySelector("[data-widget-messages]")||document.querySelector(".tradr-widget");return i&&(i.appendChild(s),setTimeout(()=>{i.scrollTop=i.scrollHeight},100)),e.element=s,s}scheduleProgressiveUpdates(e){const t=this.progressiveMessages[e.type]||this.progressiveMessages["/chat"];Object.entries(t).forEach(([t,n])=>{const s=setTimeout(()=>{this.activeIndicators.has(e.id)&&this.updateMessage(e,n)},parseInt(t));e.timers.push(s)});const n=setTimeout(()=>{this.activeIndicators.has(e.id)&&this.showTimer(e)},2e3);e.timers.push(n)}setupTimeoutHandler(e){const t=setTimeout(()=>{this.activeIndicators.has(e.id)&&!e.timedOut&&(e.timedOut=!0,this.updateMessage(e,"❌ Request timed out - Click to retry"),e.element&&this.addRetryButton(e),e.onTimeout&&e.onTimeout(e.id))},e.timeoutMs);e.timeoutHandler=t,e.timers.push(t)}addRetryButton(e){const t=document.createElement("button");t.className="tlw-thinking-retry-btn",t.innerHTML="🔄 Retry",t.style.cssText="\n      margin-left: 10px;\n      padding: 4px 12px;\n      background: #4CAF50;\n      color: white;\n      border: none;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 14px;\n    ",t.addEventListener("click",()=>{this.stopThinking(e.id),e.onTimeout&&e.onTimeout(e.id,!0)});const n=e.element?.querySelector(".tlw-thinking-message");n&&n.appendChild(t)}updateMessage(e,t){if(!e.element)return;const n=e.element.querySelector(".tlw-thinking-message");n&&(n.style.opacity="0.5",setTimeout(()=>{n.textContent=t,n.style.opacity="1"},200))}showTimer(e){if(!e.element)return;const t=e.element.querySelector(".tlw-thinking-timer");if(!t)return;if("/chat"===e.type)return;t.style.display="flex";const n=()=>{if(!this.activeIndicators.has(e.id))return;const s=Math.floor((Date.now()-e.startTime)/1e3),i=t.querySelector(".tlw-timer-text");i&&(i.textContent=`${s}s`),this.activeIndicators.has(e.id)&&setTimeout(n,1e3)};n()}startProgressBar(e){if(!e.element)return;const t=e.element.querySelector(".tlw-progress-fill");if(!t)return;t.style.transition="width 30s linear",t.style.width="100%";const n=setTimeout(()=>{this.activeIndicators.has(e.id)&&(t.style.transition="opacity 0.5s ease-in-out",t.style.animation="pulse 1s ease-in-out infinite")},3e4);e.timers.push(n)}static getContextualMessage(e,t="start"){return{sendMessage:{start:"💭 Sending message...",processing:"🤖 AI is thinking..."},generateScenario:{start:"🚀 Initiating scenario generation...",processing:"🔨 Building your trading model..."},executeTemplate:{start:"📝 Loading template...",processing:"✨ Generating from template..."},runEvaluation:{start:"📊 Starting evaluation...",processing:"📈 Processing market data..."},runBacktest:{start:"⏮️ Initializing backtest...",processing:"💰 Calculating performance..."}}[e]?.[t]||"⏳ Processing..."}stopAll(){Array.from(this.activeIndicators.keys()).forEach(e=>this.stopThinking(e))}getActiveCount(){return this.activeIndicators.size}isActive(e){return this.activeIndicators.has(e)}}class de{constructor(){this.nodeWidth=400,this.nodeHeight=400,this.flowDirection="LR"}parseAiDag(e,t,n={}){if(!e||!Array.isArray(e)||0===e.length)throw new Error("Invalid or empty DAG blocks");const s=this.createFunctionsMap(t),i=[],r=[];return e.forEach((e,t)=>{const n=this.createNode(e,s);i.push(n)}),e.forEach((t,n)=>{const a=this.buildDataConnectionEdges(t,e,s,i);r.push(...a)}),{nodes:i,edges:r,scenarioId:n.scenarioId,version:n.version||1}}createFunctionsMap(e){const t={};return e&&Array.isArray(e)&&e.forEach(e=>{e.name&&(t[e.name]=e),e.function_name&&e.function_name!==e.name&&(t[e.function_name]=e)}),t}createNode(e,t){const n=t[e.function_name]||t[e.function],s=this.extractInputs(n,e),i=this.extractOutputs(n,e),r=this.extractOptions(n,e),a={mainType:"function",type:"function",group:n.grouping,name:n.name,description:n.description,inputs:s,outputs:i,options:r,blockId:n.bid_,candleOptions:[{value:"bearish",label:"Bearish"},{value:"bullish",label:"Bullish"}],priceOptions:[{value:"open",label:"Open"},{value:"high",label:"High"},{value:"low",label:"Low"},{value:"close",label:"Close"}],values:this.extractValues(e,n),version:n.version_};return{id:`node${e.BlockID}`,type:"customNode",data:a,position:{x:0,y:0},targetPosition:"left",sourcePosition:"right"}}extractInputs(e,t){const n=[];if(e?.inputs?.properties)for(const t in e.inputs.properties)e.inputs.properties.hasOwnProperty(t)&&n.push({name:t});return n}extractOutputs(e,t){const n=[];if(t.outputs&&Array.isArray(t.outputs))t.outputs.forEach(e=>{e&&n.push({name:e})});else if(e?.outputs?.properties)for(const t in e.outputs.properties)n.push({name:t});return n}extractOptions(e,t){const n=[];if(e?.parameters?.properties)for(const s in e.parameters.properties){const i=e.parameters.properties[s],r=t.parameters?.[s]||i.default;let a="input",o=[];i.enum&&(a="select",o=i.enum.map(e=>({value:e,label:e}))),n.push({field:s,value:r,type:a,enumOutputs:o.map(e=>e.value),isValid:!0})}return n}extractValues(e,t){const n=[];if(e.parameters)for(const t in e.parameters)n.push({field:t,value:e.parameters[t]});return n}buildDataConnectionEdges(e,t,n,s){const i=[];if(e.data)for(const n in e.data){const r=e.data[n];if(!r)continue;const a=r.toString().split(".");if(a.length>1){const r=a[0].replace("Block_",""),o=t.find(e=>e.BlockID==r);if(o){const t=s.find(t=>t.id===`node${e.BlockID}`);if(!t)continue;const c=o.outputs.indexOf(a[1]),l=t.data.inputs.indexOf(t.data.inputs.find(e=>e.name==n));if(c>=0&&l>=0){const t={id:`reactflow__edge-node${r}node${r}-output-${c}-node${e.BlockID}node${e.BlockID}-input-${l}`,source:`node${r}`,target:`node${e.BlockID}`,sourceHandle:`node${r}-output-${c<0?0:c}`,targetHandle:`node${e.BlockID}-input-${l<0?0:l}`};i.push(t)}}}}return i}transformToScenarioDto(e,t={}){const{nodes:n,edges:s}=e;return{Id:t.scenarioId,Name:t.name||`Widget Scenario ${t.scenarioId}`,UserId:t.userId,IsFromAiGenerator:!0,Nodes:n,Edges:s,Viewport:{X:0,Y:0,Zoom:1},CrossFilters:{},Version:e.version||1,IsActive:!0,ManuallyUpdated:!1,IsFromEditor:!1,GeneratingAiFlow:!1}}}class he{constructor(e,t,n,s=null){this.messageStore=e,this.apiClient=t,this.thinkingManager=n,this.configManager=s,this.aiFlowParser=new de}async processModelMessage(e){try{const t=this.parseDagData(e.aiResponse);if(!t||!t.functions_list)throw new Error("Invalid DAG data received");const n=this.extractDagMetadata(t,e);this.messageStore.storeDagMetadata(n),e.scenarioId&&this.messageStore.addScenario(e.scenarioId,{status:"model_generated",dagRequestId:e.dagRequestId,dagMetadata:n,modelGeneratedAt:Date.now()}),await this.triggerEvaluation(e.scenarioId,e.dagRequestId,t)}catch(t){throw this.messageStore.addMessage({id:`dag-error-${Date.now()}`,type:"system",messageType:"Error",content:`❌ **Model Processing Failed**\n\n${t.message}\n\nPlease try generating the scenario again.`,timestamp:Date.now(),scenarioId:e.scenarioId}),t}}parseDagData(e){if(!e)throw new Error("No AI response data");if("string"==typeof e)try{return JSON.parse(e)}catch(e){throw new Error("Invalid JSON in AI response")}if("object"==typeof e)return e;throw new Error("Unexpected AI response format")}extractDagMetadata(e,t){const n=e.functions_list||[],s={scenarioId:t.scenarioId,dagRequestId:t.dagRequestId,nodeCount:n.length,indicators:[],conditions:[],triggers:[],others:[],timestamp:Date.now(),blocksDescription:e.blocks_description,subDags:e.sub_dags,metaDag:e.metadag||e.Metadag};return n.forEach(e=>{const t=this.categorizeNode(e),n=this.getNodeDescription(e);switch(t){case"indicator":s.indicators.push(n);break;case"condition":s.conditions.push(n);break;case"trigger":s.triggers.push(n);break;default:s.others.push(n)}}),s}categorizeNode(e){if(!e.function_name)return"other";const t=e.function_name.toLowerCase();return t.includes("sma")||t.includes("ema")||t.includes("rsi")||t.includes("macd")||t.includes("bollinger")||t.includes("stochastic")||t.includes("atr")||t.includes("adx")?"indicator":t.includes("condition")||t.includes("compare")||t.includes("threshold")||t.includes("cross")||t.includes("above")||t.includes("below")?"condition":t.includes("entry")||t.includes("exit")||t.includes("buy")||t.includes("sell")||t.includes("trigger")?"trigger":"other"}getNodeDescription(e){return e.display_name?e.display_name:e.function_name?e.function_name.replace(/_/g," ").replace(/([A-Z])/g," $1").toLowerCase().replace(/^\w/,e=>e.toUpperCase()):"Unknown Component"}async triggerEvaluation(e,t,n){const s=`eval-${e}`;this.thinkingManager.startThinking(s,"/execute",null,(s,i)=>{this.messageStore.addMessage({id:`timeout-${Date.now()}`,type:"system",messageType:"ExecutionError",content:"❌ **Execution Request Timed Out**\n\nThe AI engine did not respond within the expected time.\n\n"+(i?"Retrying...":"Click the retry button to try again."),timestamp:Date.now(),scenarioId:e}),i&&setTimeout(()=>{this.triggerEvaluation(e,`retry-${t}`,n)},1e3)},6e4);try{const t=this.getEvaluationParameters(),i=n.functions_list||[];if(!i||0===i.length)throw new Error("No DAG blocks found for execution");let r=this.configManager?.get("blocksData")?.blockDefinitions;if(!r){const e=await this.apiClient.loadBlocksData();if(!e.blockDefinitions)throw new Error(`Critical: No block definitions received from API. Got: ${JSON.stringify(e)}`);r=e.blockDefinitions}const a=this.aiFlowParser.parseAiDag(i,r,{scenarioId:e,version:1}),o=this.aiFlowParser.transformToScenarioDto(a,{scenarioId:e,userId:this.configManager?.get("userId"),name:`Widget Scenario ${e}`}),c=await this.apiClient.executeWidget(o,{scenarioId:e,symbol:t.symbol,intervalInMinutes:this.parseTimeframeToMinutes(t.timeframe)});return this.storeScenarioExecutionData(o,t),this.messageStore.updateMilestone("evaluate"),this.thinkingManager.stopThinking(s),this.handleEvaluationComplete({scenarioId:e,results:c,requestId:s}),c}catch(t){throw this.thinkingManager.stopThinking(s),this.messageStore.addMessage({id:`eval-error-${Date.now()}`,type:"system",messageType:"Error",content:`❌ **Evaluation Failed**\n\n${t.message}\n\nThe model was created successfully, but execution could not start.`,timestamp:Date.now(),scenarioId:e}),t}}storeScenarioExecutionData(e,t){this.configManager&&(this.configManager.set("scenarioData",e),this.configManager.set("defaultSymbol",t.symbol),this.configManager.set("defaultTimeframe",t.timeframe),this.configManager.set("weekDays",[1,2,3,4,5,6,7]),this.configManager.set("months",[1,2,3,4,5,6,7,8,9,10,11,12]),this.configManager.set("fromTime",t.fromTime||"08:00"),this.configManager.set("toTime",t.toTime||"20:00"),this.configManager.set("timeZone","Europe/London"),this.configManager.set("exchange","DUKASCOPY"))}getStoredDagData(e){if(!this.configManager)return null;const t=this.configManager.get("scenarioData");return t&&t.scenarioId===e?t:null}parseTimeframeToMinutes(e){if(!e||"string"!=typeof e)return 60;const t=e.toUpperCase();if(t.endsWith("M"))return parseInt(t.slice(0,-1))||5;if(t.endsWith("H"))return 60*(parseInt(t.slice(0,-1))||1);if(t.endsWith("D"))return 1440*(parseInt(t.slice(0,-1))||1);const n=parseInt(e);return isNaN(n)?60:n}getEvaluationParameters(){const e=this.getConfigValue("defaultLookbackDays",365),t=new Date,n=new Date;return n.setDate(t.getDate()-e),{symbol:this.getConfigValue("defaultSymbol","EURUSD"),timeframe:this.getConfigValue("defaultTimeframe","1H"),fromDate:n.toISOString().split("T")[0],toDate:t.toISOString().split("T")[0],initialCapital:this.getConfigValue("defaultInitialCapital",1e4),riskPercentage:this.getConfigValue("defaultRiskPercentage",2),commission:this.getConfigValue("defaultCommission",1e-4)}}getConfigValue(e,t){if(this.configManager&&"function"==typeof this.configManager.get){const t=this.configManager.get(e);if(null!=t)return t}return{defaultSymbol:"EURUSD",defaultTimeframe:"1H",defaultLookbackDays:365,defaultInitialCapital:1e4,defaultRiskPercentage:2,defaultCommission:1e-4,externalUserId:"widget-user-default"}[e]||t}getSocketId(){return`socket-${Date.now()}`}handleEvaluationComplete(e){const{scenarioId:t,results:n,requestId:s}=e;s?this.thinkingManager.stopThinking(s):this.thinkingManager.stopThinking(`eval-${t}`),this.messageStore.updateMilestone("analyze");const i=n.totalRecords,r=`Execution has run. We found **${i}** true occurrences of your model.`;let a;this.messageStore.addMessage({id:`exec-complete-${Date.now()}`,type:"system",messageType:"ExecutionComplete",content:r,timestamp:Date.now(),scenarioId:t,metadata:{occurrences:i,results:n}}),a=i>0?"📊 **Analysis Details**\n\n💡 You can now:\n• Ask questions about the results\n• Analyze specific patterns\n• Review the trading signals":"⚠️ **No Occurrences Found**\n\n💡 This could mean:\n• The market conditions weren't met\n• You might want to adjust parameters\n• Try a different time period",this.messageStore.addMessage({id:`eval-complete-${Date.now()}`,type:"system",messageType:"EvaluationComplete",content:a,timestamp:Date.now(),scenarioId:t,metadata:{occurrences:i,results:n,evaluationRequestId:s}}),this.messageStore.addScenario(t,{status:"evaluated",evaluationResults:n,evaluatedAt:Date.now()})}handleEvaluationError(e){const{scenarioId:t,error:n,requestId:s}=e;s?this.thinkingManager.stopThinking(s):this.thinkingManager.stopThinking(`eval-${t}`),this.messageStore.addMessage({id:`eval-error-${Date.now()}`,type:"system",messageType:"Error",content:`❌ **Evaluation Failed**\n\n${n}\n\nThe model was created successfully, but evaluation encountered an error. You can try asking questions or running a backtest manually.`,timestamp:Date.now(),scenarioId:t})}}class ge{constructor(e,t,n){this.messageStore=e,this.apiClient=t,this.thinkingManager=n,this.listeners=[],this.pendingRequests=new Map}getAvailableActions(){const e=[],t=this.messageStore.getCurrentAvailableActions();this.messageStore.getMilestoneStatus();return t.showGenerateButton&&e.push({id:"generate-scenario",label:"🚀 Generate Scenario",description:"Build your trading model",action:()=>this.handleGenerateScenario(),primary:!0,visible:!0,disabled:!1}),t.showRedrawButton&&e.push({id:"redraw-scenario",label:"🔄 Redraw Scenario",description:"Regenerate with same prompt",action:()=>this.handleRedrawScenario(),primary:!1,visible:!0,disabled:!1}),t.showBacktestButton&&e.push({id:"run-backtest",label:"📊 Run Backtest",description:"Test strategy performance",action:()=>this.handleRunBacktest(),primary:!0,visible:!0,disabled:!1}),t.enableAnalysis&&e.push({id:"ask-question",label:"💭 Ask Question",description:"Analyze your results",action:()=>this.handleAskQuestion(),primary:!1,visible:!0,disabled:!1}),e}async handleGenerateScenario(e){if(!e)throw new Error("ActionManager: No message provided for scenario generation");const t=`query-${Date.now()}`;this.thinkingManager.startThinking(t,"/query",null,(e,t)=>{this.messageStore.addMessage({id:`dag-timeout-${Date.now()}`,type:"system",messageType:"Error",content:"❌ **Model Generation Timed Out**\n\nThe AI engine did not respond within the expected time.\n\n"+(t?"Retrying...":"Please try generating the model again or simplify your request."),timestamp:Date.now()}),t&&setTimeout(()=>{this.handleGenerateScenario()},1e3)},9e4);try{let n=e.aiResponse||e.message||e.content;if(!n||!n.trim())throw new Error("ActionManager: Message has no content for scenario generation");const s=this.messageStore.getCurrentSessionId();try{return await this.apiClient.generateScenario({conversationContext:n,sessionId:s,socketId:this.getSocketId()})}catch(e){throw this.thinkingManager.stopThinking(t),e.message.includes("ScenarioId is required")?new Error("Please send at least one chat message before generating a scenario. The system needs conversation context to create your trading model."):e.message.includes("SessionId")?new Error("Please wait for the previous message to complete before generating a scenario."):e}}catch(e){throw this.thinkingManager.stopThinking(t),e}}async handleRedrawScenario(){const e=this.messageStore.getLastRelevantMessage();if(!e?.userDagRequestId)throw new Error("No DAG request ID found for redraw");try{const t=`redraw-${Date.now()}`;this.thinkingManager.startThinking(t,"/query");return await this.apiClient.get(`/api/widget/dag/redraw/${e.userDagRequestId}/${this.getSocketId()}/${e.scenarioId}`)}catch(e){throw e}}async handleRunBacktest(){const e=this.getCurrentScenario();if(!e)throw new Error("No active scenario for backtest");try{const t=`backtest-${Date.now()}`;this.thinkingManager.startThinking(t,"backtest","📊 Starting backtest...");const n=await this.apiClient.post("/api/widget/backtest",{scenarioId:e.id,externalUserId:this.getExternalUserId(),socketId:this.getSocketId()});return this.messageStore.updateMilestone("backtest"),n}catch(e){throw e}}handleAskQuestion(){this.notifyListeners("action:ask-question",{scenario:this.getCurrentScenario()})}async sendAnalysisQuestion(e){const t=this.getCurrentScenario();if(!t)throw new Error("No active scenario for analysis");try{const n=`analysis-${Date.now()}`;this.thinkingManager.startThinking(n,"analysis");const s=this.messageStore.getCurrentSessionId();if(!s)throw new Error("ActionManager: No SessionId available for analysis - requires previous chat messages");return await this.apiClient.post("/api/widget/analysis",{scenarioId:t.id,question:e,externalUserId:this.getExternalUserId(),sessionId:s,socketId:this.getSocketId()})}catch(e){throw this.thinkingManager.stopThinking(requestId),e}}getCurrentScenario(){const e=Array.from(this.messageStore.scenarios.values());return e.find(e=>e.id===this.messageStore.activeScenarioId)||e[e.length-1]}generateId(){return Math.floor(Date.now()/1e3).toString(16).padStart(8,"0")+Array.from({length:16},()=>Math.floor(16*Math.random()).toString(16)).join("")}getExternalUserId(){return"widget-user-"+Date.now()}getSocketId(){return"socket-"+Date.now()}on(e,t){this.listeners.push({event:e,callback:t})}notifyListeners(e,t){this.listeners.filter(t=>t.event===e).forEach(e=>e.callback(t))}areActionsDisabled(){return this.thinkingManager.getActiveCount()>0}getAction(e){return this.getAvailableActions().find(t=>t.id===e)}async executeAction(e,...t){const n=this.getAction(e);if(!n)throw new Error(`Action ${e} not found`);if(n.disabled)throw new Error(`Action ${e} is disabled`);return await n.action(...t)}}class ue{constructor(e,t,n,s,i){this.element=e,this.config=t,this.messageStore=n,this.apiClient=s,this.signalRClient=i,this.messagesContainer=null,this.inputContainer=null,this.inputField=null,this.sendButton=null,this.unsubscribe=null}render(){this.element.innerHTML=`\n      <div class="tradr-widget-container">\n        <div class="tradr-widget-header">\n          <h3>TradrLab Assistant</h3>\n          ${this.config.get("enableFontSizeControl")?'\n            <div class="tradr-widget-controls">\n              <button class="tradr-font-size-btn" data-action="decrease">A-</button>\n              <button class="tradr-font-size-btn" data-action="increase">A+</button>\n            </div>\n          ':""}\n        </div>\n        \n        <div class="tradr-widget-messages" id="messages-container">\n          \x3c!-- Messages will be rendered here --\x3e\n        </div>\n        \n        <div class="tradr-widget-input">\n          ${this.config.get("allowImageUpload")?'\n            <button class="tradr-attach-btn" title="Attach image">\n              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">\n                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>\n              </svg>\n              <input type="file" accept="image/*" style="display: none;" />\n            </button>\n          ':""}\n          \n          <textarea \n            class="tradr-widget-input-field" \n            placeholder="${this.config.get("placeholder")}"\n            rows="1"\n          ></textarea>\n          \n          <button class="tradr-send-btn" title="Send message">\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">\n              <line x1="22" y1="2" x2="11" y2="13"></line>\n              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>\n            </svg>\n          </button>\n        </div>\n      </div>\n    `,this.messagesContainer=this.element.querySelector("#messages-container"),this.element.style.cssText="display: block !important; visibility: visible !important; position: relative !important; width: 100% !important; height: 400px !important; background: pink !important; border: 5px solid green !important;",this.messagesContainer&&(this.messagesContainer.style.cssText="display: block !important; visibility: visible !important; height: 300px !important; background: lightblue !important; border: 3px solid purple !important; overflow-y: auto !important;"),this.inputField=this.element.querySelector(".tradr-widget-input-field"),this.sendButton=this.element.querySelector(".tradr-send-btn"),this.setupEventListeners(),this.messageStore&&"function"==typeof this.messageStore.subscribe&&(this.unsubscribe=this.messageStore.subscribe(e=>{this.handleStoreUpdate(e)})),this.renderMessages()}setupEventListeners(){if(this.sendButton.addEventListener("click",()=>this.sendMessage()),this.inputField.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())}),this.inputField.addEventListener("input",()=>{this.autoResizeInput()}),this.config.get("allowImageUpload")){const e=this.element.querySelector('input[type="file"]');this.element.querySelector(".tradr-attach-btn").addEventListener("click",()=>e.click()),e.addEventListener("change",e=>this.handleImageUpload(e))}this.config.get("allowImagePaste")&&this.inputField.addEventListener("paste",e=>this.handlePaste(e)),this.config.get("enableFontSizeControl")&&this.element.querySelectorAll(".tradr-font-size-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.action;this.adjustFontSize(t)})}),this.messagesContainer.addEventListener("click",e=>{const t=e.target.closest("[data-action]");if(t){const e=t.dataset.action,n=t.dataset.scenarioId;this.handleMessageAction(e,n,t)}})}handleStoreUpdate(e){switch(e.action){case"add":case"message:add":this.addMessageToUI(e.data);break;case"update":case"message:update":this.updateMessageInUI(e.data);break;case"remove":case"message:remove":this.removeMessageFromUI(e.data.id);break;case"clear":case"store:clear":this.clearMessages()}}async handleMessageAction(e,t,n){try{n.disabled=!0;const s=n.textContent;switch(n.textContent="Processing...",e){case"retry-execution":await this.handleRetryExecution(t);break;case"ask-question":this.handleAskQuestion(t);break;case"retry":await this.handleGenericRetry()}n.disabled=!1,n.textContent=s}catch(t){n.disabled=!1,n.textContent=originalText,this.showActionError(e,t)}}async handleRetryExecution(e){const t=this.element.closest(".tradr-widget")?.widgetInstance;if(!t||!t.retryExecution)throw new Error("Widget instance not found or retry method not available");await t.retryExecution(e)}handleAskQuestion(e){const t=this.element.closest(".tradr-widget")?.widgetInstance;t&&t.showAnalysisInput&&t.showAnalysisInput({id:e})}async handleGenericRetry(){throw new Error("Generic retry not implemented yet")}showActionError(e,t){this.messageStore.addMessage({id:`action-error-${Date.now()}`,type:"error",messageType:"Error",content:`❌ **${e} Failed**\n\n${t.message}\n\nPlease try again or contact support.`,timestamp:Date.now()})}renderMessages(){const e=this.messageStore.getMessages();this.messagesContainer.innerHTML="",e.forEach(e=>{this.addMessageToUI(e,!1)}),this.scrollToBottom()}addMessageToUI(e,t=!0){const n=document.createElement("div");n.style.cssText="border: 3px solid red; padding: 20px; margin: 10px; background: yellow; color: black; font-size: 16px; width: 100%;",n.textContent=`${e.type}: ${e.content}`,this.messagesContainer.appendChild(n)}renderMessageContent(e){return this.escapeHtml(e.content||"")}updateMessageInUI(e){const t=this.messagesContainer.querySelector(`[data-message-id="${e.id}"]`);t&&(t.querySelector(".tradr-message-bubble").innerHTML=this.renderMessageContent(e))}removeMessageFromUI(e){const t=this.messagesContainer.querySelector(`[data-message-id="${e}"]`);t&&t.remove()}clearMessages(){this.messagesContainer.innerHTML=""}async sendMessage(){const e=this.inputField.value.trim();if(!e)return;this.inputField.value="",this.autoResizeInput();const t={type:"user",content:e};this.messageStore.addMessage(t);const n=this.messageStore.addMessage({type:"loading",content:""}).id;try{const t=await this.apiClient.sendMessage(e);this.messageStore.removeMessage(n),t&&t.length>0&&t.forEach(e=>{this.messageStore.addMessage({type:"assistant",...e})})}catch(e){this.messageStore.removeMessage(n),this.messageStore.addMessage({type:"error",content:"Failed to send message. Please try again."})}}async handleImageUpload(e){const t=e.target.files[0];if(t)try{const e=await this.apiClient.uploadImage(t),n=this.config.get("onImageUploaded");n&&n(e)}catch(e){}}handlePaste(e){const t=e.clipboardData?.items;if(t)for(const n of t)if(-1!==n.type.indexOf("image")){const t=n.getAsFile();t&&(e.preventDefault(),this.handleImageUpload({target:{files:[t]}}))}}autoResizeInput(){this.inputField.style.height="auto",this.inputField.style.height=Math.min(this.inputField.scrollHeight,120)+"px"}adjustFontSize(e){const t=parseInt(getComputedStyle(this.messagesContainer).fontSize),n="increase"===e?t+2:t-2;n>=12&&n<=24&&(this.messagesContainer.style.fontSize=n+"px")}scrollToBottom(){this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}destroy(){this.unsubscribe&&this.unsubscribe(),this.element.innerHTML=""}}class pe{constructor(e,t={}){this.container=e,this.options={onSelection:t.onSelection||(()=>{}),onTemplateRequest:t.onTemplateRequest||(()=>{}),onWizardRequest:t.onWizardRequest||(()=>{}),showBranding:!1!==t.showBranding,...t},this.isVisible=!1,this.templates=[],this.init()}init(){this.container.innerHTML=this.render(),this.attachEventListeners()}render(){return`\n      <div class="tlw-landing" data-testid="landing-page">\n        ${this.renderHeader()}\n        ${this.renderCards()}\n        ${this.renderFooter()}\n      </div>\n    `}renderHeader(){return`\n      <div class="tlw-landing-header">\n        ${this.options.showBranding?'\n          <div class="tlw-branding">\n            <span class="tlw-logo">📈</span>\n            <h1 class="tlw-title">TradrLab</h1>\n          </div>\n        ':""}\n        <h2 class="tlw-subtitle">What would you like to build today?</h2>\n        <p class="tlw-description">\n          Create and test trading scenarios using AI-powered analysis\n        </p>\n      </div>\n    `}renderCards(){return`\n      <div class="tlw-cards">\n        ${this.renderCard({action:"help",icon:"🤖",title:"Help me get started",description:"AI-guided scenario creation",subtitle:"Interactive journey",color:"blue"})}\n        \n        ${this.renderCard({action:"templates",icon:"📋",title:"View Templates",description:"Pre-built trading scenarios",subtitle:"Quick start",color:"green"})}\n        \n        ${this.renderCard({action:"scratch",icon:"✨",title:"Build from Scratch",description:"Custom scenario creation",subtitle:"Advanced users",color:"purple"})}\n        \n        ${this.renderCard({action:"wizard",icon:"🔧",title:"Scenario Builder",description:"Step-by-step guided creation",subtitle:"Structured approach",color:"orange"})}\n      </div>\n    `}renderCard({action:e,icon:t,title:n,description:s,subtitle:i,color:r}){return`\n      <div class="tlw-card tlw-card--${r}" data-action="${e}" data-testid="card-${e}">\n        <div class="tlw-card-icon">${t}</div>\n        <div class="tlw-card-content">\n          <h3 class="tlw-card-title">${n}</h3>\n          <p class="tlw-card-description">${s}</p>\n          <span class="tlw-card-subtitle">${i}</span>\n        </div>\n        <div class="tlw-card-arrow">→</div>\n      </div>\n    `}renderFooter(){return'\n      <div class="tlw-landing-footer">\n        <p class="tlw-help-text">\n          Need help? <a href="#" class="tlw-help-link" data-action="help-docs">View documentation</a>\n        </p>\n        <div class="tlw-version">\n          Widget v2.0.0\n        </div>\n      </div>\n    '}attachEventListeners(){this.container.querySelectorAll(".tlw-card").forEach(e=>{e.addEventListener("click",t=>{const n=e.dataset.action;this.handleCardClick(n,t)}),e.addEventListener("mouseenter",()=>{e.classList.add("tlw-card--hover")}),e.addEventListener("mouseleave",()=>{e.classList.remove("tlw-card--hover")})});const e=this.container.querySelector(".tlw-help-link");e&&e.addEventListener("click",e=>{e.preventDefault(),this.handleHelpRequest()}),this.container.addEventListener("keydown",e=>{this.handleKeyNavigation(e)})}handleCardClick(e,t){const n=t.currentTarget;switch(n.classList.add("tlw-card--clicked"),setTimeout(()=>n.classList.remove("tlw-card--clicked"),150),e){case"help":this.handleHelpSelection();break;case"templates":this.handleTemplatesSelection();break;case"scratch":this.handleScratchSelection();break;case"wizard":this.handleWizardSelection()}}handleHelpSelection(){this.options.onSelection({type:"message",content:"I need help expressing my idea as a testable trading scenario. Can you guide me through the process?",journeyType:"interactive"}),this.hide()}handleTemplatesSelection(){this.options.onTemplateRequest()}handleScratchSelection(){this.options.onSelection({type:"message",content:"I want to build a custom trading scenario from scratch.",journeyType:"interactive"}),this.hide()}handleWizardSelection(){this.options.onWizardRequest()}handleHelpRequest(){this.options.onSelection({type:"message",content:"Can you explain how to use this trading scenario builder?",journeyType:"interactive"}),this.hide()}handleKeyNavigation(e){const t=Array.from(this.container.querySelectorAll(".tlw-card")),n=this.container.querySelector(".tlw-card:focus");let s=n?t.indexOf(n):-1;switch(e.key){case"ArrowRight":case"ArrowDown":e.preventDefault(),s=(s+1)%t.length,t[s].focus();break;case"ArrowLeft":case"ArrowUp":e.preventDefault(),s=s<=0?t.length-1:s-1,t[s].focus();break;case"Enter":case" ":n&&(e.preventDefault(),n.click())}}show(){if(!this.isVisible){this.container.style.display="block",this.container.classList.add("tlw-landing--visible"),this.isVisible=!0;const e=this.container.querySelector(".tlw-card");e&&(e.setAttribute("tabindex","0"),e.focus()),setTimeout(()=>{this.container.classList.add("tlw-landing--animated")},10)}}hide(){this.isVisible&&(this.container.classList.remove("tlw-landing--visible","tlw-landing--animated"),setTimeout(()=>{this.container.style.display="none",this.isVisible=!1},300))}updateTemplates(e){this.templates=e||[];const t=this.container.querySelector('[data-action="templates"]');if(t){const e=t.querySelector(".tlw-card-description");e&&(e.textContent=`${this.templates.length} pre-built scenarios available`)}}destroy(){this.container&&(this.container.innerHTML=""),this.isVisible=!1,this.templates=[]}isShown(){return this.isVisible}}class me{constructor(e={}){this.options={templates:e.templates||[],onSelect:e.onSelect||(()=>{}),onClose:e.onClose||(()=>{}),apiClient:e.apiClient,showCategories:!1!==e.showCategories,...e},this.templates=this.options.templates,this.filteredTemplates=[...this.templates],this.selectedCategory="all",this.searchQuery="",this.isVisible=!1,this.isLoading=!1,this.modal=null,this.backdrop=null,this.init()}init(){this.createModal(),this.loadTemplates()}createModal(){this.backdrop=document.createElement("div"),this.backdrop.className="tlw-modal-backdrop",this.backdrop.addEventListener("click",e=>{e.target===this.backdrop&&this.hide()}),this.modal=document.createElement("div"),this.modal.className="tlw-template-modal",this.modal.innerHTML=this.render(),this.backdrop.appendChild(this.modal),document.body.appendChild(this.backdrop),this.attachEventListeners()}render(){return`\n      <div class="tlw-modal-header">\n        <h2 class="tlw-modal-title">\n          <span class="tlw-modal-icon">📋</span>\n          Trading Scenario Templates\n        </h2>\n        <button class="tlw-modal-close" data-action="close" aria-label="Close">\n          <span>&times;</span>\n        </button>\n      </div>\n      \n      <div class="tlw-modal-body">\n        ${this.renderFilters()}\n        ${this.renderTemplateGrid()}\n      </div>\n      \n      <div class="tlw-modal-footer">\n        <div class="tlw-template-count">\n          <span id="template-count">${this.filteredTemplates.length}</span> templates available\n        </div>\n        <div class="tlw-modal-actions">\n          <button class="tlw-btn tlw-btn--secondary" data-action="close">\n            Cancel\n          </button>\n        </div>\n      </div>\n    `}renderFilters(){return this.options.showCategories||this.options.showSearch?`\n      <div class="tlw-filters">\n        ${!1!==this.options.showSearch?`\n          <div class="tlw-search-box">\n            <input \n              type="text" \n              class="tlw-search-input" \n              placeholder="Search templates..." \n              value="${this.searchQuery}"\n              data-action="search"\n            >\n            <span class="tlw-search-icon">🔍</span>\n          </div>\n        `:""}\n        \n        ${this.options.showCategories?`\n          <div class="tlw-category-filters">\n            ${this.renderCategoryFilters()}\n          </div>\n        `:""}\n      </div>\n    `:""}renderCategoryFilters(){return["all",...this.extractCategories()].map(e=>`\n      <button \n        class="tlw-category-btn ${this.selectedCategory===e?"active":""}"\n        data-action="filter-category"\n        data-category="${e}"\n      >\n        ${"all"===e?"All":e}\n        ${"all"!==e?`<span class="tlw-category-count">${this.getTemplateCountByCategory(e)}</span>`:""}\n      </button>\n    `).join("")}renderTemplateGrid(){return this.isLoading?'\n        <div class="tlw-loading-state">\n          <div class="tlw-spinner"></div>\n          <p>Loading templates...</p>\n        </div>\n      ':0===this.filteredTemplates.length?this.renderEmptyState():`\n      <div class="tlw-template-grid" id="template-grid">\n        ${this.filteredTemplates.map(e=>this.renderTemplateCard(e)).join("")}\n      </div>\n    `}renderTemplateCard(e){const t=e.difficulty||"intermediate",n=e.category||"Custom";return`\n      <div class="tlw-template-card" data-template-id="${e.id}" data-action="select-template">\n        <div class="tlw-template-header">\n          <h3 class="tlw-template-title">${e.name}</h3>\n          <div class="tlw-template-badges">\n            <span class="tlw-template-category">${n}</span>\n            <span class="tlw-template-difficulty tlw-template-difficulty--${t}">\n              ${t}\n            </span>\n          </div>\n        </div>\n        \n        <div class="tlw-template-content">\n          <p class="tlw-template-description">\n            ${e.description||"No description available"}\n          </p>\n          \n          ${e.parameters?`\n            <div class="tlw-template-parameters">\n              <strong>Key Parameters:</strong>\n              <ul>\n                ${e.parameters.slice(0,3).map(e=>`<li>${e.name}: ${e.description}</li>`).join("")}\n                ${e.parameters.length>3?`<li>+${e.parameters.length-3} more...</li>`:""}\n              </ul>\n            </div>\n          `:""}\n          \n          ${e.tags&&e.tags.length>0?`\n            <div class="tlw-template-tags">\n              ${e.tags.slice(0,4).map(e=>`<span class="tlw-tag">${e}</span>`).join("")}\n            </div>\n          `:""}\n        </div>\n        \n        <div class="tlw-template-footer">\n          <div class="tlw-template-stats">\n            ${e.popularity?`\n              <span class="tlw-template-stat">\n                <span class="tlw-stat-icon">⭐</span>\n                ${e.popularity}\n              </span>\n            `:""}\n            ${e.successRate?`\n              <span class="tlw-template-stat">\n                <span class="tlw-stat-icon">📈</span>\n                ${e.successRate}% success\n              </span>\n            `:""}\n          </div>\n          <button class="tlw-btn tlw-btn--primary tlw-template-select" data-template-id="${e.id}">\n            Select Template\n          </button>\n        </div>\n      </div>\n    `}renderEmptyState(){return`\n      <div class="tlw-empty-state">\n        <div class="tlw-empty-icon">📭</div>\n        <h3>No Templates Found</h3>\n        <p>${this.searchQuery?`No templates found matching "${this.searchQuery}"`:"all"!==this.selectedCategory?`No templates found in "${this.selectedCategory}" category`:"No templates available"}</p>\n        ${this.searchQuery||"all"!==this.selectedCategory?'\n          <button class="tlw-btn tlw-btn--secondary" data-action="clear-filters">\n            Clear Filters\n          </button>\n        ':""}\n      </div>\n    `}attachEventListeners(){this.modal.querySelectorAll('[data-action="close"]').forEach(e=>{e.addEventListener("click",()=>this.hide())});const e=this.modal.querySelector('[data-action="search"]');e&&e.addEventListener("input",e=>{this.handleSearch(e.target.value)}),this.modal.querySelectorAll('[data-action="filter-category"]').forEach(e=>{e.addEventListener("click",e=>{const t=e.target.dataset.category;this.handleCategoryFilter(t)})}),this.modal.addEventListener("click",e=>{if(e.target.matches('[data-action="select-template"], [data-action="select-template"] *')){const t=e.target.closest(".tlw-template-card");if(t){const e=t.dataset.templateId;this.handleTemplateSelect(e)}}}),this.modal.addEventListener("click",e=>{e.target.matches('[data-action="clear-filters"]')&&this.clearFilters()}),this.modal.addEventListener("keydown",e=>this.handleKeyNavigation(e)),this.modal.addEventListener("click",e=>{e.stopPropagation()})}handleSearch(e){this.searchQuery=e.toLowerCase(),this.filterTemplates(),this.updateTemplateGrid()}handleCategoryFilter(e){this.selectedCategory=e,this.modal.querySelectorAll(".tlw-category-btn").forEach(t=>{t.classList.toggle("active",t.dataset.category===e)}),this.filterTemplates(),this.updateTemplateGrid()}handleTemplateSelect(e){const t=this.templates.find(t=>t.id===e);if(t){const n=this.modal.querySelector(`[data-template-id="${e}"]`);n&&n.classList.add("tlw-template-card--selected"),setTimeout(()=>{this.options.onSelect(t),this.hide()},300)}}clearFilters(){this.searchQuery="",this.selectedCategory="all";const e=this.modal.querySelector('[data-action="search"]');e&&(e.value=""),this.modal.querySelectorAll(".tlw-category-btn").forEach(e=>{e.classList.toggle("active","all"===e.dataset.category)}),this.filterTemplates(),this.updateTemplateGrid()}filterTemplates(){this.filteredTemplates=this.templates.filter(e=>("all"===this.selectedCategory||e.category===this.selectedCategory)&&!(this.searchQuery&&!this.matchesSearch(e)))}matchesSearch(e){return[e.name,e.description,e.category,...e.tags||[],...(e.parameters||[]).map(e=>e.name+" "+e.description)].join(" ").toLowerCase().includes(this.searchQuery)}updateTemplateGrid(){const e=this.modal.querySelector(".tlw-modal-body");e&&(e.innerHTML=this.renderFilters()+this.renderTemplateGrid(),this.attachEventListeners());const t=this.modal.querySelector("#template-count");t&&(t.textContent=this.filteredTemplates.length)}handleKeyNavigation(e){switch(e.key){case"Escape":this.hide();break;case"Enter":if(e.target.matches(".tlw-template-card")){const t=e.target.dataset.templateId;this.handleTemplateSelect(t)}}}extractCategories(){const e=new Set(this.templates.map(e=>e.category).filter(Boolean));return Array.from(e).sort()}getTemplateCountByCategory(e){return this.templates.filter(t=>t.category===e).length}async loadTemplates(){if(this.templates.length>0)this.filterTemplates();else{if(!this.options.apiClient)return this.templates=this.getDefaultTemplates(),this.filterTemplates(),void this.updateTemplateGrid();try{this.isLoading=!0,this.updateTemplateGrid();const e=await this.options.apiClient.get("/api/widget/templates");this.templates=e||[],this.filterTemplates()}catch(e){this.templates=this.getDefaultTemplates(),this.filterTemplates()}finally{this.isLoading=!1,this.updateTemplateGrid()}}}getDefaultTemplates(){return[{id:"breakout-volume",name:"Breakout with Volume",description:"Identify stocks breaking out of consolidation patterns with volume confirmation",category:"Technical Analysis",difficulty:"beginner",tags:["breakout","volume","momentum"],popularity:4.5,successRate:68,parameters:[{name:"Volume Threshold",description:"Minimum volume increase percentage"},{name:"Breakout Period",description:"Number of days for pattern analysis"},{name:"Price Change",description:"Minimum price movement percentage"}]},{id:"rsi-oversold",name:"RSI Oversold Recovery",description:"Find oversold stocks showing signs of reversal using RSI indicator",category:"Technical Analysis",difficulty:"intermediate",tags:["RSI","oversold","reversal"],popularity:4.2,successRate:72,parameters:[{name:"RSI Threshold",description:"Oversold RSI level (typically 30)"},{name:"Recovery Confirmation",description:"RSI bounce back requirement"}]},{id:"gap-up-follow-through",name:"Gap Up Follow-Through",description:"Stocks gapping up with strong follow-through momentum",category:"Price Action",difficulty:"intermediate",tags:["gap","momentum","follow-through"],popularity:3.8,successRate:65,parameters:[{name:"Gap Size",description:"Minimum gap percentage"},{name:"Volume Confirmation",description:"Required volume increase"}]},{id:"earnings-surprise",name:"Earnings Surprise Momentum",description:"Companies beating earnings expectations with price momentum",category:"Market Structure",difficulty:"advanced",tags:["earnings","surprise","fundamental"],popularity:4,successRate:75,parameters:[{name:"Surprise Threshold",description:"Minimum earnings beat percentage"},{name:"Price Response",description:"Required price movement post-earnings"}]}]}show(){this.isVisible||(this.backdrop.style.display="flex",document.body.classList.add("tlw-modal-open"),setTimeout(()=>{this.backdrop.classList.add("tlw-modal-backdrop--visible"),this.modal.classList.add("tlw-template-modal--visible")},10),this.isVisible=!0,setTimeout(()=>{const e=this.modal.querySelector('[data-action="search"]'),t=this.modal.querySelector(".tlw-template-card");e?e.focus():t&&t.focus()},100))}hide(){this.isVisible&&(this.backdrop.classList.remove("tlw-modal-backdrop--visible"),this.modal.classList.remove("tlw-template-modal--visible"),setTimeout(()=>{this.backdrop.style.display="none",document.body.classList.remove("tlw-modal-open"),this.isVisible=!1,this.options.onClose()},300))}updateTemplates(e){this.templates=e||[],this.filterTemplates(),this.updateTemplateGrid()}destroy(){this.backdrop&&this.backdrop.parentNode&&this.backdrop.parentNode.removeChild(this.backdrop),document.body.classList.remove("tlw-modal-open"),this.isVisible=!1}}class fe{constructor(e={}){this.options={onComplete:e.onComplete||(()=>{}),onClose:e.onClose||(()=>{}),showProgress:!1!==e.showProgress,...e},this.currentStep=0,this.answers={},this.isVisible=!1,this.modal=null,this.backdrop=null,this.steps=this.getWizardSteps(),this.init()}init(){this.createModal()}getWizardSteps(){return[{id:"pattern",title:"Trading Pattern",subtitle:"What pattern are you looking for?",type:"choice",options:[{value:"breakout",label:"Breakout",description:"Price breaking above resistance"},{value:"reversal",label:"Reversal",description:"Price changing direction"},{value:"momentum",label:"Momentum",description:"Continued price movement"},{value:"consolidation",label:"Consolidation",description:"Sideways price action"},{value:"gap",label:"Gap",description:"Price gaps up or down"},{value:"custom",label:"Custom Pattern",description:"I'll describe it myself"}]},{id:"direction",title:"Direction",subtitle:"What direction are you interested in?",type:"choice",options:[{value:"bullish",label:"Bullish",description:"Looking for upward movement"},{value:"bearish",label:"Bearish",description:"Looking for downward movement"},{value:"both",label:"Both Directions",description:"Either up or down"}]},{id:"symbols",title:"Assets",subtitle:"Which symbols/assets do you want to analyze?",type:"input",inputType:"text",placeholder:'e.g., AAPL, MSFT, SPY or "tech stocks" or "S&P 500"',validation:{required:!0,minLength:1}},{id:"timeframe",title:"Timeframe",subtitle:"What timeframe should we analyze?",type:"choice",options:[{value:"1min",label:"1 Minute",description:"Intraday scalping"},{value:"5min",label:"5 Minutes",description:"Short-term trading"},{value:"15min",label:"15 Minutes",description:"Day trading"},{value:"1hour",label:"1 Hour",description:"Swing trading setup"},{value:"4hour",label:"4 Hours",description:"Position trading"},{value:"1day",label:"Daily",description:"Long-term analysis"},{value:"weekly",label:"Weekly",description:"Major trend analysis"}]},{id:"indicators",title:"Technical Indicators",subtitle:"Which indicators would you like to include?",type:"multi-choice",optional:!0,options:[{value:"volume",label:"Volume",description:"Trading volume analysis"},{value:"rsi",label:"RSI",description:"Relative Strength Index"},{value:"macd",label:"MACD",description:"Moving Average Convergence Divergence"},{value:"bollinger",label:"Bollinger Bands",description:"Volatility bands"},{value:"sma",label:"Simple MA",description:"Simple Moving Averages"},{value:"ema",label:"Exponential MA",description:"Exponential Moving Averages"},{value:"stochastic",label:"Stochastic",description:"Momentum oscillator"},{value:"atr",label:"ATR",description:"Average True Range"}]},{id:"conditions",title:"Additional Conditions",subtitle:"Any specific conditions or requirements?",type:"input",inputType:"textarea",placeholder:'e.g., "minimum volume of 1M shares", "price above $50", "earnings within 30 days"...',optional:!0}]}createModal(){this.backdrop=document.createElement("div"),this.backdrop.className="tlw-modal-backdrop tlw-wizard-backdrop",this.backdrop.addEventListener("click",e=>{e.target===this.backdrop&&this.hide()}),this.modal=document.createElement("div"),this.modal.className="tlw-wizard-modal",this.modal.innerHTML=this.render(),this.backdrop.appendChild(this.modal),document.body.appendChild(this.backdrop),this.attachEventListeners()}render(){return`\n      <div class="tlw-wizard-header">\n        <div class="tlw-wizard-title">\n          <span class="tlw-wizard-icon">🔧</span>\n          <h2>Scenario Builder</h2>\n        </div>\n        <button class="tlw-modal-close" data-action="close" aria-label="Close">\n          <span>&times;</span>\n        </button>\n      </div>\n      \n      ${this.options.showProgress?this.renderProgress():""}\n      \n      <div class="tlw-wizard-body">\n        ${this.renderStep()}\n      </div>\n      \n      <div class="tlw-wizard-footer">\n        ${this.renderNavigation()}\n      </div>\n    `}renderProgress(){return`\n      <div class="tlw-wizard-progress">\n        <div class="tlw-progress-bar">\n          <div class="tlw-progress-fill" style="width: ${(this.currentStep+1)/this.steps.length*100}%"></div>\n        </div>\n        <div class="tlw-progress-text">\n          Step ${this.currentStep+1} of ${this.steps.length}\n        </div>\n      </div>\n    `}renderStep(){const e=this.steps[this.currentStep];return e?`\n      <div class="tlw-wizard-step" data-step="${e.id}">\n        <div class="tlw-step-header">\n          <h3 class="tlw-step-title">${e.title}</h3>\n          <p class="tlw-step-subtitle">${e.subtitle}</p>\n          ${e.optional?'<span class="tlw-optional-badge">Optional</span>':""}\n        </div>\n        \n        <div class="tlw-step-content">\n          ${this.renderStepInput(e)}\n        </div>\n      </div>\n    `:""}renderStepInput(e){switch(e.type){case"choice":return this.renderChoiceInput(e);case"multi-choice":return this.renderMultiChoiceInput(e);case"input":return this.renderTextInput(e);default:return""}}renderChoiceInput(e){return`\n      <div class="tlw-choice-grid">\n        ${e.options.map(t=>`\n          <div class="tlw-choice-option ${this.answers[e.id]===t.value?"selected":""}" \n               data-value="${t.value}" \n               data-action="select-choice">\n            <div class="tlw-choice-label">${t.label}</div>\n            <div class="tlw-choice-description">${t.description}</div>\n          </div>\n        `).join("")}\n      </div>\n    `}renderMultiChoiceInput(e){const t=this.answers[e.id]||[];return`\n      <div class="tlw-multi-choice-grid">\n        ${e.options.map(e=>`\n          <label class="tlw-checkbox-option ${t.includes(e.value)?"selected":""}">\n            <input type="checkbox" \n                   value="${e.value}" \n                   data-action="toggle-choice"\n                   ${t.includes(e.value)?"checked":""}>\n            <div class="tlw-checkbox-content">\n              <div class="tlw-checkbox-label">${e.label}</div>\n              <div class="tlw-checkbox-description">${e.description}</div>\n            </div>\n            <div class="tlw-checkbox-indicator">✓</div>\n          </label>\n        `).join("")}\n      </div>\n    `}renderTextInput(e){const t=this.answers[e.id]||"";return"textarea"===e.inputType?`\n        <textarea \n          class="tlw-wizard-textarea" \n          placeholder="${e.placeholder||""}"\n          data-action="input-change"\n          rows="4"\n        >${t}</textarea>\n      `:`\n      <input \n        type="text" \n        class="tlw-wizard-input" \n        placeholder="${e.placeholder||""}"\n        value="${t}"\n        data-action="input-change"\n      >\n    `}renderNavigation(){const e=0===this.currentStep,t=this.currentStep===this.steps.length-1,n=this.canProceedFromCurrentStep();return`\n      <div class="tlw-wizard-nav">\n        <div class="tlw-nav-left">\n          ${e?"":'\n            <button class="tlw-btn tlw-btn--secondary" data-action="prev-step">\n              ← Previous\n            </button>\n          '}\n        </div>\n        \n        <div class="tlw-nav-right">\n          <button class="tlw-btn tlw-btn--ghost" data-action="close">\n            Cancel\n          </button>\n          \n          ${t?`\n            <button class="tlw-btn tlw-btn--success ${n?"":"disabled"}" \n                    data-action="complete" \n                    ${n?"":"disabled"}>\n              Create Scenario\n            </button>\n          `:`\n            <button class="tlw-btn tlw-btn--primary ${n?"":"disabled"}" \n                    data-action="next-step"\n                    ${n?"":"disabled"}>\n              Next →\n            </button>\n          `}\n        </div>\n      </div>\n    `}attachEventListeners(){this.modal.querySelectorAll('[data-action="close"]').forEach(e=>{e.addEventListener("click",()=>this.hide())}),this.modal.querySelector('[data-action="next-step"]')?.addEventListener("click",()=>{this.canProceedFromCurrentStep()&&this.nextStep()}),this.modal.querySelector('[data-action="prev-step"]')?.addEventListener("click",()=>{this.prevStep()}),this.modal.querySelector('[data-action="complete"]')?.addEventListener("click",()=>{this.canProceedFromCurrentStep()&&this.complete()}),this.modal.querySelectorAll('[data-action="select-choice"]').forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.value;this.handleChoiceSelection(t)})}),this.modal.querySelectorAll('[data-action="toggle-choice"]').forEach(e=>{e.addEventListener("change",e=>{this.handleMultiChoiceToggle(e.target.value,e.target.checked)})}),this.modal.querySelectorAll('[data-action="input-change"]').forEach(e=>{e.addEventListener("input",e=>{this.handleInputChange(e.target.value)})}),this.modal.addEventListener("keydown",e=>this.handleKeyNavigation(e)),this.modal.addEventListener("click",e=>{e.stopPropagation()})}handleChoiceSelection(e){const t=this.steps[this.currentStep];this.answers[t.id]=e,this.modal.querySelectorAll(".tlw-choice-option").forEach(t=>{t.classList.toggle("selected",t.dataset.value===e)}),this.updateNavigation(),"choice"===t.type&&setTimeout(()=>{this.currentStep<this.steps.length-1&&this.nextStep()},500)}handleMultiChoiceToggle(e,t){const n=this.steps[this.currentStep];this.answers[n.id]||(this.answers[n.id]=[]),t?this.answers[n.id].includes(e)||this.answers[n.id].push(e):this.answers[n.id]=this.answers[n.id].filter(t=>t!==e);this.modal.querySelector(`input[value="${e}"]`).closest(".tlw-checkbox-option").classList.toggle("selected",t),this.updateNavigation()}handleInputChange(e){const t=this.steps[this.currentStep];this.answers[t.id]=e.trim(),this.updateNavigation()}handleKeyNavigation(e){switch(e.key){case"Escape":this.hide();break;case"Enter":e.target.matches("textarea")||(e.preventDefault(),this.canProceedFromCurrentStep()&&(this.currentStep===this.steps.length-1?this.complete():this.nextStep()))}}nextStep(){this.currentStep<this.steps.length-1&&(this.currentStep++,this.updateModal())}prevStep(){this.currentStep>0&&(this.currentStep--,this.updateModal())}complete(){const e=this.generatePrompt();this.options.onComplete({type:"wizard",answers:this.answers,prompt:e,journeyType:"interactive"}),this.hide()}generatePrompt(){const e=[];if(this.answers.pattern&&this.answers.direction){const t={breakout:"breakout patterns",reversal:"reversal patterns",momentum:"momentum continuation",consolidation:"consolidation patterns",gap:"gap patterns",custom:"specific patterns"},n={bullish:"bullish",bearish:"bearish",both:"both bullish and bearish"};e.push(`I'm looking for ${n[this.answers.direction]} ${t[this.answers.pattern]||this.answers.pattern}`)}if(this.answers.symbols&&e.push(`in ${this.answers.symbols}`),this.answers.timeframe&&e.push(`using ${this.answers.timeframe} timeframe`),this.answers.indicators&&this.answers.indicators.length>0){const t={volume:"volume",rsi:"RSI",macd:"MACD",bollinger:"Bollinger Bands",sma:"simple moving averages",ema:"exponential moving averages",stochastic:"stochastic oscillator",atr:"ATR"},n=this.answers.indicators.map(e=>t[e]||e).join(", ");e.push(`with ${n} confirmation`)}this.answers.conditions&&e.push(`Additional requirements: ${this.answers.conditions}`);let t=e.join(" ");return t=t.replace(/^I'm looking for/,"I want to find"),t+=". Please help me create a testable trading scenario for this.",t}canProceedFromCurrentStep(){const e=this.steps[this.currentStep];if(e.optional)return!0;const t=this.answers[e.id];if(!t)return!1;switch(e.type){case"choice":default:return!!t;case"multi-choice":return!0;case"input":return!(e.validation?.required&&(!t||0===t.length))&&!(e.validation?.minLength&&t.length<e.validation.minLength)}}updateModal(){this.modal.innerHTML=this.render(),this.attachEventListeners(),setTimeout(()=>{const e=this.modal.querySelector("input, textarea, .tlw-choice-option");e&&e.focus()},100)}updateNavigation(){const e=this.modal.querySelector(".tlw-wizard-footer");e&&(e.innerHTML=this.renderNavigation(),e.querySelector('[data-action="next-step"]')?.addEventListener("click",()=>{this.canProceedFromCurrentStep()&&this.nextStep()}),e.querySelector('[data-action="prev-step"]')?.addEventListener("click",()=>{this.prevStep()}),e.querySelector('[data-action="complete"]')?.addEventListener("click",()=>{this.canProceedFromCurrentStep()&&this.complete()}),e.querySelector('[data-action="close"]')?.addEventListener("click",()=>{this.hide()}))}show(){this.isVisible||(this.backdrop.style.display="flex",document.body.classList.add("tlw-modal-open"),setTimeout(()=>{this.backdrop.classList.add("tlw-modal-backdrop--visible"),this.modal.classList.add("tlw-wizard-modal--visible")},10),this.isVisible=!0,setTimeout(()=>{const e=this.modal.querySelector("input, textarea, .tlw-choice-option");e&&e.focus()},100))}hide(){this.isVisible&&(this.backdrop.classList.remove("tlw-modal-backdrop--visible"),this.modal.classList.remove("tlw-wizard-modal--visible"),setTimeout(()=>{this.backdrop.style.display="none",document.body.classList.remove("tlw-modal-open"),this.isVisible=!1,this.options.onClose()},300))}reset(){this.currentStep=0,this.answers={},this.isVisible&&this.updateModal()}destroy(){this.backdrop&&this.backdrop.parentNode&&this.backdrop.parentNode.removeChild(this.backdrop),document.body.classList.remove("tlw-modal-open"),this.isVisible=!1}}class we{constructor(e){this.message=e,this.timestamp=new Date(e.timestamp).toLocaleTimeString()}render(){return`\n      <div class="tlw-message tlw-message--${this.message.type}" data-message-id="${this.message.id}">\n        ${this.renderContent()}\n        ${this.renderFooter()}\n      </div>\n    `}renderContent(){return`\n      <div class="tlw-message-content">\n        ${this.message.content||""}\n      </div>\n    `}renderFooter(){return`\n      <div class="tlw-message-footer">\n        <span class="tlw-message-timestamp">${this.timestamp}</span>\n        ${this.renderActions()}\n      </div>\n    `}renderActions(){return""}}class ye extends we{render(){return`\n      <div class="tlw-message tlw-message--user" data-message-id="${this.message.id}">\n        <div class="tlw-message-bubble">\n          <div class="tlw-message-content">\n            ${this.formatContent(this.message.content)}\n          </div>\n          <div class="tlw-message-timestamp">${this.timestamp}</div>\n        </div>\n      </div>\n    `}formatContent(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>")}}class be extends we{render(){return`\n      <div class="tlw-message tlw-message--assistant" data-message-id="${this.message.id}">\n        <div class="tlw-message-header">\n          <div class="tlw-message-avatar">🤖</div>\n          <div class="tlw-message-info">\n            <span class="tlw-message-sender">TradrLab AI</span>\n            <span class="tlw-message-timestamp">${this.timestamp}</span>\n          </div>\n        </div>\n        <div class="tlw-message-content">\n          ${this.formatContent(this.message.content)}\n        </div>\n        ${this.renderActions()}\n      </div>\n    `}formatContent(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/^(.+)$/,"<p>$1</p>")}renderActions(){return'\n      <div class="tlw-message-actions">\n        <button class="tlw-action-btn tlw-copy-btn" data-action="copy" title="Copy message">\n          📋\n        </button>\n        <button class="tlw-action-btn tlw-feedback-btn" data-action="feedback-good" title="Helpful">\n          👍\n        </button>\n        <button class="tlw-action-btn tlw-feedback-btn" data-action="feedback-bad" title="Not helpful">\n          👎\n        </button>\n      </div>\n    '}}class ve extends we{render(){const e=this.parseSteps(this.message.content);return`\n      <div class="tlw-message tlw-message--steps" data-message-id="${this.message.id}">\n        <div class="tlw-message-header">\n          <div class="tlw-message-avatar">📝</div>\n          <div class="tlw-message-info">\n            <span class="tlw-message-sender">Step-by-Step Guide</span>\n            <span class="tlw-message-timestamp">${this.timestamp}</span>\n          </div>\n        </div>\n        <div class="tlw-steps-content">\n          ${this.renderSteps(e)}\n        </div>\n        ${this.renderActions()}\n      </div>\n    `}parseSteps(e){const t=e.split("\n"),n=[];return t.forEach(e=>{const t=e.match(/^(\d+)\.\s*(.+)/);t&&n.push({number:parseInt(t[1]),text:t[2]})}),n.length>0?n:[{number:1,text:e}]}renderSteps(e){return`\n      <ol class="tlw-steps-list">\n        ${e.map(e=>`\n          <li class="tlw-step-item">\n            <div class="tlw-step-number">${e.number}</div>\n            <div class="tlw-step-text">${e.text}</div>\n          </li>\n        `).join("")}\n      </ol>\n    `}}class Ae extends we{render(){return`\n      <div class="tlw-message tlw-message--template" data-message-id="${this.message.id}">\n        <div class="tlw-template-header">\n          <div class="tlw-template-icon">✨</div>\n          <div class="tlw-template-info">\n            <h4>Scenario Template Ready</h4>\n            <span class="tlw-template-name">${this.message.templateName||"Custom Template"}</span>\n          </div>\n        </div>\n        <div class="tlw-template-content">\n          ${this.formatContent(this.message.content)}\n        </div>\n        <div class="tlw-template-actions">\n          <button class="tlw-btn tlw-btn--primary" data-action="accept-template">\n            Generate Model\n          </button>\n          <button class="tlw-btn tlw-btn--secondary" data-action="modify-template">\n            Modify Template\n          </button>\n        </div>\n        <div class="tlw-message-timestamp">${this.timestamp}</div>\n      </div>\n    `}formatContent(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>")}}class Ce extends we{render(){const e=this.message.scenarioId,t=this.message.statusCode&&"200"!==this.message.statusCode;return`\n      <div class="tlw-message tlw-message--model" data-message-id="${this.message.id}">\n        <div class="tlw-model-header">\n          <div class="tlw-model-icon">${t?"❌":"✅"}</div>\n          <div class="tlw-model-info">\n            <h4>${t?"Model Generation Failed":"Model Generated Successfully"}</h4>\n            ${e?`<span class="tlw-scenario-id">Scenario ID: ${e}</span>`:""}\n          </div>\n        </div>\n        \n        ${t?this.renderError():this.renderSuccess()}\n        \n        <div class="tlw-message-timestamp">${this.timestamp}</div>\n      </div>\n    `}renderSuccess(){return'\n      <div class="tlw-model-content">\n        <p>✨ Your trading scenario has been created and is being evaluated against market data...</p>\n        <div class="tlw-model-status">\n          <div class="tlw-progress-indicator">\n            <div class="tlw-spinner"></div>\n            <span>Running evaluation...</span>\n          </div>\n        </div>\n      </div>\n      <div class="tlw-model-actions">\n        <button class="tlw-btn tlw-btn--secondary" data-action="view-model">\n          View Model Details\n        </button>\n      </div>\n    '}renderError(){return`\n      <div class="tlw-model-content tlw-error-content">\n        <p>There was an issue generating your trading model. Please try again or modify your request.</p>\n        ${this.message.content?`<div class="tlw-error-details">${this.message.content}</div>`:""}\n      </div>\n      <div class="tlw-model-actions">\n        <button class="tlw-btn tlw-btn--primary" data-action="retry-model">\n          Try Again\n        </button>\n      </div>\n    `}}class Se extends we{render(){const e=this.message.tableJson||this.message.tableMarkdown;return`\n      <div class="tlw-message tlw-message--analysis" data-message-id="${this.message.id}">\n        <div class="tlw-message-header">\n          <div class="tlw-message-avatar">📊</div>\n          <div class="tlw-message-info">\n            <span class="tlw-message-sender">Analysis Results</span>\n            <span class="tlw-message-timestamp">${this.timestamp}</span>\n          </div>\n        </div>\n        \n        <div class="tlw-analysis-content">\n          ${this.formatContent(this.message.content)}\n        </div>\n        \n        ${e?this.renderTable():""}\n        \n        ${this.renderActions()}\n      </div>\n    `}renderTable(){return this.message.tableJson?this.renderJsonTable():this.message.tableMarkdown?this.renderMarkdownTable():""}renderJsonTable(){try{const e=JSON.parse(this.message.tableJson);if(!Array.isArray(e)||0===e.length)return'<div class="tlw-table-empty">No data available</div>';const t=Object.keys(e[0]),n=10,s=e.slice(0,n),i=e.length>n;return`\n        <div class="tlw-table-container">\n          <table class="tlw-data-table">\n            <thead>\n              <tr>\n                ${t.map(e=>`<th>${e}</th>`).join("")}\n              </tr>\n            </thead>\n            <tbody>\n              ${s.map(e=>`\n                <tr>\n                  ${t.map(t=>`<td>${this.formatCellValue(e[t])}</td>`).join("")}\n                </tr>\n              `).join("")}\n            </tbody>\n          </table>\n          \n          <div class="tlw-table-controls">\n            ${i?`\n              <button class="tlw-btn tlw-btn--secondary" data-action="expand-table">\n                Show All (${e.length} rows)\n              </button>\n            `:""}\n            <button class="tlw-btn tlw-btn--secondary" data-action="export-csv">\n              Export CSV\n            </button>\n            <button class="tlw-btn tlw-btn--secondary" data-action="open-full-screen">\n              View in Main App\n            </button>\n          </div>\n        </div>\n      `}catch(e){return'<div class="tlw-table-error">Error parsing table data</div>'}}renderMarkdownTable(){return`\n      <div class="tlw-markdown-table">\n        ${this.message.tableMarkdown}\n      </div>\n    `}formatCellValue(e){return null==e?"-":"number"==typeof e?e%1==0?e.toLocaleString():e.toLocaleString(void 0,{maximumFractionDigits:4}):"string"==typeof e&&e.includes("%")?e:String(e)}formatContent(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/^(.+)$/,"<p>$1</p>")}renderActions(){return'\n      <div class="tlw-message-actions">\n        <button class="tlw-action-btn" data-action="ask-follow-up" title="Ask follow-up question">\n          💬 Ask More\n        </button>\n        <button class="tlw-action-btn" data-action="copy" title="Copy results">\n          📋\n        </button>\n        <button class="tlw-action-btn tlw-feedback-btn" data-action="feedback-good" title="Helpful">\n          👍\n        </button>\n        <button class="tlw-action-btn tlw-feedback-btn" data-action="feedback-bad" title="Not helpful">\n          👎\n        </button>\n      </div>\n    '}}class _e extends we{render(){return`\n      <div class="tlw-message tlw-message--scenario" data-message-id="${this.message.id}">\n        <div class="tlw-message-header">\n          <div class="tlw-message-avatar">🎯</div>\n          <div class="tlw-message-info">\n            <span class="tlw-message-sender">Scenario Update</span>\n            <span class="tlw-message-timestamp">${this.timestamp}</span>\n          </div>\n        </div>\n        <div class="tlw-scenario-content">\n          ${this.formatContent(this.message.content)}\n        </div>\n        ${this.renderActions()}\n      </div>\n    `}formatContent(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\n/g,"<br>")}}class ke extends we{render(){return`\n      <div class="tlw-message tlw-message--explanation" data-message-id="${this.message.id}">\n        <div class="tlw-message-header">\n          <div class="tlw-message-avatar">🔍</div>\n          <div class="tlw-message-info">\n            <span class="tlw-message-sender">System Explanation</span>\n            <span class="tlw-message-timestamp">${this.timestamp}</span>\n          </div>\n        </div>\n        <div class="tlw-explanation-content">\n          ${this.formatContent(this.message.content)}\n          \n          ${this.message.fixedDag?'\n            <div class="tlw-fix-notice">\n              <strong>🔧 Automatic Fix Applied</strong>\n              <p>The system detected and corrected an issue with your scenario.</p>\n            </div>\n          ':""}\n        </div>\n        ${this.renderActions()}\n      </div>\n    `}formatContent(e){return e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/`(.*?)`/g,"<code>$1</code>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/^(.+)$/,"<p>$1</p>")}}class Ee extends we{render(){return`\n      <div class="tlw-message tlw-message--error" data-message-id="${this.message.id}">\n        <div class="tlw-error-header">\n          <div class="tlw-error-icon">⚠️</div>\n          <span class="tlw-error-title">Something went wrong</span>\n        </div>\n        <div class="tlw-error-content">\n          ${this.message.content}\n        </div>\n        <div class="tlw-error-actions">\n          <button class="tlw-btn tlw-btn--secondary" data-action="retry">\n            Try Again\n          </button>\n        </div>\n        <div class="tlw-message-timestamp">${this.timestamp}</div>\n      </div>\n    `}}class Ie extends we{render(){return`\n      <div class="tlw-message tlw-message--execution-error" data-message-id="${this.message.id}">\n        <div class="tlw-error-header">\n          <div class="tlw-error-icon">🤖</div>\n          <span class="tlw-error-title">AI Engine Error</span>\n        </div>\n        <div class="tlw-error-content">\n          ${this.message.content}\n        </div>\n        <div class="tlw-error-actions">\n          <button class="tlw-btn tlw-btn--primary" data-action="retry-execution" data-scenario-id="${this.message.scenarioId}">\n            🔄 Try Again\n          </button>\n          <button class="tlw-btn tlw-btn--secondary" data-action="ask-question" data-scenario-id="${this.message.scenarioId}">\n            💬 Ask Question\n          </button>\n        </div>\n        <div class="tlw-message-timestamp">${this.timestamp}</div>\n      </div>\n    `}}class Te extends we{render(){return`\n      <div class="tlw-message tlw-message--system" data-message-id="${this.message.id}">\n        <div class="tlw-system-content">\n          <span class="tlw-system-icon">ℹ️</span>\n          ${this.message.content}\n        </div>\n        <div class="tlw-message-timestamp">${this.timestamp}</div>\n      </div>\n    `}}class xe{static create(e){switch(e.messageType||e.type){case"user":return new ye(e);case"Text":case"assistant":default:return new be(e);case"Steps":return new ve(e);case"Template":case"TemplateSelection":return new Ae(e);case"Model":return new Ce(e);case"Analysis":return new Se(e);case"Scenario":return new _e(e);case"Explanation":return new ke(e);case"error":return new Ee(e);case"ExecutionError":return new Ie(e);case"system":return new Te(e)}}}class Me{constructor(e,t={}){this.container=e,this.options={onMilestoneClick:t.onMilestoneClick||(()=>{}),showLabels:!1!==t.showLabels,showProgress:!1!==t.showProgress,compact:t.compact||!1,interactive:t.interactive||!1,...t},this.currentMilestone=0,this.journeyType=null,this.isVisible=!1,this.milestones=[...ae],this.init()}init(){this.render(),this.attachEventListeners()}render(){this.container&&(this.container.innerHTML=`\n      <div class="tlw-milestone-tracker ${this.options.compact?"tlw-milestone-tracker--compact":""}">\n        ${this.options.showProgress?this.renderProgressBar():""}\n        <div class="tlw-milestone-steps">\n          ${this.renderMilestones()}\n        </div>\n        ${this.renderJourneyIndicator()}\n      </div>\n    `)}renderProgressBar(){return`\n      <div class="tlw-milestone-progress">\n        <div class="tlw-progress-bar">\n          <div class="tlw-progress-fill" style="width: ${this.calculateProgress()}%"></div>\n        </div>\n        <div class="tlw-progress-text">\n          ${this.getProgressText()}\n        </div>\n      </div>\n    `}renderMilestones(){return this.milestones.map((e,t)=>{const n=this.getMilestoneStatus(t),s=this.options.interactive&&"pending"!==n;return`\n        <div class="tlw-milestone ${this.getMilestoneClasses(t,n)}"\n             data-milestone="${e.id}"\n             ${s?'role="button" tabindex="0"':""}\n             title="${e.description}">\n          \n          <div class="tlw-milestone-icon-container">\n            <div class="tlw-milestone-icon">${e.icon}</div>\n            ${"active"===n?'<div class="tlw-milestone-pulse"></div>':""}\n            ${"completed"===n?'<div class="tlw-milestone-check">✓</div>':""}\n          </div>\n          \n          ${this.options.showLabels?`\n            <div class="tlw-milestone-label">\n              <span class="tlw-milestone-name">${e.name}</span>\n              ${this.options.compact?"":`\n                <span class="tlw-milestone-description">${e.description}</span>\n              `}\n            </div>\n          `:""}\n          \n          ${t<this.milestones.length-1?`\n            <div class="tlw-milestone-connector ${"completed"===n?"tlw-milestone-connector--completed":""}"></div>\n          `:""}\n        </div>\n      `}).join("")}renderJourneyIndicator(){if(!this.journeyType)return"";return`\n      <div class="tlw-journey-indicator">\n        <span class="tlw-journey-icon">${{interactive:"🎯",template:"📋"}[this.journeyType]||"🎯"}</span>\n        <span class="tlw-journey-label">${{interactive:"Interactive Journey",template:"Template Journey"}[this.journeyType]||"Journey"}</span>\n      </div>\n    `}getMilestoneClasses(e,t){const n=["tlw-milestone-item"];return n.push(`tlw-milestone--${t}`),this.options.interactive&&"pending"!==t&&n.push("tlw-milestone--clickable"),0===e&&n.push("tlw-milestone--first"),e===this.milestones.length-1&&n.push("tlw-milestone--last"),n.join(" ")}getMilestoneStatus(e){return e<this.currentMilestone?"completed":e===this.currentMilestone?"active":"pending"}calculateProgress(){return 0===this.milestones.length?0:Math.round(this.currentMilestone/(this.milestones.length-1)*100)}getProgressText(){const e=this.currentMilestone,t=this.milestones.length,n=this.milestones[this.currentMilestone];return e===t-1&&this.currentMilestone===t-1?"Journey Complete!":`Step ${e+1} of ${t}: ${n?.name||"Unknown"}`}attachEventListeners(){this.options.interactive&&this.container.querySelectorAll(".tlw-milestone--clickable").forEach(e=>{e.addEventListener("click",t=>{const n=parseInt(e.dataset.milestone);this.handleMilestoneClick(n,t)}),e.addEventListener("keydown",t=>{if("Enter"===t.key||" "===t.key){t.preventDefault();const n=parseInt(e.dataset.milestone);this.handleMilestoneClick(n,t)}})})}handleMilestoneClick(e,t){const n=this.milestones.find(t=>t.id===e);n&&this.options.onMilestoneClick(n,t)}updateMilestone(e){const t="number"==typeof e?e:e.id;t!==this.currentMilestone&&(this.currentMilestone=Math.max(0,Math.min(t,this.milestones.length-1)),this.render(),this.attachEventListeners(),this.animateMilestoneChange(t))}setJourneyType(e){this.journeyType!==e&&(this.journeyType=e,this.render(),this.attachEventListeners())}animateMilestoneChange(e){const t=this.container.querySelectorAll(".tlw-milestone-item")[e];t&&(t.classList.add("tlw-milestone--just-completed"),setTimeout(()=>{t.classList.remove("tlw-milestone--just-completed")},1e3),this.options.autoScroll&&t.scrollIntoView({behavior:"smooth",block:"nearest",inline:"center"}))}show(){this.isVisible||(this.container.style.display="block",this.container.classList.add("tlw-milestone-tracker--visible"),this.isVisible=!0)}hide(){this.isVisible&&(this.container.classList.remove("tlw-milestone-tracker--visible"),setTimeout(()=>{this.container.style.display="none",this.isVisible=!1},300))}reset(){this.currentMilestone=0,this.journeyType=null,this.render(),this.attachEventListeners()}getCurrentMilestone(){return{index:this.currentMilestone,milestone:this.milestones[this.currentMilestone],progress:this.calculateProgress(),journeyType:this.journeyType}}setMilestones(e){Array.isArray(e)&&e.length>0&&(this.milestones=e,this.currentMilestone=Math.min(this.currentMilestone,this.milestones.length-1),this.render(),this.attachEventListeners())}onMilestoneChange(e){"function"==typeof e&&(this.options.onMilestoneClick=e)}destroy(){this.container&&(this.container.innerHTML=""),this.isVisible=!1}}class $e{constructor(e,t){this.element=e,this.config=t,this.id=null,this.initialized=!1,this.currentState=oe.INITIALIZING,this.messageStore=null,this.apiClient=null,this.signalRClient=null,this.thinkingManager=null,this.dagProcessor=null,this.actionManager=null,this.processingTemplate=!1,this.chatContainer=null,this.landingPage=null,this.templateModal=null,this.scenarioWizard=null,this.milestoneTracker=null,this.waitingForResponse=!1,this.showLandingPage=!0,this.hasConversation=!1,this.generatedScenarios=[],this.stylesInjected=!1}async init(){try{if(this.initialized)return;this.setupTargetElement(),this.initializeServices(),await this.initializeUser(),this.createComponents(),await this.connectSignalR(),this.initialized=!0,this.currentState=oe.LANDING;const e=this.config.get("onWidgetReady");e&&e(this),this.showInitialView()}catch(e){this.currentState=oe.ERROR,this.handleError(e)}}setupTargetElement(){this.element.classList.add("tradr-widget","tradr-widget--enhanced"),this.element.classList.add(`tradr-widget-${this.config.get("theme")}`),this.element.style.width=this.config.get("width"),this.element.style.height=this.config.get("height"),this.element.widgetInstance=this,this.element.style.setProperty("--tradr-primary-color",this.config.get("primaryColor")),this.element.style.setProperty("--tradr-font-family",this.config.get("fontFamily"))}initializeServices(){this.messageStore=new i,this.apiClient=new ce(this.config),this.thinkingManager=new le,this.dagProcessor=new he(this.messageStore,this.apiClient,this.thinkingManager,this.config),this.actionManager=new ge(this.messageStore,this.apiClient,this.thinkingManager),this.signalRClient=new ie(this.config,this.messageStore,this.apiClient,this.thinkingManager),this.loadBlocksData(),this.loadCurrencies(),this.injectStyles(),this.wireIntelligenceEvents()}injectStyles(){if(this.stylesInjected)return;const e=document.createElement("style");e.textContent='\n  .tlw-thinking-indicator {\n    padding: 12px 16px;\n    background: linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%);\n    border-left: 3px solid #0ea5e9;\n    border-radius: 8px;\n    margin: 8px 0;\n    animation: slideIn 0.3s ease-out;\n    transition: all 0.3s ease;\n    font-size: 14px;\n  }\n  \n  .tlw-thinking-content {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n  }\n  \n  .tlw-thinking-animation {\n    display: flex;\n    gap: 4px;\n    align-items: center;\n  }\n  \n  .tlw-thinking-dot {\n    width: 8px;\n    height: 8px;\n    background: #0ea5e9;\n    border-radius: 50%;\n    animation: bounce 1.4s ease-in-out infinite;\n  }\n  \n  .tlw-thinking-dot:nth-child(1) { animation-delay: -0.32s; }\n  .tlw-thinking-dot:nth-child(2) { animation-delay: -0.16s; }\n  .tlw-thinking-dot:nth-child(3) { animation-delay: 0s; }\n  \n  .tlw-thinking-message {\n    color: #0c4a6e;\n    font-weight: 500;\n    transition: opacity 0.2s ease;\n    flex: 1;\n    line-height: 1.4;\n  }\n  \n  .tlw-thinking-timer {\n    display: none;\n    align-items: center;\n    padding: 2px 8px;\n    background: rgba(14, 165, 233, 0.1);\n    border-radius: 12px;\n    margin-left: auto;\n  }\n  \n  .tlw-timer-text {\n    color: #0369a1;\n    font-size: 12px;\n    font-weight: 600;\n    font-family: \'SF Mono\', \'Monaco\', \'Inconsolata\', monospace;\n  }\n  \n  @keyframes bounce {\n    0%, 80%, 100% {\n      transform: scale(0);\n      opacity: 0.5;\n    }\n    40% {\n      transform: scale(1);\n      opacity: 1;\n    }\n  }\n  \n  @keyframes slideIn {\n    from {\n      transform: translateY(-10px);\n      opacity: 0;\n    }\n    to {\n      transform: translateY(0);\n      opacity: 1;\n    }\n  }\n  \n  /* Different colors for different operation types */\n  .tlw-thinking-indicator[data-type="/query"] {\n    background: linear-gradient(90deg, #f0fdf4 0%, #dcfce7 100%);\n    border-left-color: #22c55e;\n  }\n  \n  .tlw-thinking-indicator[data-type="/query"] .tlw-thinking-dot {\n    background: #22c55e;\n  }\n  \n  .tlw-thinking-indicator[data-type="/evaluate"] {\n    background: linear-gradient(90deg, #fefce8 0%, #fef3c7 100%);\n    border-left-color: #eab308;\n  }\n  \n  .tlw-thinking-indicator[data-type="/evaluate"] .tlw-thinking-dot {\n    background: #eab308;\n  }\n  \n  .tlw-thinking-indicator[data-type="template"] {\n    background: linear-gradient(90deg, #fdf4ff 0%, #fae8ff 100%);\n    border-left-color: #a855f7;\n  }\n  \n  .tlw-thinking-indicator[data-type="template"] .tlw-thinking-dot {\n    background: #a855f7;\n  }\n  \n  /* Progress bar for chat messages */\n  .tlw-progress-bar {\n    width: 100%;\n    height: 3px;\n    background: rgba(0, 0, 0, 0.1);\n    border-radius: 3px;\n    margin-top: 8px;\n    overflow: hidden;\n    position: relative;\n  }\n  \n  .tlw-thinking-indicator[data-type="/chat"] .tlw-progress-bar {\n    display: block;\n  }\n  \n  .tlw-thinking-indicator:not([data-type="/chat"]) .tlw-progress-bar {\n    display: none;\n  }\n  \n  .tlw-progress-fill {\n    height: 100%;\n    width: 0%;\n    background: linear-gradient(90deg, #0ea5e9 0%, #0284c7 100%);\n    border-radius: 3px;\n    box-shadow: 0 0 8px rgba(14, 165, 233, 0.5);\n    position: relative;\n    overflow: hidden;\n  }\n  \n  .tlw-progress-fill::after {\n    content: \'\';\n    position: absolute;\n    top: 0;\n    left: 0;\n    bottom: 0;\n    right: 0;\n    background: linear-gradient(\n      90deg,\n      transparent,\n      rgba(255, 255, 255, 0.3),\n      transparent\n    );\n    animation: shimmer 2s linear infinite;\n  }\n  \n  @keyframes shimmer {\n    0% { transform: translateX(-100%); }\n    100% { transform: translateX(100%); }\n  }\n  \n  @keyframes pulse {\n    0%, 100% { opacity: 1; }\n    50% { opacity: 0.6; }\n  }\n',document.head.appendChild(e),this.stylesInjected=!0}wireIntelligenceEvents(){this.messageStore.on("message:added",e=>{this.handleIntelligentMessage(e)}),this.messageStore.on("milestone:update",e=>{this.handleMilestoneUpdate(e)}),this.messageStore.on("dag:generated",e=>{this.handleDagGenerated(e)}),this.signalRClient.on("chatMessage",e=>{this.handleSignalRMessage(e)}),this.signalRClient.on("templateMessage",e=>{this.handleSignalRMessage(e)}),this.signalRClient.on("modelMessage",e=>{this.handleSignalRMessage(e)}),this.signalRClient.on("responseReceived",e=>{this.handleSignalRMessage(e)}),this.signalRClient.on("connected",()=>{this.onSignalRConnected()}),this.signalRClient.on("disconnected",()=>{this.onSignalRDisconnected()}),this.signalRClient.on("executionStarting",e=>{this.handleExecutionStarting(e)}),this.signalRClient.on("executionCompleted",e=>{this.handleExecutionCompleted(e)}),this.signalRClient.on("executionError",e=>{this.handleExecutionError(e)}),this.actionManager.on("action:ask-question",e=>{this.showAnalysisInput(e.scenario)})}async loadBlocksData(){try{await this.apiClient.loadBlocksData();this.config.set("autoExecuteAfterDag",!0)}catch(e){this.config.set("autoExecuteAfterDag",!1)}}async loadCurrencies(){try{await this.apiClient.loadCurrencies();this.config.get("defaultSymbol")||this.config.set("defaultSymbol","EURUSD"),this.config.get("defaultTimeframe")||this.config.set("defaultTimeframe","1H")}catch(e){this.config.set("defaultSymbol","EURUSD"),this.config.set("defaultTimeframe","1H")}}handleIntelligentMessage(e){const t=this.messageStore.analyzeMessageForActions(e);t.updateMilestone&&this.messageStore.updateMilestone(t.updateMilestone),t.startSession&&e.sessionId&&this.messageStore.startSession(e.sessionId,e.templateName||"Template"),t.endSession&&e.sessionId&&this.messageStore.endSession(e.sessionId),this.messageStore.journeyType&&!this.hasConversation&&(this.hasConversation=!0,this.showLandingPage=!1,this.updateMainUI()),this.updateActionButtons(),t.triggerEvaluation&&this.dagProcessor.processModelMessage(e),"Template"!==e.messageType&&"Model"!==e.messageType||(this.processingTemplate=!1),this.handleMessageCallback(e)}handleMilestoneUpdate(e){this.milestoneTracker&&this.milestoneTracker.updateMilestone(e.milestone);const t=this.config.get("onMilestone");t&&t({milestone:e.milestone,journeyType:e.journeyType})}handleDagGenerated(e){this.updateMainUI(),this.updateActionButtons()}handleSignalRMessage(e){e.requestId&&this.thinkingManager.stopThinking(e.requestId),e.scenarioId&&this.thinkingManager.stopThinking(`eval-${e.scenarioId}`),e.messageType&&e.aiResponse&&this.setWaitingState(!1),e.messageType}handleExecutionStarting(e){const t={id:`execution-starting-${Date.now()}`,content:`⚡ Executing DAG with ${e.dagBlocks.length} blocks...`,messageType:"ExecutionStatus",type:"system",scenarioId:e.scenarioId,timestamp:(new Date).toISOString(),isExecuting:!0};this.messageStore.addMessage(t),this.updateChatDisplay(),this.thinkingManager.showThinking(`execution-${e.scenarioId}`,"Executing model...")}handleExecutionCompleted(e){const t=e.executionResult;this.thinkingManager.stopThinking(`execution-${e.scenarioId}`);const n={id:`execution-result-${Date.now()}`,content:this.formatExecutionResult(t),messageType:"ExecutionResult",type:"system",scenarioId:e.scenarioId,executionResult:t,timestamp:(new Date).toISOString()};this.messageStore.addMessage(n),this.updateChatDisplay()}handleExecutionError(e){this.thinkingManager.stopThinking(`execution-${e.scenarioId}`);const t={id:`execution-error-${Date.now()}`,content:`❌ Execution failed: ${e.error}`,messageType:"ExecutionError",type:"system",scenarioId:e.scenarioId,error:e.error,timestamp:(new Date).toISOString()};this.messageStore.addMessage(t),this.updateChatDisplay()}async retryExecution(e){try{const t=this.dagProcessor.getStoredDagData(e);if(!t)throw new Error("No scenario data found for retry. Please regenerate the model first.");const n=`retry-exec-${e}`;this.thinkingManager.startThinking(n,"🔄 Retrying execution..."),await this.dagProcessor.triggerEvaluation(e,`retry-${Date.now()}`,t)}catch(t){throw this.thinkingManager.stopThinking(`retry-exec-${e}`),this.messageStore.addMessage({id:`retry-error-${Date.now()}`,type:"system",messageType:"Error",content:`❌ **Retry Failed**\n\n${t.message}\n\nYou may need to regenerate the model or check the scenario parameters.`,timestamp:Date.now(),scenarioId:e}),t}}formatExecutionResult(e){if(!e.Success)return`❌ Execution failed: ${e.ErrorMessage||"Unknown error"}`;if(0===e.TotalRecords)return"⚠️ Execution completed but returned no data. Check your strategy parameters.";const t=e.FirstDate&&e.LastDate?`from ${e.FirstDate} to ${e.LastDate}`:"";return`✅ Execution completed successfully! \n📊 Found ${e.TotalRecords} trading opportunities ${t}\n📈 Columns: ${e.Columns.join(", ")}`}updateActionButtons(){const e=this.actionManager.getAvailableActions(),t=this.element.querySelector(".tlw-actions-container");t&&(t.innerHTML="",e.forEach(e=>{if(!e.visible)return;const n=document.createElement("button");n.className="tlw-action-btn "+(e.primary?"primary":"secondary"),n.innerHTML=e.label,n.title=e.description,n.disabled=e.disabled||this.actionManager.areActionsDisabled(),n.addEventListener("click",async()=>{try{await e.action()}catch(t){this.handleActionError(e,t)}}),t.appendChild(n)}))}handleActionError(e,t){this.messageStore.addMessage({id:`error-${Date.now()}`,type:"system",messageType:"Error",content:`❌ **${e.label} Failed**\n\n${t.message}\n\nPlease try again or contact support if the problem persists.`,timestamp:Date.now()}),this.updateMainUI()}updateMainUI(){this.showLandingPage&&!this.hasConversation?this.showLandingView():this.showChatView()}showLandingView(){this.landingPage||(this.landingPage=new pe(this.element,this.config,this.apiClient,this.messageStore,this.thinkingManager)),this.chatContainer&&this.chatContainer.element&&(this.chatContainer.element.style.display="none"),this.landingPage.render()}showChatView(){this.chatContainer||(this.chatContainer=new ue(this.element.querySelector("#chat-container"),this.config,this.messageStore,this.apiClient,this.signalRClient)),this.landingPage&&this.landingPage.element&&(this.landingPage.element.style.display="none"),this.chatContainer.render(),this.attachChatEventListeners()}showAnalysisInput(e){const t=prompt("What would you like to analyze?");t&&t.trim()&&this.actionManager.sendAnalysisQuestion(t.trim()).catch(e=>{})}onSignalRConnected(){this.currentState=oe.READY}onSignalRDisconnected(){this.currentState=oe.RECONNECTING}async initializeUser(){if(!this.config.get("externalUserId"))throw new Error("EnhancedChatWidget: External user ID is required");try{const e=await this.apiClient.getJwtToken();if(this.config.set("userId",e.userId),this.config.set("jwtToken",e.jwtToken||e.token),this.config.set("tokenExpires",e.tokenExpires||e.expiresAt),!this.config.get("signalRUrl")){const e=this.config.get("apiBaseUrl");this.config.set("signalRUrl",`${e}/hubs/message`)}}catch(e){throw e}}createComponents(){this.element.innerHTML='\n      <div class="tlw-widget-container">\n        <div class="tlw-milestone-container" id="milestone-container"></div>\n        <div class="tlw-landing-container" id="landing-container"></div>\n        <div class="tlw-chat-container" id="chat-container"></div>\n      </div>\n    ',this.createMilestoneTracker(),this.createLandingPage(),this.createChatContainer(),this.createModals()}createMilestoneTracker(){const e=this.element.querySelector("#milestone-container");this.milestoneTracker=new Me(e,{onMilestoneClick:e=>this.handleMilestoneClick(e)})}createLandingPage(){const e=this.element.querySelector("#landing-container");this.landingPage=new pe(e,{onSelection:e=>this.handleLandingSelection(e),onTemplateRequest:()=>this.showTemplateModal(),onWizardRequest:()=>this.showScenarioWizard(),showBranding:this.config.get("showBranding",!0)})}createChatContainer(){this.element.querySelector("#chat-container").innerHTML=this.renderChatInterface(),this.attachChatEventListeners()}renderChatInterface(){return`\n      <div class="tlw-chat-header">\n        <button class="tlw-back-btn" id="back-to-landing" ${this.hasConversation?"":'style="display: none;"'}>\n          ← Back\n        </button>\n        <div class="tlw-chat-title">TradrLab Assistant</div>\n      </div>\n      \n      <div class="tlw-messages" id="messages-container">\n        ${this.renderMessages()}\n      </div>\n      \n      <div class="tlw-chat-controls">\n        ${this.renderGenerateButton()}\n        <div class="tlw-input-container">\n          <textarea \n            class="tlw-message-input" \n            id="message-input"\n            placeholder="Ask a question or describe your trading idea..."\n            rows="1"\n          ></textarea>\n          <button class="tlw-send-btn" id="send-button" ${this.waitingForResponse?"disabled":""}>\n            ${this.waitingForResponse?"⏳":"Send"}\n          </button>\n        </div>\n        ${this.waitingForResponse?'<div class="tlw-thinking">AI is thinking...</div>':""}\n      </div>\n    `}renderGenerateButton(){return this.hasConversation&&!this.waitingForResponse&&"interactive"===this.messageStore.journeyType?'\n      <div class="tlw-generate-container">\n        <button class="tlw-generate-btn" id="generate-scenario">\n          🚀 Generate Scenario\n        </button>\n        <span class="tlw-generate-hint">Ready to create your trading model?</span>\n      </div>\n    ':""}renderMessages(){const e=this.messageStore.getMessages();return 0===e.length?'\n        <div class="tlw-welcome-message">\n          <div class="tlw-welcome-icon">👋</div>\n          <h3>Welcome to TradrLab!</h3>\n          <p>I\'m here to help you create and test trading scenarios. What would you like to build today?</p>\n        </div>\n      ':e.map(e=>this.renderMessage(e)).join("")}renderMessage(e){return xe.create(e).render()}attachChatEventListeners(){const e=this.element.querySelector("#back-to-landing");e&&e.addEventListener("click",()=>this.showLandingPage());const t=this.element.querySelector("#generate-scenario");t&&t.addEventListener("click",()=>this.generateScenario());const n=this.element.querySelector("#message-input"),s=this.element.querySelector("#send-button");n&&s&&(n.addEventListener("input",()=>{n.style.height="auto",n.style.height=Math.min(n.scrollHeight,120)+"px"}),n.addEventListener("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())}),s.addEventListener("click",()=>this.sendMessage()))}createModals(){this.templateModal=new me({apiClient:this.apiClient,onSelect:e=>this.handleTemplateSelection(e),onClose:()=>{}}),this.scenarioWizard=new fe({onComplete:e=>this.handleWizardComplete(e),onClose:()=>{}})}async connectSignalR(){try{await this.signalRClient.connect()}catch(e){}}handleLandingSelection(e){this.showChatInterface(),this.messageStore.setJourneyType("interactive"),setTimeout(()=>{this.sendMessageToApi(e.content)},300)}async handleTemplateSelection(e){if(!this.processingTemplate){this.processingTemplate=!0,this.showChatInterface(),this.messageStore.setJourneyType("template"),this.messageStore.addMessage({id:`template-${e.id}-${Date.now()}`,type:"user",content:`Selected template: ${e.name}`,messageType:"TemplateSelection",templateId:e.id,templateName:e.name});try{await this.sendTemplateToApi(e)}catch(e){}finally{this.processingTemplate=!1}}}handleWizardComplete(e){this.showChatInterface(),this.messageStore.setJourneyType("interactive"),this.messageStore.addMessage({id:`wizard-${Date.now()}`,type:"user",content:e.prompt,messageType:"WizardResult",wizardAnswers:e.answers}),setTimeout(()=>{this.sendMessageToApi(e.prompt)},300)}async sendMessage(e){if(e){if(this.waitingForResponse)return;return this.messageStore.addMessage({id:`user-${Date.now()}`,type:"user",content:e,messageType:"Text"}),this.hasConversation=!0,void await this.sendMessageToApi(e)}const t=this.element.querySelector("#message-input");if(!t)return;const n=t.value.trim();n&&!this.waitingForResponse&&(t.value="",t.style.height="auto",this.messageStore.addMessage({id:`user-${Date.now()}`,type:"user",content:n,messageType:"Text"}),this.hasConversation=!0,await this.sendMessageToApi(n))}async sendMessageToApi(e){try{this.setWaitingState(!0);const t=`chat-${Date.now()}`,n=(t,n)=>{this.setWaitingState(!1),this.messageStore.addMessage({id:`chat-timeout-${Date.now()}`,type:"system",messageType:"Error",content:"❌ **Request Timed Out**\n\nThe AI engine did not respond within the expected time.\n\n"+(n?"Retrying...":"Please try sending your message again."),timestamp:Date.now()}),n&&setTimeout(()=>{this.sendMessageToApi(e)},1e3)};this.thinkingManager.startThinking(t,"/chat","💭 Thinking...",n,6e4),this.config.get("scenarioId")||await this.apiClient.createScenario("New Scenario");const s=this.signalRClient.getConnectionId();await this.apiClient.sendMessage(e,{messageType:"Text",socketId:s})}catch(e){this.setWaitingState(!1),this.thinkingManager.stopAll(),this.handleError(e)}}async sendTemplateToApi(e){try{this.setWaitingState(!0);const t=`template-${Date.now()}`,n=`🎯 Processing template: ${e.name}...`,s=(t,n)=>{this.setWaitingState(!1),this.messageStore.addMessage({id:`template-timeout-${Date.now()}`,type:"system",messageType:"Error",content:`❌ **Template Processing Timed Out**\n\nThe AI engine did not respond to template "${e.name}" within the expected time.\n\n${n?"Retrying...":"Please try selecting the template again."}`,timestamp:Date.now()}),n&&setTimeout(()=>{this.sendTemplateToApi(e)},1e3)};this.thinkingManager.startThinking(t,"/chat",n,s,6e4),this.config.get("scenarioId")||await this.apiClient.createScenario(e.name);const i=this.signalRClient.getConnectionId();await this.apiClient.sendMessage(e.description,{messageType:"TemplateSelection",socketId:i,templateId:e.id,templateName:e.name})}catch(e){this.setWaitingState(!1),this.handleError(e)}}async generateScenario(){try{this.setWaitingState(!0),this.messageStore.updateMilestone("model");const e=this.messageStore.getConversationSummary(),t=this.signalRClient.getConnectionId(),n=this.config.get("scenarioId"),s=this.config.get("sessionId");this.config.get("externalUserId"),await this.apiClient.generateScenario({conversationContext:e,socketId:t,sessionId:s,scenarioId:n})}catch(e){this.setWaitingState(!1),this.handleError(e)}}handleMessageStoreEvent(e){switch(e.action){case"message:add":case"session:start":case"session:end":this.updateChatDisplay();break;case"milestone:update":this.milestoneTracker.updateMilestone(e.data.milestone)}}handleChatMessage(e){this.updateChatDisplay()}handleTemplateMessage(e){this.updateChatDisplay()}handleModelMessage(e){this.generatedScenarios.push(e),this.updateChatDisplay()}handleAnalysisMessage(e){this.updateChatDisplay()}handleTemplateReady(e){}handleDagGenerated(e){this.messageStore.updateMilestone("evaluate")}setWaitingState(e){this.waitingForResponse=e,this.signalRClient.setWaitingForResponse(e),this.currentState===oe.CHATTING&&this.updateChatControls()}updateChatDisplay(){const e=this.element.querySelector("#chat-container");if(e){e.innerHTML=this.renderChatInterface(),this.attachChatEventListeners();const t=e.querySelector("#messages-container");t&&(t.scrollTop=t.scrollHeight)}}updateChatControls(){const e=this.element.querySelector(".tlw-chat-controls");if(e){const t=e.querySelector(".tlw-generate-container"),n=e.querySelector("#send-button"),s=e.querySelector(".tlw-thinking"),i=this.hasConversation&&!this.waitingForResponse&&"interactive"===this.messageStore.journeyType;t&&(t.style.display=i?"block":"none"),n&&(n.disabled=this.waitingForResponse,n.textContent=this.waitingForResponse?"⏳":"Send"),s&&(s.style.display=this.waitingForResponse?"block":"none")}}showInitialView(){this.showLandingPage?this.showLandingView():this.showChatView()}showLandingPageView(){this.currentState=oe.LANDING;const e=this.element.querySelector("#landing-container"),t=this.element.querySelector("#chat-container");e&&(e.style.display="block",this.landingPage.show()),t&&(t.style.display="none")}showChatInterface(){this.currentState=oe.CHATTING;const e=this.element.querySelector("#landing-container"),t=this.element.querySelector("#chat-container");e&&(e.style.display="none",this.landingPage.hide()),t&&(t.style.display="block"),this.updateChatDisplay(),setTimeout(()=>{const e=this.element.querySelector("#message-input");e&&e.focus()},100)}showTemplateModal(){this.templateModal.show()}showScenarioWizard(){this.scenarioWizard.show()}handleMilestoneClick(e){}handleError(e){const t=this.config.get("onError");t?t(e):this.messageStore.addMessage({id:`error-${Date.now()}`,type:"error",content:"An error occurred. Please try again.",messageType:"Error"})}handleMessageCallback(e){if("ai"===e.type||"system"===e.type){const t=this.config.get("onMessageReceived");t&&"function"==typeof t&&t(e)}}handleMilestoneUpdate(e){}handleDagGenerated(e){}destroy(){try{this.signalRClient&&this.signalRClient.disconnect(),this.templateModal&&this.templateModal.destroy(),this.scenarioWizard&&this.scenarioWizard.destroy(),this.element.innerHTML="",this.element.classList.remove("tradr-widget","tradr-widget--enhanced",`tradr-widget-${this.config.get("theme")}`),this.initialized=!1,this.currentState=oe.DISCONNECTED}catch(e){}}getState(){return{id:this.id,initialized:this.initialized,currentState:this.currentState,messages:this.messageStore?this.messageStore.getMessages():[],milestone:this.messageStore?this.messageStore.currentMilestone:0,journeyType:this.messageStore?this.messageStore.journeyType:null,hasConversation:this.hasConversation,waitingForResponse:this.waitingForResponse,generatedScenarios:this.generatedScenarios}}}class Re{static widgetTypes={chat:$e,"tradrlab-chat":$e};static create(e,t,n){const s=this.widgetTypes[e]||this.widgetTypes.chat;if(!s)throw new Error("WidgetFactory: No widget implementation available");return this.widgetTypes[e]||n.set("customWidgetType",e),new s(t,n)}static registerType(e,t){this.widgetTypes[e],this.widgetTypes[e]=t}static getAvailableTypes(){return Object.keys(this.widgetTypes)}}const Be={apiBaseUrl:"https://dev.api.tradrlab.com/api",signalRUrl:"https://dev.api.tradrlab.com/api/hubs/message",debug:!0};class De{constructor(e={},t={}){this.config=this.mergeConfigs(e,t),this.validateRequired()}mergeConfigs(e,t){return{...{...Be,locale:"en-US",theme:"light",width:"400px",height:"600px",placeholder:"Type your message...",showBranding:!0,fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',primaryColor:"#1976d2",allowImageUpload:!0,allowImagePaste:!0,allowReply:!0,allowFeedback:!0,showTables:!0,enableTemplates:!0,enableWizard:!0,autoConnect:!0,maxRetries:3,supportedMessageTypes:["Text","Steps","Template","Scenario","Analysis","Explanation"],onWidgetReady:null,onMessageReceived:null,onError:null,onSignalRConnected:null,onSignalRMessage:null},...e,...t}}validateRequired(){if(!this.config.apikey)throw new Error('ConfigManager: API key is REQUIRED. Call TradrLabWidget.globals({ apikey: "your-key" })');if(!this.config.externalUserId)throw new Error("ConfigManager: externalUserId is REQUIRED for widget creation");if(!this.config.apiBaseUrl)throw new Error("ConfigManager: apiBaseUrl is REQUIRED in configuration");if(!this.config.signalRUrl)throw new Error("ConfigManager: signalRUrl is REQUIRED in configuration")}get(e){return this.config[e]}set(e,t){this.config[e]=t}getAll(){return{...this.config}}}var qe=n(72),Pe=n.n(qe),Le=n(825),Ue=n.n(Le),Ne=n(659),je=n.n(Ne),Fe=n(56),We=n.n(Fe),He=n(540),ze=n.n(He),Oe=n(113),Ge=n.n(Oe),Ve=n(738),Je={};Je.styleTagTransform=Ge(),Je.setAttributes=We(),Je.insert=je().bind(null,"head"),Je.domAPI=Ue(),Je.insertStyleElement=ze();Pe()(Ve.A,Je);Ve.A&&Ve.A.locals&&Ve.A.locals;const Qe={version:"1.0.0",_globalConfig:{},_widgets:new Map,globals:function(e){return this._globalConfig={...this._globalConfig,...e},this._globalConfig.apikey,this},CreateWidget:function(e,t,n={}){if(!t)throw new Error("TradrLabWidget: Target element is required");if(!this._globalConfig.apikey)throw new Error("TradrLabWidget: API key is required. Call TradrLabWidget.globals() first.");const s=new De(this._globalConfig,n),i=Re.create(e,t,s),r=`widget-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;return i.id=r,this._widgets.set(r,i),i.init(),i},getWidget:function(e){return this._widgets.get(e)||null},destroyWidget:function(e){const t=this._widgets.get(e);t&&(t.destroy(),this._widgets.delete(e))},destroyAll:function(){this._widgets.forEach(e=>e.destroy()),this._widgets.clear()}};"undefined"!=typeof window&&(window.TradrLabWidget=Qe);const Ye=Qe;return s=s.default})());
//# sourceMappingURL=widget-core.min.js.map